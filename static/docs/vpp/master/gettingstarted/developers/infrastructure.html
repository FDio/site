

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>VPPINFRA (Infrastructure) &mdash; Vector Packet Processor 01 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/rules.css" type="text/css" />
    <link rel="author" title="About these documents" href="../../about.html" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="VLIB (Vector Processing Library)" href="vlib.html" />
    <link rel="prev" title="Software Architecture" href="softwarearchitecture.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> Vector Packet Processor
          

          
            
            <img src="../../_static/fd-io_red_white.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                master
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../overview/index.html">Overview</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Getting Started</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../installing/index.html">Downloading and Installing VPP</a></li>
<li class="toctree-l2"><a class="reference internal" href="../progressivevpp/index.html">Progressive VPP Tutorial</a></li>
<li class="toctree-l2"><a class="reference internal" href="../users/index.html">For Users</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">For Developers</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="building.html">Building VPP</a></li>
<li class="toctree-l3"><a class="reference internal" href="running_vpp.html">Running VPP</a></li>
<li class="toctree-l3"><a class="reference internal" href="gdb_examples.html">GDB Examples</a></li>
<li class="toctree-l3"><a class="reference internal" href="add_plugin.html">Adding a plugin</a></li>
<li class="toctree-l3"><a class="reference internal" href="gitreview.html">Getting a Patch Reviewed</a></li>
<li class="toctree-l3"><a class="reference internal" href="softwarearchitecture.html">Software Architecture</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">VPPINFRA (Infrastructure)</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#vectors">Vectors</a></li>
<li class="toctree-l4"><a class="reference internal" href="#bitmaps">Bitmaps</a></li>
<li class="toctree-l4"><a class="reference internal" href="#pools">Pools</a></li>
<li class="toctree-l4"><a class="reference internal" href="#hashes">Hashes</a></li>
<li class="toctree-l4"><a class="reference internal" href="#format">Format</a></li>
<li class="toctree-l4"><a class="reference internal" href="#unformat">Unformat</a></li>
<li class="toctree-l4"><a class="reference internal" href="#vppinfra-errors-and-warnings">Vppinfra errors and warnings</a></li>
<li class="toctree-l4"><a class="reference internal" href="#serialization">Serialization</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="vlib.html">VLIB (Vector Processing Library)</a></li>
<li class="toctree-l3"><a class="reference internal" href="plugins.html">Plugins</a></li>
<li class="toctree-l3"><a class="reference internal" href="vnet.html">VNET (VPP Network Stack)</a></li>
<li class="toctree-l3"><a class="reference internal" href="featurearcs.html">Feature Arcs</a></li>
<li class="toctree-l3"><a class="reference internal" href="metadata.html">Buffer Metadata</a></li>
<li class="toctree-l3"><a class="reference internal" href="metadata.html#buffer-metadata-extensions">Buffer Metadata Extensions</a></li>
<li class="toctree-l3"><a class="reference internal" href="multiarch/index.html">Multi-architecture support</a></li>
<li class="toctree-l3"><a class="reference internal" href="bihash.html">Bounded-index Extensible Hashing (bihash)</a></li>
<li class="toctree-l3"><a class="reference internal" href="vpp_api_module.html">VPP API module</a></li>
<li class="toctree-l3"><a class="reference internal" href="binary_api_support.html">Binary API Support</a></li>
<li class="toctree-l3"><a class="reference internal" href="buildsystem/index.html">Build System</a></li>
<li class="toctree-l3"><a class="reference internal" href="eventviewer.html">Event-logger</a></li>
<li class="toctree-l3"><a class="reference internal" href="eventviewer.html#g2-graphical-event-viewer">G2 graphical event viewer</a></li>
<li class="toctree-l3"><a class="reference internal" href="fib20/index.html">FIB 2.0 Hierarchical, Protocol, Independent</a></li>
<li class="toctree-l3"><a class="reference internal" href="buildwireshark.html">How to build a vpp dispatch trace aware Wireshark</a></li>
<li class="toctree-l3"><a class="reference internal" href="punt.html">Punting Packets</a></li>
<li class="toctree-l3"><a class="reference internal" href="quic_plugin.html">QUIC HostStack</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../writingdocs/index.html">Writing Documents</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../links/index.html">VPP Wiki, Doxygen and Other Links</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usecases/index.html">Use Cases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../featuresbyrelease/index.html">Features by Release</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../troubleshooting/index.html">Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../events/index.html">Events</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../reference/index.html">Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../relatedprojects/index.html">Related Projects</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../archive/index.html">Archive</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../about.html">About</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Vector Packet Processor</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Getting Started</a> &raquo;</li>
        
          <li><a href="index.html">For Developers</a> &raquo;</li>
        
      <li>VPPINFRA (Infrastructure)</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/gettingstarted/developers/infrastructure.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="vppinfra-infrastructure">
<h1>VPPINFRA (Infrastructure)<a class="headerlink" href="#vppinfra-infrastructure" title="Permalink to this headline">¶</a></h1>
<p>The files associated with the VPP Infrastructure layer are located in
the ./src/vppinfra folder.</p>
<p>VPPinfra is a collection of basic c-library services, quite
sufficient to build standalone programs to run directly on bare metal.
It also provides high-performance dynamic arrays, hashes, bitmaps,
high-precision real-time clock support, fine-grained event-logging, and
data structure serialization.</p>
<p>One fair comment / fair warning about vppinfra: you can’t always tell a
macro from an inline function from an ordinary function simply by name.
Macros are used to avoid function calls in the typical case, and to
cause (intentional) side-effects.</p>
<p>Vppinfra has been around for almost 20 years and tends not to change
frequently. The VPP Infrastructure layer contains the following
functions:</p>
<div class="section" id="vectors">
<h2>Vectors<a class="headerlink" href="#vectors" title="Permalink to this headline">¶</a></h2>
<p>Vppinfra vectors are ubiquitous dynamically resized arrays with by user
defined “headers”. Many vpppinfra data structures (e.g. hash, heap,
pool) are vectors with various different headers.</p>
<p>The memory layout looks like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>                   <span class="n">User</span> <span class="n">header</span> <span class="p">(</span><span class="n">optional</span><span class="p">,</span> <span class="n">uword</span> <span class="n">aligned</span><span class="p">)</span>
                   <span class="n">Alignment</span> <span class="n">padding</span> <span class="p">(</span><span class="k">if</span> <span class="n">needed</span><span class="p">)</span>
                   <span class="n">Vector</span> <span class="n">length</span> <span class="ow">in</span> <span class="n">elements</span>
 <span class="n">User</span><span class="s1">&#39;s pointer -&gt; Vector element 0</span>
                   <span class="n">Vector</span> <span class="n">element</span> <span class="mi">1</span>
                   <span class="o">...</span>
                   <span class="n">Vector</span> <span class="n">element</span> <span class="n">N</span><span class="o">-</span><span class="mi">1</span>
</pre></div>
</div>
<p>As shown above, the vector APIs deal with pointers to the 0th element of
a vector. Null pointers are valid vectors of length zero.</p>
<p>To avoid thrashing the memory allocator, one often resets the length of
a vector to zero while retaining the memory allocation. Set the vector
length field to zero via the vec_reset_length(v) macro. [Use the
macro! It’s smart about NULL pointers.]</p>
<p>Typically, the user header is not present. User headers allow for other
data structures to be built atop vppinfra vectors. Users may specify the
alignment for first data element of a vector via the [vec]()*_aligned
macros.</p>
<p>Vector elements can be any C type e.g. (int, double, struct bar). This
is also true for data types built atop vectors (e.g. heap, pool, etc.).
Many macros have _a variants supporting alignment of vector elements
and _h variants supporting non-zero-length vector headers. The _ha
variants support both.  Additionally cacheline alignment within a
vector element structure can be specified using the
[CLIB_CACHE_LINE_ALIGN_MARK]() macro.</p>
<p>Inconsistent usage of header and/or alignment related macro variants
will cause delayed, confusing failures.</p>
<p>Standard programming error: memorize a pointer to the ith element of a
vector, and then expand the vector. Vectors expand by 3/2, so such code
may appear to work for a period of time. Correct code almost always
memorizes vector <strong>indices</strong> which are invariant across reallocations.</p>
<p>In typical application images, one supplies a set of global functions
designed to be called from gdb. Here are a few examples:</p>
<ul class="simple">
<li><p>vl(v) - prints vec_len(v)</p></li>
<li><p>pe(p) - prints pool_elts(p)</p></li>
<li><p>pifi(p, index) - prints pool_is_free_index(p, index)</p></li>
<li><p>debug_hex_bytes (p, nbytes) - hex memory dump nbytes starting at p</p></li>
</ul>
<p>Use the “show gdb” debug CLI command to print the current set.</p>
</div>
<div class="section" id="bitmaps">
<h2>Bitmaps<a class="headerlink" href="#bitmaps" title="Permalink to this headline">¶</a></h2>
<p>Vppinfra bitmaps are dynamic, built using the vppinfra vector APIs.
Quite handy for a variety jobs.</p>
</div>
<div class="section" id="pools">
<h2>Pools<a class="headerlink" href="#pools" title="Permalink to this headline">¶</a></h2>
<p>Vppinfra pools combine vectors and bitmaps to rapidly allocate and free
fixed-size data structures with independent lifetimes. Pools are perfect
for allocating per-session structures.</p>
</div>
<div class="section" id="hashes">
<h2>Hashes<a class="headerlink" href="#hashes" title="Permalink to this headline">¶</a></h2>
<p>Vppinfra provides several hash flavors. Data plane problems involving
packet classification / session lookup often use
./src/vppinfra/bihash_template.[ch] bounded-index extensible
hashes. These templates are instantiated multiple times, to efficiently
service different fixed-key sizes.</p>
<p>Bihashes are thread-safe. Read-locking is not required. A simple
spin-lock ensures that only one thread writes an entry at a time.</p>
<p>The original vppinfra hash implementation in
./src/vppinfra/hash.[ch] are simple to use, and are often used in
control-plane code which needs exact-string-matching.</p>
<p>In either case, one almost always looks up a key in a hash table to
obtain an index in a related vector or pool. The APIs are simple enough,
but one must take care when using the unmanaged arbitrary-sized key
variant. Hash_set_mem (hash_table, key_pointer, value) memorizes
key_pointer. It is usually a bad mistake to pass the address of a
vector element as the second argument to hash_set_mem. It is perfectly
fine to memorize constant string addresses in the text segment.</p>
</div>
<div class="section" id="format">
<h2>Format<a class="headerlink" href="#format" title="Permalink to this headline">¶</a></h2>
<p>Vppinfra format is roughly equivalent to printf.</p>
<p>Format has a few properties worth mentioning. Format’s first argument is
a (u8 *) vector to which it appends the result of the current format
operation. Chaining calls is very easy:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span>    <span class="n">u8</span> <span class="o">*</span> <span class="n">result</span><span class="p">;</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">format</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;junk = %d, &quot;</span><span class="p">,</span> <span class="n">junk</span><span class="p">);</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">format</span> <span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="s">&quot;more junk = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">more_junk</span><span class="p">);</span>
</pre></div>
</div>
<p>As previously noted, NULL pointers are perfectly proper 0-length
vectors. Format returns a (u8 *) vector, <strong>not</strong> a C-string. If you
wish to print a (u8 *) vector, use the “%v” format string. If you need
a (u8 *) vector which is also a proper C-string, either of these
schemes may be used:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span>    <span class="n">vec_add1</span> <span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">or</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">format</span> <span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="s">&quot;&lt;whatever&gt;%c&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</pre></div>
</div>
<p>Remember to vec_free() the result if appropriate. Be careful not to
pass format an uninitialized (u8 *).</p>
<p>Format implements a particularly handy user-format scheme via the “%U”
format specification. For example:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span>    <span class="n">u8</span> <span class="o">*</span> <span class="nf">format_junk</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span> <span class="n">s</span><span class="p">,</span> <span class="kt">va_list</span> <span class="o">*</span><span class="n">va</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">junk</span> <span class="o">=</span> <span class="n">va_arg</span> <span class="p">(</span><span class="n">va</span><span class="p">,</span> <span class="n">u32</span><span class="p">);</span>
      <span class="n">s</span> <span class="o">=</span> <span class="n">format</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">junk</span><span class="p">);</span>
      <span class="k">return</span> <span class="n">s</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">format</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;junk = %U, format_junk, &quot;</span><span class="n">This</span> <span class="n">is</span> <span class="n">some</span> <span class="n">junk</span><span class="s">&quot;);</span>
</pre></div>
</div>
<p>format_junk() can invoke other user-format functions if desired. The
programmer shoulders responsibility for argument type-checking. It is
typical for user format functions to blow up spectaculary if the
va_arg(va, type) macros don’t match the caller’s idea of reality.</p>
</div>
<div class="section" id="unformat">
<h2>Unformat<a class="headerlink" href="#unformat" title="Permalink to this headline">¶</a></h2>
<p>Vppinfra unformat is vaguely related to scanf, but considerably more
general.</p>
<p>A typical use case involves initializing an unformat_input_t from
either a C-string or a (u8 *) vector, then parsing via unformat() as
follows:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span>    <span class="n">unformat_input_t</span> <span class="n">input</span><span class="p">;</span>

    <span class="n">unformat_init_string</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">input</span><span class="p">,</span> <span class="s">&quot;&lt;some-C-string&gt;&quot;</span><span class="p">);</span>
    <span class="cm">/* or */</span>
    <span class="n">unformat_init_vector</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">input</span><span class="p">,</span> <span class="o">&lt;</span><span class="n">u8</span><span class="o">-</span><span class="n">vector</span><span class="o">&gt;</span><span class="p">);</span>
</pre></div>
</div>
<p>Then loop parsing individual elements:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span>    <span class="k">while</span> <span class="p">(</span><span class="n">unformat_check_input</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">input</span><span class="p">)</span> <span class="o">!=</span> <span class="n">UNFORMAT_END_OF_INPUT</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">unformat</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">input</span><span class="p">,</span> <span class="s">&quot;value1 %d&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value1</span><span class="p">))</span>
        <span class="p">;</span><span class="cm">/* unformat sets value1 */</span>
      <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">unformat</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">input</span><span class="p">,</span> <span class="s">&quot;value2 %d&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value2</span><span class="p">)</span>
        <span class="p">;</span><span class="cm">/* unformat sets value2 */</span>
      <span class="k">else</span>
        <span class="k">return</span> <span class="nf">clib_error_return</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;unknown input &#39;%U&#39;&quot;</span><span class="p">,</span>
                                  <span class="n">format_unformat_error</span><span class="p">,</span> <span class="n">input</span><span class="p">);</span>
    <span class="p">}</span>
</pre></div>
</div>
<p>As with format, unformat implements a user-unformat function capability
via a “%U” user unformat function scheme. Generally, one can trivially
transform “format (s, “foo %d”, foo) -&gt; “unformat (input, “foo %d”, &amp;foo)”.</p>
<p>Unformat implements a couple of handy non-scanf-like format specifiers:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span>    <span class="n">unformat</span> <span class="p">(</span><span class="n">input</span><span class="p">,</span> <span class="s">&quot;enable %=&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">enable</span><span class="p">,</span> <span class="mi">1</span> <span class="cm">/* defaults to 1 */</span><span class="p">);</span>
    <span class="n">unformat</span> <span class="p">(</span><span class="n">input</span><span class="p">,</span> <span class="s">&quot;bitzero %|&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mask</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">0</span><span class="p">));</span>
    <span class="n">unformat</span> <span class="p">(</span><span class="n">input</span><span class="p">,</span> <span class="s">&quot;bitone %|&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mask</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">1</span><span class="p">));</span>
    <span class="o">&lt;</span><span class="n">etc</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>The phrase “enable %=” means “set the supplied variable to the default
value” if unformat parses the “enable” keyword all by itself. If
unformat parses “enable 123” set the supplied variable to 123.</p>
<p>We could clean up a number of hand-rolled “verbose” + “verbose %d”
argument parsing codes using “%=”.</p>
<p>The phrase “bitzero %|” means “set the specified bit in the supplied
bitmask” if unformat parses “bitzero”. Although it looks like it could
be fairly handy, it’s very lightly used in the code base.</p>
<div class="section" id="how-to-parse-a-single-input-line">
<h3>How to parse a single input line<a class="headerlink" href="#how-to-parse-a-single-input-line" title="Permalink to this headline">¶</a></h3>
<p>Debug CLI command functions MUST NOT accidentally consume input
belonging to other debug CLI commands. Otherwise, it’s impossible to
script a set of debug CLI commands which “work fine” when issued one
at a time.</p>
<p>This bit of code is NOT correct:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span>  <span class="cm">/* Eats script input NOT beloging to it, and chokes! */</span>
  <span class="k">while</span> <span class="p">(</span><span class="n">unformat_check_input</span> <span class="p">(</span><span class="n">input</span><span class="p">)</span> <span class="o">!=</span> <span class="n">UNFORMAT_END_OF_INPUT</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">unformat</span> <span class="p">(</span><span class="n">input</span><span class="p">,</span> <span class="p">...))</span>
	<span class="p">;</span>
      <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">unformat</span> <span class="p">(</span><span class="n">input</span><span class="p">,</span> <span class="p">...))</span>
	<span class="p">;</span>
      <span class="k">else</span>
        <span class="k">return</span> <span class="nf">clib_error_return</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;parse error: &#39;%U&#39;&quot;</span><span class="p">,</span>
              			     <span class="n">format_unformat_error</span><span class="p">,</span> <span class="n">input</span><span class="p">);</span>
	<span class="p">}</span>
    <span class="p">}</span>
</pre></div>
</div>
<p>When executed as part of a script, such a function will return “parse
error: ‘<next-command-text>’” every time, unless it happens to be the
last command in the script.</p>
<p>Instead, use “unformat_line_input” to consume the rest of a line’s
worth of input - everything past the path specified in the
VLIB_CLI_COMMAND declaration.</p>
<p>For example, unformat_line_input with “my_command” set up as shown
below and user input “my path is clear” will produce an
unformat_input_t that contains “is clear”.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span>    <span class="n">VLIB_CLI_COMMAND</span> <span class="p">(...)</span> <span class="o">=</span> <span class="p">{</span>
        <span class="p">.</span><span class="n">path</span> <span class="o">=</span> <span class="s">&quot;my path&quot;</span><span class="p">,</span>
    <span class="p">};</span>
</pre></div>
</div>
<p>Here’s a bit of code which shows the required mechanics, in full:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span>    <span class="k">static</span> <span class="n">clib_error_t</span> <span class="o">*</span>
    <span class="nf">my_command_fn</span> <span class="p">(</span><span class="n">vlib_main_t</span> <span class="o">*</span> <span class="n">vm</span><span class="p">,</span>
                   <span class="n">unformat_input_t</span> <span class="o">*</span> <span class="n">input</span><span class="p">,</span>
                   <span class="n">vlib_cli_command_t</span> <span class="o">*</span> <span class="n">cmd</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">unformat_input_t</span> <span class="n">_line_input</span><span class="p">,</span> <span class="o">*</span><span class="n">line_input</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">_line_input</span><span class="p">;</span>
      <span class="n">u32</span> <span class="n">this</span><span class="p">,</span> <span class="n">that</span><span class="p">;</span>
      <span class="n">clib_error_t</span> <span class="o">*</span><span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">unformat_user</span> <span class="p">(</span><span class="n">input</span><span class="p">,</span> <span class="n">unformat_line_input</span><span class="p">,</span> <span class="n">line_input</span><span class="p">))</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

      <span class="cm">/*</span>
<span class="cm">       * Here, UNFORMAT_END_OF_INPUT is at the end of the line we consumed,</span>
<span class="cm">       * not at the end of the script...</span>
<span class="cm">       */</span>
      <span class="k">while</span> <span class="p">(</span><span class="n">unformat_check_input</span> <span class="p">(</span><span class="n">line_input</span><span class="p">)</span> <span class="o">!=</span> <span class="n">UNFORMAT_END_OF_INPUT</span><span class="p">)</span>
        <span class="p">{</span>
           <span class="k">if</span> <span class="p">(</span><span class="n">unformat</span> <span class="p">(</span><span class="n">line_input</span><span class="p">,</span> <span class="s">&quot;this %u&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">this</span><span class="p">))</span>
             <span class="p">;</span>
           <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">unformat</span> <span class="p">(</span><span class="n">line_input</span><span class="p">,</span> <span class="s">&quot;that %u&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">that</span><span class="p">))</span>
             <span class="p">;</span>
           <span class="k">else</span>
             <span class="p">{</span>
               <span class="n">error</span> <span class="o">=</span> <span class="n">clib_error_return</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;parse error: &#39;%U&#39;&quot;</span><span class="p">,</span>
              	     		     <span class="n">format_unformat_error</span><span class="p">,</span> <span class="n">line_input</span><span class="p">);</span>
               <span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
             <span class="p">}</span>
          <span class="p">}</span>

    <span class="o">&lt;</span><span class="k">do</span> <span class="n">something</span> <span class="n">based</span> <span class="n">on</span> <span class="s">&quot;this&quot;</span> <span class="n">and</span> <span class="s">&quot;that&quot;</span><span class="p">,</span> <span class="n">etc</span><span class="o">&gt;</span>

    <span class="nl">done</span><span class="p">:</span>
      <span class="n">unformat_free</span> <span class="p">(</span><span class="n">line_input</span><span class="p">);</span>
      <span class="k">return</span> <span class="n">error</span><span class="p">;</span>
    <span class="p">}</span>
   <span class="cm">/* *INDENT-OFF* */</span>
   <span class="n">VLIB_CLI_COMMAND</span> <span class="p">(</span><span class="n">my_command</span><span class="p">,</span> <span class="k">static</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
     <span class="p">.</span><span class="n">path</span> <span class="o">=</span> <span class="s">&quot;my path&quot;</span><span class="p">,</span>
     <span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">my_command_fn</span><span class="s">&quot;,</span>
   <span class="p">};</span>
   <span class="cm">/* *INDENT-ON* */</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="vppinfra-errors-and-warnings">
<h2>Vppinfra errors and warnings<a class="headerlink" href="#vppinfra-errors-and-warnings" title="Permalink to this headline">¶</a></h2>
<p>Many functions within the vpp dataplane have return-values of type
clib_error_t *. Clib_error_t’s are arbitrary strings with a bit of
metadata [fatal, warning] and are easy to announce. Returning a NULL
clib_error_t * indicates “A-OK, no error.”</p>
<p>Clib_warning(format-args) is a handy way to add debugging
output; clib warnings prepend function:line info to unambiguously locate
the message source. Clib_unix_warning() adds perror()-style Linux
system-call information. In production images, clib_warnings result in
syslog entries.</p>
</div>
<div class="section" id="serialization">
<h2>Serialization<a class="headerlink" href="#serialization" title="Permalink to this headline">¶</a></h2>
<p>Vppinfra serialization support allows the programmer to easily serialize
and unserialize complex data structures.</p>
<p>The underlying primitive serialize/unserialize functions use network
byte-order, so there are no structural issues serializing on a
little-endian host and unserializing on a big-endian host.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="vlib.html" class="btn btn-neutral float-right" title="VLIB (Vector Processing Library)" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="softwarearchitecture.html" class="btn btn-neutral float-left" title="Software Architecture" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, Linux Foundation

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>