

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>IP Security &mdash; The Vector Packet Processor master documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/rules.css" type="text/css" />
    <link rel="author" title="About these documents" href="../../about.html" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> The Vector Packet Processor
          

          
            
            <img src="../../_static/fd-io_red_white.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                master
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../whatisvpp/index.html">The Vector Packet Processor (VPP)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../index.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../links/index.html">VPP Wiki, Doxygen and Other Links</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usecases/index.html">Use Cases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../troubleshooting/index.html">Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../reference/index.html">Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../relatedprojects/index.html">Related FD.IO Projects</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../about.html">About</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">The Vector Packet Processor</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
      <li>IP Security</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/gettingstarted/developers/ipsec.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="toctree-wrapper compound" id="ipsec">
</div>
<div class="section" id="ip-security">
<h1>IP Security<a class="headerlink" href="#ip-security" title="Permalink to this headline">¶</a></h1>
<p>This is not a description on how IPSec works. Please read:</p>
<blockquote>
<div><ul class="simple">
<li><p><a class="reference external" href="https://tools.ietf.org/html/rfc4301">https://tools.ietf.org/html/rfc4301</a></p></li>
<li><p><a class="reference external" href="https://tools.ietf.org/html/rfc4302">https://tools.ietf.org/html/rfc4302</a></p></li>
<li><p><a class="reference external" href="https://tools.ietf.org/html/rfc4303">https://tools.ietf.org/html/rfc4303</a></p></li>
</ul>
</div></blockquote>
<p>I would also suggest this:</p>
<blockquote>
<div><ul class="simple">
<li><p><a class="reference external" href="https://wiki.strongswan.org/projects/strongswan/wiki/RouteBasedVPN">https://wiki.strongswan.org/projects/strongswan/wiki/RouteBasedVPN</a></p></li>
</ul>
</div></blockquote>
<p>If you’re interested in cryptography, I would recommend this excellent
introductory lecture series (there is also a book, but you’ll have to
buy it, IMHO it’s worth it):</p>
<blockquote>
<div><ul class="simple">
<li><p><a class="reference external" href="https://www.youtube.com/channel/UC1usFRN4LCMcfIV7UjHNuQg/featured">https://www.youtube.com/channel/UC1usFRN4LCMcfIV7UjHNuQg/featured</a></p></li>
</ul>
</div></blockquote>
<p>IPSec VPNs come in two flavours; policy and route based, the
difference is how the Security Association (SA) is chosen.</p>
<div class="section" id="route-base-vpns">
<h2>Route Base VPNs<a class="headerlink" href="#route-base-vpns" title="Permalink to this headline">¶</a></h2>
<p>There are two aspects of a route based VPN; all packets to a
particular peer are encrypted by the same SA and routing
decides the peer to which to forward traffic (as routing always
does). Therefore, routing is choosing the SA. Of course the same must
be true in reverse, that all packets from a given peer are decrypted
with the same SA. Another way of expressing this is to say a peer is
‘protected’ by this SA (really a pair of SAs; one for rx and tx).</p>
<p>The ‘standard’ <a class="footnote-reference brackets" href="#i1" id="id1">1</a> way of representing this protected peer is by
using a point-to-point virtual interface to which the peer is
attached and the SA pair is associated. Prefixes
that require protection are routed through this virtual interface and
hence implicitly to the peer.</p>
<p>There are three components to the model:</p>
<ul class="simple">
<li><p>The SAs; An <strong>ipsec_sa_t</strong>, use the force, read the source.</p></li>
<li><p>The virtual interface</p></li>
<li><p>The protection - the association of the SAs to the interface.</p></li>
</ul>
<p>The protection is represented by a <strong>ipsec_tun_protect_t</strong>. The “tun”
part comes from the fact that the protected interface is usually a
tunnel. IMO It would have been better if the author had not assumed
this <a class="footnote-reference brackets" href="#i2" id="id2">2</a>.
The protection associates a single TX SA and up to four RX SAs to an
interface. Four is as many as can fit on one cache-line. Multiple RX
SAs mean that a peer can be using any SA in the set, this is
particularly useful during rekeying because it is not possible for the
peers to swap their RX and TX SAs at exactly the same moment in the
traffic stream. Instead they can add the new RX immediately, then swap
the TX after a short delay, then remove the old RX after another short
delay. This will minimize, if not eliminate, packet loss.</p>
<p>The virtual interface can be represented in two ways:</p>
<blockquote>
<div><ul class="simple">
<li><p>interface + encap + SA = (interface + encap) + SA = ipip-interface + SA transport mode</p></li>
</ul>
</div></blockquote>
<p>or</p>
<blockquote>
<div><ul class="simple">
<li><p>interface + encap + SA = interface + (encap + SA) = IPSec-interface + SA tunnel mode</p></li>
</ul>
</div></blockquote>
<p>It’s a question of where you add the parenthesis, from the perspective
of the external user the effect is identical.</p>
<p>The IPSec interface serves as the encap-free interface to be used in
conjunction with an encap-describing tunnel mode SA. VPP supports both models.</p>
<p>A route based VPN could impose 0, 1 or 2 encaps. the support matrix for  these use cases is:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">      |  0  |  1  |  2  |</span>
<span class="go">--------------------------</span>
<span class="go">ipip  |  N  |  Y  |  Y  |</span>
<span class="go">ipsec |  P  |  Y  |  P  |</span>
</pre></div>
</div>
<p>Where P = potentially.</p>
<p>Ipsec could potentially support 0 encap (i.e. transport mode) since
neither the interface nor the SA <em>requires</em> encap. However, for a
route based VPN to use transport mode is probably wrong since one
shouldn’t use transport mode for transit traffic, since without encap
it is not guaranteed to return. IPSec could potentially support 2
encaps, but that would require the SA to describe both, something it
does not do at this time.</p>
<p>Internally the difference is that the mid-chain adjacency for the IPSec
interface has no associated encap (whereas for an ipip tunnel it
describes the peer). Consequently, features on the output arc see
packets without any encap. Since the protecting SAs are in tunnel
mode, they apply the encap. The mid-chain adj is stacked only once the
protecting SA is known, since only then is the peer known. Otherwise
the VLIB graph nodes used are the same:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp gp-VirtualEnv">(routing)</span> <span class="go">--&gt; ipX-michain --&gt; espX-encrypt --&gt; adj-midchain-tx --&gt; (routing)</span>

<span class="go"> where X = 4 or 6.</span>
</pre></div>
</div>
<p>Some benefits to the ipsec interface:</p>
<ul class="simple">
<li><p>it is slightly more efficient since the encapsulating IP header has its checksum updated only once.</p></li>
<li><p>even when the interface is admin up traffic cannot be sent to a peer
unless the SA is available (since it’s the SA that determines the
encap). With ipip interfaces a client must use the admin state to
prevent sending until the SA is available.</p></li>
</ul>
<p>The best recommendations I can make are:</p>
<ul class="simple">
<li><p>pick a model that supports your use case</p></li>
<li><p>make sure any other features you wish to use are supported by the model</p></li>
<li><p>choose the model that best fits your control plane’s model.</p></li>
</ul>
<div class="section" id="multi-point-interfaces">
<h3>Multi-point Interfaces<a class="headerlink" href="#multi-point-interfaces" title="Permalink to this headline">¶</a></h3>
<p>As mentioned above route based VPNs protect all packets destined to
a given peer with the same SA pair. This protection was modelled using
a virtual p2p interface, so one could legitimately reason that
all traffic through the interface is protected with the SA pair or all
traffic to the peer is protected, since they are one in the
same. However, when we consider multi-point interfaces, we have to
think of protection applying to the peers on the link.</p>
<p>When using IPSec protection on a P2MP link the <strong>ipsec_tun_protect_t</strong>
will be specific to a particular peer (in the P2P case this peer is
the usual special all zero address).</p>
<p>All other aspects of using route based VPNs remains the same. The
routes are resolved via specific peers on the interface, i.e.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">ip route add 10.0.0.0/8 via 192.168.1.1 mipip0</span>
</pre></div>
</div>
<p>rather than</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">ip route add 10.0.0.0/8 via ipip0</span>
</pre></div>
</div>
<p>but one should always use a next-hop on a multi-access interface, so
this is not a restriction.</p>
<p>The data-path is unchanged, in both P2P and P2MP case the SA to
use for TX comes from the adjacency, and for RX it’s the SPI that
matches to the SA and interface.</p>
</div>
</div>
<div class="section" id="policy-based-vpns">
<h2>Policy Based VPNs<a class="headerlink" href="#policy-based-vpns" title="Permalink to this headline">¶</a></h2>
<p>At the risk of stating the obvious, in a policy based VPN the SA is
chosen based on a specific IPSec policy. A policy describes what
attributes of the packets to match and what action to take if
matched. Actions are:</p>
<ul class="simple">
<li><p>bypass: Ignore it</p></li>
<li><p>discard: Drop it</p></li>
<li><p>protect: Either encrypt or decrypt with a specific SA</p></li>
</ul>
<p>The ‘resolve’ action which (as per-RFC4301) states that an IKE session
should be initiated, is not supported.</p>
<p>Policies are stored in a security policy database (SPD). An SPD is
attached to an interface. Packets that ingress and egress the
interface are matched against the policies in the attached SPD.
This is IPSec as described in RFC4301.</p>
<p class="rubric">Footnotes:</p>
<dl class="footnote brackets">
<dt class="label" id="i1"><span class="brackets"><a class="fn-backref" href="#id1">1</a></span></dt>
<dd><p>Standard in inverted commas because, at least to my
knowledge, there is no official standard (RFC) that states it
should be this way. It is probably this way because routers
model/implement/restrict/etc IPSec as an interface
input/output feature.</p>
</dd>
<dt class="label" id="i2"><span class="brackets"><a class="fn-backref" href="#id2">2</a></span></dt>
<dd><p>That’s a self criticism.</p>
</dd>
</dl>
</div>
</div>


           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018-2021, Linux Foundation

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>