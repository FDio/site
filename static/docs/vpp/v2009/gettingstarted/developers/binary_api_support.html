

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Binary API Support &mdash; The Vector Packet Processor 20.09 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/rules.css" type="text/css" />
    <link rel="author" title="About these documents" href="../../about.html" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Build System" href="buildsystem/index.html" />
    <link rel="prev" title="VPP API module" href="vpp_api_module.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> The Vector Packet Processor
          

          
            
            <img src="../../_static/fd-io_red_white.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                20.09
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../whatisvpp/index.html">The Vector Packet Processor (VPP)</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Getting Started</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../installing/index.html">Downloading and Installing VPP</a></li>
<li class="toctree-l2"><a class="reference internal" href="../progressivevpp/index.html">Progressive VPP Tutorial</a></li>
<li class="toctree-l2"><a class="reference internal" href="../users/index.html">For Users</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">For Developers</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="building.html">Building VPP</a></li>
<li class="toctree-l3"><a class="reference internal" href="running_vpp.html">Running VPP</a></li>
<li class="toctree-l3"><a class="reference internal" href="gdb_examples.html">GDB Examples</a></li>
<li class="toctree-l3"><a class="reference internal" href="add_plugin.html">Adding a plugin</a></li>
<li class="toctree-l3"><a class="reference internal" href="add_plugin_goapi.html">Add a plugin’s GO API</a></li>
<li class="toctree-l3"><a class="reference internal" href="gitreview.html">Getting a Patch Reviewed</a></li>
<li class="toctree-l3"><a class="reference internal" href="softwarearchitecture.html">Software Architecture</a></li>
<li class="toctree-l3"><a class="reference internal" href="infrastructure.html">VPPINFRA (Infrastructure)</a></li>
<li class="toctree-l3"><a class="reference internal" href="vlib.html">VLIB (Vector Processing Library)</a></li>
<li class="toctree-l3"><a class="reference internal" href="vlib.html#packet-generator-input-script">Packet generator input script</a></li>
<li class="toctree-l3"><a class="reference internal" href="vlib.html#start-vpp-with-2-worker-threads">Start vpp with 2 worker threads</a></li>
<li class="toctree-l3"><a class="reference internal" href="vlib.html#enable-tracing-and-start-the-packet-generator">Enable tracing, and start the packet generator</a></li>
<li class="toctree-l3"><a class="reference internal" href="vlib.html#sample-run">Sample Run</a></li>
<li class="toctree-l3"><a class="reference internal" href="plugins.html">Plugins</a></li>
<li class="toctree-l3"><a class="reference internal" href="vnet.html">VNET (VPP Network Stack)</a></li>
<li class="toctree-l3"><a class="reference internal" href="featurearcs.html">Feature Arcs</a></li>
<li class="toctree-l3"><a class="reference internal" href="metadata.html">Buffer Metadata</a></li>
<li class="toctree-l3"><a class="reference internal" href="metadata.html#buffer-metadata-extensions">Buffer Metadata Extensions</a></li>
<li class="toctree-l3"><a class="reference internal" href="multiarch/index.html">Multi-architecture support</a></li>
<li class="toctree-l3"><a class="reference internal" href="bihash.html">Bounded-index Extensible Hashing (bihash)</a></li>
<li class="toctree-l3"><a class="reference internal" href="vpp_api_module.html">VPP API module</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Binary API Support</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#message-allocation">Message Allocation</a></li>
<li class="toctree-l4"><a class="reference internal" href="#message-tracing-and-replay">Message Tracing and Replay</a></li>
<li class="toctree-l4"><a class="reference internal" href="#api-trace-replay-caveats">API trace replay caveats</a></li>
<li class="toctree-l4"><a class="reference internal" href="#api-trace-interface-issues">API trace interface issues</a></li>
<li class="toctree-l4"><a class="reference internal" href="#client-connection-details">Client connection details</a></li>
<li class="toctree-l4"><a class="reference internal" href="#client-disconnection-details">Client disconnection details</a></li>
<li class="toctree-l4"><a class="reference internal" href="#sending-binary-api-messages-to-vpp">Sending binary API messages to VPP</a></li>
<li class="toctree-l4"><a class="reference internal" href="#receiving-binary-api-messages-from-vpp">Receiving binary API messages from VPP</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="buildsystem/index.html">Build System</a></li>
<li class="toctree-l3"><a class="reference internal" href="eventviewer.html">Event-logger</a></li>
<li class="toctree-l3"><a class="reference internal" href="eventviewer.html#g2-graphical-event-viewer">G2 graphical event viewer</a></li>
<li class="toctree-l3"><a class="reference internal" href="fib20/index.html">FIB 2.0 Hierarchical, Protocol, Independent</a></li>
<li class="toctree-l3"><a class="reference internal" href="buildwireshark.html">How to build a vpp dispatch trace aware Wireshark</a></li>
<li class="toctree-l3"><a class="reference internal" href="punt.html">Punting Packets</a></li>
<li class="toctree-l3"><a class="reference internal" href="quic_plugin.html">QUIC HostStack</a></li>
<li class="toctree-l3"><a class="reference internal" href="cross_compile_macos.html">Cross compilation on MacOS</a></li>
<li class="toctree-l3"><a class="reference internal" href="cnat.html">Cloud NAT</a></li>
<li class="toctree-l3"><a class="reference internal" href="VPPAPI.html">VPP API Language    {#api_lang_doc}</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../writingdocs/index.html">Writing Documents</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../links/index.html">VPP Wiki, Doxygen and Other Links</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usecases/index.html">Use Cases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../featuresbyrelease/index.html">Features by Release</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../troubleshooting/index.html">Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../events/index.html">Events</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../reference/index.html">Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../relatedprojects/index.html">Related Projects</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../archive/index.html">Archive</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../about.html">About</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">The Vector Packet Processor</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Getting Started</a> &raquo;</li>
        
          <li><a href="index.html">For Developers</a> &raquo;</li>
        
      <li>Binary API Support</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/gettingstarted/developers/binary_api_support.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="toctree-wrapper compound" id="binary-api-support">
</div>
<div class="section" id="id1">
<h1>Binary API Support<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h1>
<p>VPP provides a binary API scheme to allow a wide variety of client
codes to program data-plane tables. As of this writing, there are
hundreds of binary APIs.</p>
<p>Messages are defined in *.api files. Today, there are about 80 api
files, with more arriving as folks add programmable features. The API
file compiler sources reside in src/tools/vppapigen.</p>
<p>From <a class="reference external" href="https://docs.fd.io/vpp/18.11/de/d75/interface_8api.html">src/vnet/interface.api</a>, here’s a
typical request/response message definition:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">autoreply define sw_interface_set_flags</span>
<span class="go">{</span>
<span class="go">  u32 client_index;</span>
<span class="go">  u32 context;</span>
<span class="go">  u32 sw_if_index;</span>
<span class="go">  /* 1 = up, 0 = down */</span>
<span class="go">  u8 admin_up_down;</span>
<span class="go">};</span>
</pre></div>
</div>
<p>To a first approximation, the API compiler renders this definition
into
<em>vpp/build-root/install-vpp_debug-native/vpp/include/vnet/interface.api.h</em>
as follows:</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="cm">/****** Message ID / handler enum ******/</span>

<span class="cp">#ifdef vl_msg_id</span>
<span class="n">vl_msg_id</span><span class="p">(</span><span class="n">VL_API_SW_INTERFACE_SET_FLAGS</span><span class="p">,</span> <span class="n">vl_api_sw_interface_set_flags_t_handler</span><span class="p">)</span>
<span class="n">vl_msg_id</span><span class="p">(</span><span class="n">VL_API_SW_INTERFACE_SET_FLAGS_REPLY</span><span class="p">,</span> <span class="n">vl_api_sw_interface_set_flags_reply_t_handler</span><span class="p">)</span>
<span class="cp">#endif</span>
<span class="cm">/****** Message names ******/</span>

<span class="cp">#ifdef vl_msg_name</span>
<span class="n">vl_msg_name</span><span class="p">(</span><span class="n">vl_api_sw_interface_set_flags_t</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">vl_msg_name</span><span class="p">(</span><span class="n">vl_api_sw_interface_set_flags_reply_t</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="cp">#endif</span>
<span class="cm">/****** Message name, crc list ******/</span>

<span class="cp">#ifdef vl_msg_name_crc_list</span>
<span class="cp">#define foreach_vl_msg_name_crc_interface \</span>
<span class="cp">_(VL_API_SW_INTERFACE_SET_FLAGS, sw_interface_set_flags, f890584a) \</span>
<span class="cp">_(VL_API_SW_INTERFACE_SET_FLAGS_REPLY, sw_interface_set_flags_reply, dfbf3afa) \</span>
<span class="cp">#endif</span>
<span class="cm">/****** Typedefs *****/</span>

<span class="cp">#ifdef vl_typedefs</span>
<span class="cp">#ifndef defined_sw_interface_set_flags</span>
<span class="cp">#define defined_sw_interface_set_flags</span>
<span class="k">typedef</span> <span class="n">VL_API_PACKED</span><span class="p">(</span><span class="k">struct</span> <span class="n">_vl_api_sw_interface_set_flags</span> <span class="p">{</span>
    <span class="n">u16</span> <span class="n">_vl_msg_id</span><span class="p">;</span>
    <span class="n">u32</span> <span class="n">client_index</span><span class="p">;</span>
    <span class="n">u32</span> <span class="n">context</span><span class="p">;</span>
    <span class="n">u32</span> <span class="n">sw_if_index</span><span class="p">;</span>
    <span class="n">u8</span> <span class="n">admin_up_down</span><span class="p">;</span>
<span class="p">})</span> <span class="n">vl_api_sw_interface_set_flags_t</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="cp">#ifndef defined_sw_interface_set_flags_reply</span>
<span class="cp">#define defined_sw_interface_set_flags_reply</span>
<span class="k">typedef</span> <span class="n">VL_API_PACKED</span><span class="p">(</span><span class="k">struct</span> <span class="n">_vl_api_sw_interface_set_flags_reply</span> <span class="p">{</span>
    <span class="n">u16</span> <span class="n">_vl_msg_id</span><span class="p">;</span>
    <span class="n">u32</span> <span class="n">context</span><span class="p">;</span>
    <span class="n">i32</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">})</span> <span class="n">vl_api_sw_interface_set_flags_reply_t</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">...</span>
<span class="cp">#endif </span><span class="cm">/* vl_typedefs */</span><span class="cp"></span>
</pre></div>
</div>
<p>To change the admin state of an interface, a binary api client sends a
<a class="reference external" href="https://docs.fd.io/vpp/18.11/dc/da3/structvl__api__sw__interface__set__flags__t.html">vl_api_sw_interface_set_flags_t</a>
to VPP, which will respond with a
vl_api_sw_interface_set_flags_reply_t message.</p>
<p>Multiple layers of software, transport types, and shared libraries
implement a variety of features:</p>
<ul class="simple">
<li><p>API message allocation, tracing, pretty-printing, and replay.</p></li>
<li><p>Message transport via global shared memory, pairwise/private shared memory, and sockets.</p></li>
<li><p>Barrier synchronization of worker threads across thread-unsafe message handlers.</p></li>
</ul>
<p>Correctly-coded message handlers know nothing about the transport used
to deliver messages to/from VPP. It’s reasonably straightforward to use
multiple API message transport types simultaneously.</p>
<p>For historical reasons, binary api messages are (putatively) sent in
network byte order. As of this writing, we’re seriously considering
whether that choice makes sense.</p>
<div class="section" id="message-allocation">
<h2>Message Allocation<a class="headerlink" href="#message-allocation" title="Permalink to this headline">¶</a></h2>
<p>Since binary API messages are always processed in order, we allocate
messages using a ring allocator whenever possible. This scheme is
extremely fast when compared with a traditional memory allocator, and
doesn’t cause heap fragmentation. See <a class="reference external" href="https://docs.fd.io/vpp/18.11/dd/d0d/memory__shared_8c.html">src/vlibmemory/memory_shared.c</a>
<a class="reference external" href="https://docs.fd.io/vpp/18.11/dd/d0d/memory__shared_8c.html#ac6b6797850e1a53bc68b206e6b8413fb">vl_msg_api_alloc_internal()</a>.</p>
<p>Regardless of transport, binary api messages always follow a <a class="reference external" href="https://docs.fd.io/vpp/18.11/d9/d65/structmsgbuf__.html">msgbuf_t</a> header:</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="cm">/** Message header structure */</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">msgbuf_</span>
<span class="p">{</span>
  <span class="n">svm_queue_t</span> <span class="o">*</span><span class="n">q</span><span class="p">;</span> <span class="cm">/**&lt; message allocated in this shmem ring  */</span>
  <span class="n">u32</span> <span class="n">data_len</span><span class="p">;</span>                  <span class="cm">/**&lt; message length not including header  */</span>
  <span class="n">u32</span> <span class="n">gc_mark_timestamp</span><span class="p">;</span>         <span class="cm">/**&lt; message garbage collector mark TS  */</span>
  <span class="n">u8</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>                    <span class="cm">/**&lt; actual message begins here  */</span>
<span class="p">}</span> <span class="n">msgbuf_t</span><span class="p">;</span>
</pre></div>
</div>
<p>This structure makes it easy to trace messages without having to
decode them - simply save data_len bytes - and allows
<a class="reference external" href="https://docs.fd.io/vpp/18.11/d6/d1b/api__common_8h.html#aff61e777fe5df789121d8e78134867e6">vl_msg_api_free()</a>
to rapidly dispose of message buffers:</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span>
<span class="nf">vl_msg_api_free</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">a</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">msgbuf_t</span> <span class="o">*</span><span class="n">rv</span><span class="p">;</span>
  <span class="kt">void</span> <span class="o">*</span><span class="n">oldheap</span><span class="p">;</span>
  <span class="n">api_main_t</span> <span class="o">*</span><span class="n">am</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">api_main</span><span class="p">;</span>

  <span class="n">rv</span> <span class="o">=</span> <span class="p">(</span><span class="n">msgbuf_t</span> <span class="o">*</span><span class="p">)</span> <span class="p">(((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">a</span><span class="p">)</span> <span class="o">-</span> <span class="n">offsetof</span> <span class="p">(</span><span class="n">msgbuf_t</span><span class="p">,</span> <span class="n">data</span><span class="p">));</span>

  <span class="cm">/*</span>
<span class="cm">   * Here&#39;s the beauty of the scheme.  Only one proc/thread has</span>
<span class="cm">   * control of a given message buffer. To free a buffer, we just clear the</span>
<span class="cm">   * queue field, and leave. No locks, no hits, no errors...</span>
<span class="cm">   */</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">rv</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">rv</span><span class="o">-&gt;</span><span class="n">q</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="n">rv</span><span class="o">-&gt;</span><span class="n">gc_mark_timestamp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="o">&lt;</span><span class="n">more</span> <span class="n">code</span><span class="p">...</span><span class="o">&gt;</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="o">&lt;</span><span class="n">more</span> <span class="n">code</span><span class="p">...</span><span class="o">&gt;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="message-tracing-and-replay">
<h2>Message Tracing and Replay<a class="headerlink" href="#message-tracing-and-replay" title="Permalink to this headline">¶</a></h2>
<p>It’s extremely important that VPP can capture and replay sizeable
binary API traces. System-level issues involving hundreds of thousands
of API transactions can be re-run in a second or less. Partial replay
allows one to binary-search for the point where the wheels fall
off. One can add scaffolding to the data plane, to trigger when
complex conditions obtain.</p>
<p>With binary API trace, print, and replay, system-level bug reports of
the form “after 300,000 API transactions, the VPP data-plane stopped
forwarding traffic, FIX IT!” can be solved offline.</p>
<p>More often than not, one discovers that a control-plane client
misprograms the data plane after a long time or under complex
circumstances. Without direct evidence, “it’s a data-plane problem!”</p>
<p>See <a class="reference external" href="https://docs.fd.io/vpp/18.11/dd/d3e/vpp__get__metrics_8c.html#a7c3855ed3c45b48ff92a7e881bfede73">src/vlibmemory/memory_vlib::c</a>
<a class="reference external" href="https://docs.fd.io/vpp/18.11/d0/d5b/vlib__api__cli_8c.html#a60194e3e91c0dc6a75906ea06f4ec113">vl_msg_api_process_file()</a>,
and <a class="reference external" href="https://docs.fd.io/vpp/18.11/d6/dd1/api__shared_8c.html">src/vlibapi/api_shared.c</a>. See also
the debug CLI command “api trace”</p>
</div>
<div class="section" id="api-trace-replay-caveats">
<h2>API trace replay caveats<a class="headerlink" href="#api-trace-replay-caveats" title="Permalink to this headline">¶</a></h2>
<p>The vpp instance which replays a binary API trace must have the same
message-ID numbering space as the vpp instance which captured the
trace. The replay instance <strong>must</strong> load the same set of plugins as
the capture instance. Otherwise, API messages will be processed by the
<strong>wrong</strong> API message handlers!</p>
<p>Always start vpp with command-line arguments which include an
“api-trace on” stanza, so vpp will start tracing binary API messages
from the beginning:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">api-trace {</span>
<span class="go">  on</span>
<span class="go">}</span>
</pre></div>
</div>
<p>Given a binary api trace in /tmp/api_trace, do the following to work
out the set of plugins:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">DBGvpp# api trace custom-dump /tmp/api_trace</span>
<span class="go">vl_api_trace_plugin_msg_ids: abf_54307ba2 first 846 last 855</span>
<span class="go">vl_api_trace_plugin_msg_ids: acl_0d7265b0 first 856 last 893</span>
<span class="go">vl_api_trace_plugin_msg_ids: cdp_8f707b96 first 894 last 895</span>
<span class="go">vl_api_trace_plugin_msg_ids: flowprobe_f2f0286c first 898 last 901</span>
<span class="go">&lt;etc&gt;</span>
</pre></div>
</div>
<p>Here, we see the “abf,” “acl,” “cdp,” and “flowprobe” plugins. Use the
list of plugins to construct a matching “plugins” command-line argument
stanza:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">plugins {</span>
<span class="gp">    #</span><span class="c1"># Disable all plugins, selectively enable specific plugins</span>
<span class="go">    plugin default { disable }</span>
<span class="go">    plugin abf_plugin.so { enable }</span>
<span class="go">    plugin acl_plugin.so { enable }</span>
<span class="go">    plugin cdp_plugin.so { enable }</span>
<span class="go">    plugin flowprobe_plugin.so { enable }</span>
<span class="go">}</span>
</pre></div>
</div>
<p>To begin with, use the same vpp image that captured a trace to replay
it. It’s perfectly fair to rebuild the vpp replay instance, to add
scaffolding to facilitate setting gdb breakpoints on complex
conditions or similar.</p>
</div>
<div class="section" id="api-trace-interface-issues">
<h2>API trace interface issues<a class="headerlink" href="#api-trace-interface-issues" title="Permalink to this headline">¶</a></h2>
<p>Along the same lines, it may be necessary to manufacture [simulated]
physical interfaces so that an API trace will replay correctly. “show
interface” on the trace origin system can help. An API trace
“custom-dump” as shown above may make it obvious how many loopback
interfaces to create. If you see vhost interfaces being created and
then configured, the first such configuration message in the trace
will tell you how many physical interfaces were involved.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">SCRIPT: create_vhost_user_if socket /tmp/foosock server</span>
<span class="go">SCRIPT: sw_interface_set_flags sw_if_index 3 admin-up</span>
</pre></div>
</div>
<p>In this case, it’s fair to guess that one needs to create two loopback
interfaces to “help” the trace replay correctly.</p>
<p>These issues can be mitigated to a certain extent by replaying the
trace on the system which created it, but in a field debug case that’s
not a realistic.</p>
</div>
<div class="section" id="client-connection-details">
<h2>Client connection details<a class="headerlink" href="#client-connection-details" title="Permalink to this headline">¶</a></h2>
<p>Establishing a binary API connection to VPP from a C-language client is easy:</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span>
<span class="nf">connect_to_vpe</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">client_name</span><span class="p">,</span> <span class="kt">int</span> <span class="n">client_message_queue_length</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">vat_main_t</span> <span class="o">*</span><span class="n">vam</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vat_main</span><span class="p">;</span>
  <span class="n">api_main_t</span> <span class="o">*</span><span class="n">am</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">api_main</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">vl_client_connect_to_vlib</span> <span class="p">(</span><span class="s">&quot;/vpe-api&quot;</span><span class="p">,</span> <span class="n">client_name</span><span class="p">,</span>
                                <span class="n">client_message_queue_length</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
  <span class="cm">/* Memorize vpp&#39;s binary API message input queue address */</span>
  <span class="n">vam</span><span class="o">-&gt;</span><span class="n">vl_input_queue</span> <span class="o">=</span> <span class="n">am</span><span class="o">-&gt;</span><span class="n">shmem_hdr</span><span class="o">-&gt;</span><span class="n">vl_input_queue</span><span class="p">;</span>
  <span class="cm">/* And our client index */</span>
  <span class="n">vam</span><span class="o">-&gt;</span><span class="n">my_client_index</span> <span class="o">=</span> <span class="n">am</span><span class="o">-&gt;</span><span class="n">my_client_index</span><span class="p">;</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>32 is a typical value for client_message_queue_length. VPP <em>cannot</em>
block when it needs to send an API message to a binary API client. The
VPP-side binary API message handlers are very fast. So, when sending
asynchronous messages, make sure to scrape the binary API rx ring with
some enthusiasm!</p>
<p><strong>Binary API message RX pthread</strong></p>
<p>Calling <a class="reference external" href="https://docs.fd.io/vpp/18.11/da/d25/memory__client_8h.html#a6654b42c91be33bfb6a4b4bfd2327920">vl_client_connect_to_vlib</a>
spins up a binary API message RX pthread:</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="k">static</span> <span class="kt">void</span> <span class="o">*</span>
<span class="nf">rx_thread_fn</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">svm_queue_t</span> <span class="o">*</span><span class="n">q</span><span class="p">;</span>
  <span class="n">memory_client_main_t</span> <span class="o">*</span><span class="n">mm</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">memory_client_main</span><span class="p">;</span>
  <span class="n">api_main_t</span> <span class="o">*</span><span class="n">am</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">api_main</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

  <span class="n">q</span> <span class="o">=</span> <span class="n">am</span><span class="o">-&gt;</span><span class="n">vl_input_queue</span><span class="p">;</span>

  <span class="cm">/* So we can make the rx thread terminate cleanly */</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">setjmp</span> <span class="p">(</span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">rx_thread_jmpbuf</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">mm</span><span class="o">-&gt;</span><span class="n">rx_thread_jmpbuf_valid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
      <span class="cm">/*</span>
<span class="cm">       * Find an unused slot in the per-cpu-mheaps array,</span>
<span class="cm">       * and grab it for this thread. We need to be able to</span>
<span class="cm">       * push/pop the thread heap without affecting other thread(s).</span>
<span class="cm">       */</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">__os_thread_index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">{</span>
          <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_LEN</span> <span class="p">(</span><span class="n">clib_per_cpu_mheaps</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
            <span class="p">{</span>
              <span class="k">if</span> <span class="p">(</span><span class="n">clib_per_cpu_mheaps</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
                <span class="p">{</span>
                  <span class="cm">/* Copy the main thread mheap pointer */</span>
                  <span class="n">clib_per_cpu_mheaps</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">clib_per_cpu_mheaps</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
                  <span class="n">__os_thread_index</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
                  <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
          <span class="n">ASSERT</span> <span class="p">(</span><span class="n">__os_thread_index</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">vl_msg_api_queue_handler</span> <span class="p">(</span><span class="n">q</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="n">pthread_exit</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>To handle the binary API message queue yourself, use
<a class="reference external" href="https://docs.fd.io/vpp/18.11/da/d25/memory__client_8h.html#a11b9577297106c57c0783b96ab190c36">vl_client_connect_to_vlib_no_rx_pthread</a>.</p>
<p><strong>Queue non-empty signalling</strong></p>
<p>vl_msg_api_queue_handler(…) uses mutex/condvar signalling to wake
up, process VPP -&gt; client traffic, then sleep. VPP supplies a condvar
broadcast when the VPP -&gt; client API message queue transitions from
empty to nonempty.</p>
<p>VPP checks its own binary API input queue at a very high rate. VPP
invokes message handlers in “process” context [aka cooperative
multitasking thread context] at a variable rate, depending on
data-plane packet processing requirements.</p>
</div>
<div class="section" id="client-disconnection-details">
<h2>Client disconnection details<a class="headerlink" href="#client-disconnection-details" title="Permalink to this headline">¶</a></h2>
<p>To disconnect from VPP, call <a class="reference external" href="https://docs.fd.io/vpp/18.11/da/d25/memory__client_8h.html#a82c9ba6e7ead8362ae2175eefcf2fd12">vl_client_disconnect_from_vlib</a>. Please
arrange to call this function if the client application terminates
abnormally. VPP makes every effort to hold a decent funeral for dead
clients, but VPP can’t guarantee to free leaked memory in the shared
binary API segment.</p>
</div>
<div class="section" id="sending-binary-api-messages-to-vpp">
<h2>Sending binary API messages to VPP<a class="headerlink" href="#sending-binary-api-messages-to-vpp" title="Permalink to this headline">¶</a></h2>
<p>The point of the exercise is to send binary API messages to VPP, and
to receive replies from VPP. Many VPP binary APIs comprise a client
request message, and a simple status reply. For example, to set the
admin status of an interface:</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="n">vl_api_sw_interface_set_flags_t</span> <span class="o">*</span><span class="n">mp</span><span class="p">;</span>
<span class="n">mp</span> <span class="o">=</span> <span class="n">vl_msg_api_alloc</span> <span class="p">(</span><span class="k">sizeof</span> <span class="p">(</span><span class="o">*</span><span class="n">mp</span><span class="p">));</span>
<span class="n">memset</span> <span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="o">*</span><span class="n">mp</span><span class="p">));</span>
<span class="n">mp</span><span class="o">-&gt;</span><span class="n">_vl_msg_id</span> <span class="o">=</span> <span class="n">clib_host_to_net_u16</span> <span class="p">(</span><span class="n">VL_API_SW_INTERFACE_SET_FLAGS</span><span class="p">);</span>
<span class="n">mp</span><span class="o">-&gt;</span><span class="n">client_index</span> <span class="o">=</span> <span class="n">api_main</span><span class="p">.</span><span class="n">my_client_index</span><span class="p">;</span>
<span class="n">mp</span><span class="o">-&gt;</span><span class="n">sw_if_index</span> <span class="o">=</span> <span class="n">clib_host_to_net_u32</span> <span class="p">(</span><span class="o">&lt;</span><span class="n">interface</span><span class="o">-</span><span class="n">sw</span><span class="o">-</span><span class="k">if</span><span class="o">-</span><span class="n">index</span><span class="o">&gt;</span><span class="p">);</span>
<span class="n">vl_msg_api_send</span> <span class="p">(</span><span class="n">api_main</span><span class="p">.</span><span class="n">shmem_hdr</span><span class="o">-&gt;</span><span class="n">vl_input_queue</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">mp</span><span class="p">);</span>
</pre></div>
</div>
<p>Key points:</p>
<ul class="simple">
<li><p>Use <a class="reference external" href="https://docs.fd.io/vpp/18.11/dc/d5a/memory__shared_8h.html#a109ff1e95ebb2c968d43c100c4a1c55a">vl_msg_api_alloc</a> to allocate message buffers</p></li>
<li><p>Allocated message buffers are not initialized, and must be presumed to contain trash.</p></li>
<li><p>Don’t forget to set the _vl_msg_id field!</p></li>
<li><p>As of this writing, binary API message IDs and data are sent in network byte order</p></li>
<li><p>The client-library global data structure <a class="reference external" href="https://docs.fd.io/vpp/18.11/d6/dd1/api__shared_8c.html#af58e3e46b569573e9622b826b2f47a22">api_main</a> keeps track of sufficient pointers and handles used to communicate with VPP</p></li>
</ul>
</div>
<div class="section" id="receiving-binary-api-messages-from-vpp">
<h2>Receiving binary API messages from VPP<a class="headerlink" href="#receiving-binary-api-messages-from-vpp" title="Permalink to this headline">¶</a></h2>
<p>Unless you’ve made other arrangements (see
<a class="reference external" href="https://docs.fd.io/vpp/18.11/da/d25/memory__client_8h.html#a11b9577297106c57c0783b96ab190c36">vl_client_connect_to_vlib_no_rx_pthread</a>),
<em>messages are received on a separate rx pthread</em>. Synchronization with
the client application main thread is the responsibility of the
application!</p>
<p>Set up message handlers about as follows:</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="cp">#define vl_typedefs         </span><span class="cm">/* define message structures */</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;vpp/api/vpe_all_api_h.h&gt;</span><span class="cp"></span>
<span class="cp">#undef vl_typedefs</span>
<span class="cm">/* declare message handlers for each api */</span>
<span class="cp">#define vl_endianfun                </span><span class="cm">/* define message structures */</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;vpp/api/vpe_all_api_h.h&gt;</span><span class="cp"></span>
<span class="cp">#undef vl_endianfun</span>
<span class="cm">/* instantiate all the print functions we know about */</span>
<span class="cp">#define vl_print(handle, ...)</span>
<span class="cp">#define vl_printfun</span>
<span class="cp">#include</span> <span class="cpf">&lt;vpp/api/vpe_all_api_h.h&gt;</span><span class="cp"></span>
<span class="cp">#undef vl_printfun</span>
<span class="cm">/* Define a list of all message that the client handles */</span>
<span class="cp">#define foreach_vpe_api_reply_msg                            \</span>
<span class="cp">   _(SW_INTERFACE_SET_FLAGS_REPLY, sw_interface_set_flags_reply)</span>
   <span class="k">static</span> <span class="n">clib_error_t</span> <span class="o">*</span>
   <span class="nf">my_api_hookup</span> <span class="p">(</span><span class="n">vlib_main_t</span> <span class="o">*</span> <span class="n">vm</span><span class="p">)</span>
   <span class="p">{</span>
     <span class="n">api_main_t</span> <span class="o">*</span><span class="n">am</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">api_main</span><span class="p">;</span>
   <span class="cp">#define _(N,n)                                                  \</span>
<span class="cp">       vl_msg_api_set_handlers(VL_API_##N, #n,                     \</span>
<span class="cp">                              vl_api_##n##_t_handler,              \</span>
<span class="cp">                              vl_noop_handler,                     \</span>
<span class="cp">                              vl_api_##n##_t_endian,               \</span>
<span class="cp">                              vl_api_##n##_t_print,                \</span>
<span class="cp">                              sizeof(vl_api_##n##_t), 1);</span>
     <span class="n">foreach_vpe_api_msg</span><span class="p">;</span>
   <span class="cp">#undef _</span>
     <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
</pre></div>
</div>
<p>The key API used to establish message handlers is
<a class="reference external" href="https://docs.fd.io/vpp/18.11/d6/dd1/api__shared_8c.html#aa8a8e1f3876ec1a02f283c1862ecdb7a">vl_msg_api_set_handlers</a>
, which sets values in multiple parallel vectors in the <a class="reference external" href="https://docs.fd.io/vpp/18.11/dd/db2/structapi__main__t.html">api_main_t</a>
structure. As of this writing: not all vector element values can be
set through the API. You’ll see sporadic API message registrations
followed by minor adjustments of this form:</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="cm">/*</span>
<span class="cm"> * Thread-safe API messages</span>
<span class="cm"> */</span>
<span class="n">am</span><span class="o">-&gt;</span><span class="n">is_mp_safe</span><span class="p">[</span><span class="n">VL_API_IP_ADD_DEL_ROUTE</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">am</span><span class="o">-&gt;</span><span class="n">is_mp_safe</span><span class="p">[</span><span class="n">VL_API_GET_NODE_GRAPH</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</pre></div>
</div>
<div class="section" id="api-message-numbering-in-plugins">
<h3>API message numbering in plugins<a class="headerlink" href="#api-message-numbering-in-plugins" title="Permalink to this headline">¶</a></h3>
<p>Binary API message numbering in plugins relies on vpp to issue a block
of message-ID’s for the plugin to use:</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="k">static</span> <span class="n">clib_error_t</span> <span class="o">*</span>
<span class="nf">my_init</span> <span class="p">(</span><span class="n">vlib_main_t</span> <span class="o">*</span> <span class="n">vm</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">my_main_t</span> <span class="o">*</span><span class="n">mm</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">my_main</span><span class="p">;</span>

  <span class="n">name</span> <span class="o">=</span> <span class="n">format</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;myplugin_%08x%c&quot;</span><span class="p">,</span> <span class="n">api_version</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

  <span class="cm">/* Ask for a correctly-sized block of API message decode slots */</span>
  <span class="n">mm</span><span class="o">-&gt;</span><span class="n">msg_id_base</span> <span class="o">=</span> <span class="n">vl_msg_api_get_msg_ids</span>
    <span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">name</span><span class="p">,</span> <span class="n">VL_MSG_FIRST_AVAILABLE</span><span class="p">);</span>

  <span class="p">}</span>
</pre></div>
</div>
<p>Control-plane codes use the vl_client_get_first_plugin_msg_id (…) api
to recover the message ID block base:</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="cm">/* Ask the vpp engine for the first assigned message-id */</span>
<span class="n">name</span> <span class="o">=</span> <span class="n">format</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;myplugin_%08x%c&quot;</span><span class="p">,</span> <span class="n">api_version</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">sm</span><span class="o">-&gt;</span><span class="n">msg_id_base</span> <span class="o">=</span> <span class="n">vl_client_get_first_plugin_msg_id</span> <span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">name</span><span class="p">);</span>
</pre></div>
</div>
<p>It’s a fairly common error to forget to add msg_id_base when
registering message handlers, or when sending messages. Using macros
from …/src/vlibapi/api_helper_macros.h can automate the process, but
remember to #define REPLY_MSG_ID_BASE before #including the file:</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="cp">#define REPLY_MSG_ID_BASE mm-&gt;msg_id_base</span>
<span class="cp">#include</span> <span class="cpf">&lt;vlibapi/api_helper_macros.h&gt;</span><span class="cp"></span>
</pre></div>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="buildsystem/index.html" class="btn btn-neutral float-right" title="Build System" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="vpp_api_module.html" class="btn btn-neutral float-left" title="VPP API module" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018-2020, Linux Foundation

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>