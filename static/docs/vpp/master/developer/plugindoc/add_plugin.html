<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Adding a plugin &mdash; The Vector Packet Processor v22.02-rc0-128-g4450b03ba
 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/rules.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Sample plugin for VPP" href="sample_plugin_doc.html" />
    <link rel="prev" title="Adding a new plugin or feature" href="index.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> The Vector Packet Processor
            <img src="../../_static/fd-io_red_white.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                v22.02-rc0-128-g4450b03ba

              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">About VPP</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../aboutvpp/scalar-vs-vector-packet-processing.html">Scalar vs Vector packet processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../aboutvpp/extensible.html">The Packet Processing Graph</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../aboutvpp/networkstack.html">Network Stack Features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../aboutvpp/hoststack.html">Host Stack</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../aboutvpp/developer.html">Additional features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../aboutvpp/supported.html">Supported archs and OS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../aboutvpp/performance.html">Performance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../aboutvpp/releasenotes/index.html">Release notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../aboutvpp/featurelist.html">VPP Supported Features</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Use Cases</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../usecases/containers/index.html">VPP with Containers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usecases/simpleperf/index.html">VPP with Iperf3 and TRex</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usecases/vppcloud/index.html">VPP in the Cloud</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usecases/vhost/index.html">VPP with Virtual Machines</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usecases/vmxnet3.html">VPP with VMware/Vmxnet3</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usecases/home_gateway.html">VPP as a Home Gateway</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usecases/acls.html">Access Control Lists with VPP</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usecases/networksim.html">Generating traffic with VPP</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usecases/webapp.html">Web applications with VPP</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usecases/container_test.html">Simulating networks with VPP</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usecases/trafficgen.html">Stateless Traffic Gen with VPP</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usecases/ikev2/index.html">IKEv2 with VPP</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usecases/contiv/index.html">VPP in kubernetes (Contiv/Deprecated)</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Getting started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../gettingstarted/installing/index.html">Downloading and Installing VPP</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../gettingstarted/running/index.html">Running VPP</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../gettingstarted/progressivevpp/index.html">Progressive VPP Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../gettingstarted/troubleshooting/index.html">Troubleshooting</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developer Documentation</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../build-run-debug/index.html">Build, Run &amp; Debug</a></li>
<li class="toctree-l1"><a class="reference internal" href="../corearchitecture/index.html">Core Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../corefeatures/index.html">Core Features</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Adding a new plugin or feature</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="#">Adding a plugin</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#strategic-choices">Strategic Choices</a></li>
<li class="toctree-l3"><a class="reference internal" href="#how-to-create-a-new-plugin">How to create a new plugin</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#generated-files">Generated Files</a></li>
<li class="toctree-l4"><a class="reference internal" href="#rebuild-your-workspace">Rebuild your workspace</a></li>
<li class="toctree-l4"><a class="reference internal" href="#sanity-check-run-vpp">Sanity check: run vpp</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#generated-files-in-detail">Generated Files in Detail</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#cmakelists-txt">CMakeLists.txt</a></li>
<li class="toctree-l4"><a class="reference internal" href="#myplugin-h">myplugin.h</a></li>
<li class="toctree-l4"><a class="reference internal" href="#myplugin-c">myplugin.c</a></li>
<li class="toctree-l4"><a class="reference internal" href="#myplugin-test-c">myplugin_test.c</a></li>
<li class="toctree-l4"><a class="reference internal" href="#node-c">node.c</a></li>
<li class="toctree-l4"><a class="reference internal" href="#myplugin-api">myplugin.api</a></li>
<li class="toctree-l4"><a class="reference internal" href="#myplugin-periodic-c">myplugin_periodic.c</a></li>
<li class="toctree-l4"><a class="reference internal" href="#plugin-friends-with-benefits">Plugin “Friends with Benefits”</a></li>
<li class="toctree-l4"><a class="reference internal" href="#more-examples">More Examples</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="sample_plugin_doc.html">Sample plugin for VPP</a></li>
<li class="toctree-l2"><a class="reference internal" href="handoffdemo.html">Handoff queue in a plugin</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../plugins/index.html">Plugins</a></li>
<li class="toctree-l1"><a class="reference internal" href="../devicedrivers/index.html">Device drivers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tests/overview.html">VPP Test Framework</a></li>
<li class="toctree-l1"><a class="reference internal" href="../extras/index.html">VPP extra tools</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Interfacing with VPP</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../interfacing/binapi/index.html">The binary API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../interfacing/c/index.html">C api client</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../interfacing/cpp/index.html">C++ api client</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../interfacing/go/index.html">Go api (govpp)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../interfacing/rust/index.html">Rust api client</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../interfacing/libmemif/index.html">Memif library (libmemif)</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Contributing</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../contributing/gitreview.html">Getting a Patch Reviewed</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contributing/writingdocs.html">Writing VPP Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contributing/reportingissues/index.html">Reporting Bugs</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Debug CLI</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../cli-reference/gettingstarted/index.html">Getting Started with the debug CLI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cli-reference/interface/index.html">Interface Commands</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cli-reference/index.html">Reference</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Configuration file</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../configuration/config_getting_started.html">Getting started with the configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../configuration/reference.html">Configuration Reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">The Vector Packet Processor</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="index.html">Adding a new plugin or feature</a> &raquo;</li>
      <li>Adding a plugin</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/developer/plugindoc/add_plugin.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="adding-a-plugin">
<span id="add-plugin"></span><h1>Adding a plugin<a class="headerlink" href="#adding-a-plugin" title="Permalink to this headline"></a></h1>
<div class="toctree-wrapper compound">
</div>
<section id="strategic-choices">
<h2>Strategic Choices<a class="headerlink" href="#strategic-choices" title="Permalink to this headline"></a></h2>
<p>Plugins may implement lightly-used, experimental, or test
functionality. In such cases, please disable the plugin by default:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">/* *INDENT-OFF* */</span>
<span class="go">VLIB_PLUGIN_REGISTER () =</span>
<span class="go">{</span>
<span class="go">  .version = VPP_BUILD_VER,</span>
<span class="go">  .description = &quot;Plugin Disabled by Default...&quot;,</span>
<span class="go">  .default_disabled = 1,</span>
<span class="go">};</span>
<span class="go">/* *INDENT-ON* */</span>
</pre></div>
</div>
<p>Please do not create processes, or other dynamic data structures
unless the plugin is configured by API or debug CLI.</p>
<p>Specifically, please don’t initialize bihash tables from
VLIB_INIT_FUNCTIONS, <em>especially</em> if the bihash template involved
doesn’t #define BIHASH_LAZY_INSTANTIATE 1.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">static clib_error_t * sample_init (vlib_main_t * vm)</span>
<span class="go">{</span>
<span class="go">  &lt;snip&gt;</span>
<span class="go">  /* DONT DO THIS! */</span>
<span class="go">  BV(clib_bihash_init (h, ...))</span>
<span class="go">  &lt;snip&gt;</span>
<span class="go">}</span>
<span class="go">VLIB_INIT_FUNCTION (sample_init);</span>
</pre></div>
</div>
<p>Instead, please add a feature_init function:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">static void</span>
<span class="go">feature_init (my_main_t * mm)</span>
<span class="go">{</span>
<span class="go">  if (mm-&gt;feature_initialized == 0)</span>
<span class="go">    {</span>
<span class="go">      BV(clib_bihash_init)(mm-&gt;hash_table, ...)</span>
<span class="go">      /* Create Other Things, e.g a periodic process */</span>
<span class="go">      mm-&gt;feature_initialized = 1;</span>
<span class="go">    }</span>
<span class="go">}</span>
</pre></div>
</div>
<p>And call it from debug CLI and API message handlers any time the feature
is enabled.</p>
</section>
<section id="how-to-create-a-new-plugin">
<h2>How to create a new plugin<a class="headerlink" href="#how-to-create-a-new-plugin" title="Permalink to this headline"></a></h2>
<p>This section shows how a VPP developer can create a new plugin, and
add it to VPP. We assume that we are starting from the VPP &lt;top-of-workspace&gt;.</p>
<p>As an example, we will use the <strong>make-plugin.sh</strong> tool found in
<strong>./extras/emacs</strong>. make-plugin.sh is a simple wrapper for a comprehensive
plugin generator constructed from a set of emacs-lisp skeletons.</p>
<p>Change directory to <strong>./src/plugins</strong>, and run the plugin generator:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span><span class="nb">cd</span> ./src/plugins
<span class="gp">$ </span>../../extras/emacs/make-plugin.sh
<span class="go">&lt;snip&gt;</span>
<span class="go">Loading /scratch/vpp-docs/extras/emacs/tunnel-c-skel.el (source)...</span>
<span class="go">Loading /scratch/vpp-docs/extras/emacs/tunnel-decap-skel.el (source)...</span>
<span class="go">Loading /scratch/vpp-docs/extras/emacs/tunnel-encap-skel.el (source)...</span>
<span class="go">Loading /scratch/vpp-docs/extras/emacs/tunnel-h-skel.el (source)...</span>
<span class="go">Loading /scratch/vpp-docs/extras/emacs/elog-4-int-skel.el (source)...</span>
<span class="go">Loading /scratch/vpp-docs/extras/emacs/elog-4-int-track-skel.el (source)...</span>
<span class="go">Loading /scratch/vpp-docs/extras/emacs/elog-enum-skel.el (source)...</span>
<span class="go">Loading /scratch/vpp-docs/extras/emacs/elog-one-datum-skel.el (source)...</span>
<span class="go">Plugin name: myplugin</span>
<span class="go">Dispatch type [dual or qs]: dual</span>
<span class="gp gp-VirtualEnv">(Shell command succeeded with no output)</span>

<span class="go">OK...</span>
</pre></div>
</div>
<p>The plugin generator script asks two questions: the name of the
plugin, and which of two dispatch types to use. Since the plugin name
finds its way into quite a number of places - filenames, typedef
names, graph arc names - it pays to think for a moment.</p>
<p>The dispatch type refers to the coding pattern used to construct
<strong>node.c</strong>, the <em>pro forma</em> data-plane node. The <strong>dual</strong> option
constructs a dual-single loop pair with speculative enqueueing. This
is the traditional coding pattern for load-store intensive graph
nodes.</p>
<p>The <strong>qs</strong> option generates a quad-single loop pair which uses
vlib_get_buffers(…) and vlib_buffer_enqueue_to_next(…). These
operators make excellent use of available SIMD vector unit
operations. It’s very simple to change a quad-single loop-pair to a
dual-single loop pair if you decide to do so later.</p>
<section id="generated-files">
<h3>Generated Files<a class="headerlink" href="#generated-files" title="Permalink to this headline"></a></h3>
<p>Here are the generated files. We’ll go through them in a moment.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span><span class="nb">cd</span> ./myplugin
<span class="gp">$ </span>ls
<span class="go">CMakeLists.txt  myplugin.api  myplugin.c  myplugin.h</span>
<span class="go">myplugin_periodic.c  myplugin_test.c  node.c  setup.pg</span>
</pre></div>
</div>
<p>Due to recent build system improvements, you <strong>don’t</strong> need to touch
any other files to integrate your new plugin into the vpp build. Simply
rebuild your workspace from scratch, and the new plugin will appear.</p>
</section>
<section id="rebuild-your-workspace">
<h3>Rebuild your workspace<a class="headerlink" href="#rebuild-your-workspace" title="Permalink to this headline"></a></h3>
<p>This is the straightforward way to reconfigure and rebuild your workspace:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span><span class="nb">cd</span> &lt;top-of-workspace&gt;
<span class="gp">$ </span>make rebuild <span class="o">[</span>or rebuild-release<span class="o">]</span>
</pre></div>
</div>
<p>Thanks to ccache, this operation doesn’t take an annoying amount of time.</p>
</section>
<section id="sanity-check-run-vpp">
<h3>Sanity check: run vpp<a class="headerlink" href="#sanity-check-run-vpp" title="Permalink to this headline"></a></h3>
<p>As a quick sanity check, run vpp and make sure that
“myplugin_plugin.so” and “myplugin_test_plugin.so” are loaded:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span><span class="nb">cd</span> &lt;top-of-workspace&gt;
<span class="gp">$ </span>make run
<span class="go">&lt;snip&gt;</span>
<span class="go">load_one_plugin:189: Loaded plugin: myplugin_plugin.so (myplugin description goes here)</span>
<span class="go">&lt;snip&gt;</span>
<span class="go">load_one_vat_plugin:67: Loaded plugin: myplugin_test_plugin.so</span>
<span class="go">&lt;snip&gt;</span>
<span class="go">DBGvpp#</span>
</pre></div>
</div>
<p>If this simple test fails, please seek assistance.</p>
</section>
</section>
<section id="generated-files-in-detail">
<h2>Generated Files in Detail<a class="headerlink" href="#generated-files-in-detail" title="Permalink to this headline"></a></h2>
<p>This section discusses the generated files in some detail. It’s fine to
skim this section, and return later for more detail.</p>
<section id="cmakelists-txt">
<h3>CMakeLists.txt<a class="headerlink" href="#cmakelists-txt" title="Permalink to this headline"></a></h3>
<p>This is the build system recipe for building your plugin. Please fix
the copyright notice:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>Copyright <span class="o">(</span>c<span class="o">)</span> &lt;current-year&gt; &lt;your-organization&gt;
</pre></div>
</div>
<p>The rest of the build recipe is pretty simple:</p>
<div class="highlight-CMake notranslate"><div class="highlight"><pre><span></span><span class="nb">add_vpp_plugin</span> <span class="p">(</span><span class="s">myplugin</span>
<span class="s">SOURCES</span>
<span class="s">myplugin.c</span>
<span class="s">node.c</span>
<span class="s">myplugin_periodic.c</span>
<span class="s">myplugin.h</span>

<span class="s">MULTIARCH_SOURCES</span>
<span class="s">node.c</span>

<span class="s">API_FILES</span>
<span class="s">myplugin.api</span>

<span class="s">API_TEST_SOURCES</span>
<span class="s">myplugin_test.c</span>
<span class="p">)</span>
</pre></div>
</div>
<p>As you can see, the build recipe consists of several lists of
files. <strong>SOURCES</strong> is a list of C source files. <strong>API_FILES</strong> is a
list of the plugin’s binary API definition files [one such file is
usually plenty], and so forth.</p>
<p><strong>MULTIARCH_SOURCES</strong> lists data plane graph node dispatch function
source files considered to be performance-critical. Specific functions
in these files are compiled multiple times, so that they can leverage
CPU-specific features. More on this in a moment.</p>
<p>If you add source files, simply add them to the indicated list(s).</p>
</section>
<section id="myplugin-h">
<h3>myplugin.h<a class="headerlink" href="#myplugin-h" title="Permalink to this headline"></a></h3>
<p>This is the primary #include file for the new plugin. Among other
things, it defines the plugin’s <em>main_t</em> data structure. This is the
right place to add problem-specific data structures. Please <strong>resist
the temptation</strong> to create a set of static or [worse yet] global
variables in your plugin. Refereeing name-collisions between plugins
is not anyone’s idea of a good time.</p>
</section>
<section id="myplugin-c">
<h3>myplugin.c<a class="headerlink" href="#myplugin-c" title="Permalink to this headline"></a></h3>
<p>For want of a better way to describe it, myplugin.c is the vpp plugin
equivalent of “main.c”. Its job is to hook the plugin into the vpp
binary API message dispatcher, and to add its messages to vpp’s global
“message-name_crc” hash table. See “myplugin_init (…”)”</p>
<p>Vpp itself uses dlsym(…) to track down the vlib_plugin_registration_t
generated by the VLIB_PLUGIN_REGISTER macro:</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="n">VLIB_PLUGIN_REGISTER</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="n">version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">VPP_BUILD_VER</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;myplugin plugin description goes here&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="p">};</span><span class="w"></span>
</pre></div>
</div>
<p>Vpp only loads .so files from the plugin directory which contain an
instance of this data structure.</p>
<p>You can enable or disable specific vpp plugins from the command
line. By default, plugins are loaded. To change that behavior, set
default_disabled in the macro VLIB_PLUGIN_REGISTER:</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="n">VLIB_PLUGIN_REGISTER</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="n">version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">VPP_BUILD_VER</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="n">default_disabled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;myplugin plugin description goes here&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="p">};</span><span class="w"></span>
</pre></div>
</div>
<p>The boilerplate generator places the graph node dispatch function
onto the “device-input” feature arc. This may or may not be useful.</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="n">VNET_FEATURE_INIT</span><span class="w"> </span><span class="p">(</span><span class="n">myplugin</span><span class="p">,</span><span class="w"> </span><span class="k">static</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="p">.</span><span class="n">arc_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;device-input&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="p">.</span><span class="n">node_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;myplugin&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="p">.</span><span class="n">runs_before</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">VNET_FEATURES</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;ethernet-input&quot;</span><span class="p">),</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>
</pre></div>
</div>
<p>As given by the plugin generator, myplugin.c contains the binary API
message handler for a generic “please enable my feature on such and
such an interface” binary API message. As you’ll see, setting up the
vpp message API tables is simple. Big fat warning: the scheme is
intolerant of minor mistakes. Example: forgetting to add
mainp-&gt;msg_id_base can lead to very confusing failures.</p>
<p>If you stick to modifying the generated boilerplate with care -
instead of trying to build code from first principles - you’ll save
yourself a bunch of time and aggravation</p>
</section>
<section id="myplugin-test-c">
<h3>myplugin_test.c<a class="headerlink" href="#myplugin-test-c" title="Permalink to this headline"></a></h3>
<p>This file contains binary API message <strong>generation</strong> code, which is
compiled into a separate .so file. The “vpp_api_test” program loads
these plugins, yielding immediate access to your plugin APIs for
external client binary API testing.</p>
<p>vpp itself loads test plugins, and makes the code available via the
“binary-api” debug CLI. This is a favorite way to unit-test binary
APIs prior to integration testing.</p>
</section>
<section id="node-c">
<h3>node.c<a class="headerlink" href="#node-c" title="Permalink to this headline"></a></h3>
<p>This is the generated graph node dispatch function. You’ll need to
rewrite it to solve the problem at hand. It will save considerable
time and aggravation to retain the <strong>structure</strong> of the node dispatch
function.</p>
<p>Even for an expert, it’s a waste of time to reinvent the <em>loop
structure</em>, enqueue patterns, and so forth. Simply tear out and
replace the specimen 1x, 2x, 4x packet processing code with code
relevant to the problem you’re trying to solve.</p>
</section>
<section id="myplugin-api">
<h3>myplugin.api<a class="headerlink" href="#myplugin-api" title="Permalink to this headline"></a></h3>
<p>This contains the API message definition. Here we only have defined
a single one named <code class="docutils literal notranslate"><span class="pre">myplugin_enable_disable</span></code> and an implicit
<code class="docutils literal notranslate"><span class="pre">myplugin_enable_disable_reply</span></code> containing only a return value due
to the <code class="docutils literal notranslate"><span class="pre">autoreply</span></code> keyword.</p>
<p>The syntax reference for <code class="docutils literal notranslate"><span class="pre">.api</span></code> files can be found at VPP API Language</p>
<p>Addressing the binary API with this message will run the handler defined
in <code class="docutils literal notranslate"><span class="pre">myplugin.c</span></code> as <code class="docutils literal notranslate"><span class="pre">vl_api_myplugin_enable_disable_t_handler</span></code>.
It will receive a message pointer <code class="docutils literal notranslate"><span class="pre">*mp</span></code> which is the struct defined
in <code class="docutils literal notranslate"><span class="pre">myplugin.api</span></code> and should return another message pointer <code class="docutils literal notranslate"><span class="pre">*rmp</span></code>,
of the reply type. That’s what <code class="docutils literal notranslate"><span class="pre">REPLY_MACRO</span></code> does.</p>
<p>To be noted, all API messages are in net-endian and vpp is host-endian,
so you will need to use :</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">u32</span> <span class="pre">value</span> <span class="pre">=</span> <span class="pre">ntohl(mp-&gt;value);</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">rmp-&gt;value</span> <span class="pre">=</span> <span class="pre">htonl(value);</span></code></p></li>
</ul>
<p>You can now use this API with <a class="reference internal" href="../../interfacing/go/add_plugin_goapi.html#add-plugin-goapi"><span class="std std-ref">GoLang bindings</span></a></p>
</section>
<section id="myplugin-periodic-c">
<h3>myplugin_periodic.c<a class="headerlink" href="#myplugin-periodic-c" title="Permalink to this headline"></a></h3>
<p>This defines a VPP process, a routine that will run indefinitely and
be woken up intermittently, here to process plugin events.</p>
<p>To be noted, vlib_processes aren’t thread-safe, and data structures
should be locked when shared between workers.</p>
</section>
<section id="plugin-friends-with-benefits">
<h3>Plugin “Friends with Benefits”<a class="headerlink" href="#plugin-friends-with-benefits" title="Permalink to this headline"></a></h3>
<p>In vpp VLIB_INIT_FUNCTION functions, It’s reasonably common to see a
specific init function invoke other init functions:</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vlib_call_init_function</span><span class="w"> </span><span class="p">(</span><span class="n">vm</span><span class="p">,</span><span class="w"> </span><span class="n">some_other_init_function</span><span class="p">))</span><span class="w"></span>
<span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="n">error</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<p>In the case where one plugin needs to call a init function in another
plugin, use the vlib_call_plugin_init_function macro:</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vlib_call_plugin_init_function</span><span class="w"> </span><span class="p">(</span><span class="n">vm</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;otherpluginname&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">some_init_function</span><span class="p">))</span><span class="w"></span>
<span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="n">error</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<p>This allows sequencing between plugin init functions.</p>
<p>If you wish to obtain a pointer to a symbol in another plugin, use the
vlib_plugin_get_symbol(…) API:</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vlib_get_plugin_symbol</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;plugin_name&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;symbol&quot;</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="more-examples">
<h3>More Examples<a class="headerlink" href="#more-examples" title="Permalink to this headline"></a></h3>
<p>For more information you can read many example plugins in the directory “./src/plugins”.</p>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="index.html" class="btn btn-neutral float-left" title="Adding a new plugin or feature" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="sample_plugin_doc.html" class="btn btn-neutral float-right" title="Sample plugin for VPP" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2018-2021, Linux Foundation.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>