

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Graph Walks &mdash; The Vector Packet Processor 20.09 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/css/rules.css" type="text/css" />
    <link rel="author" title="About these documents" href="../../../about.html" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="The Data Plane" href="dataplane.html" />
    <link rel="prev" title="Attached Export" href="attachedexport.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> The Vector Packet Processor
          

          
            
            <img src="../../../_static/fd-io_red_white.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                20.09
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../whatisvpp/index.html">The Vector Packet Processor (VPP)</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../index.html">Getting Started</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../installing/index.html">Downloading and Installing VPP</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../progressivevpp/index.html">Progressive VPP Tutorial</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../users/index.html">For Users</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../index.html">For Developers</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../building.html">Building VPP</a></li>
<li class="toctree-l3"><a class="reference internal" href="../running_vpp.html">Running VPP</a></li>
<li class="toctree-l3"><a class="reference internal" href="../gdb_examples.html">GDB Examples</a></li>
<li class="toctree-l3"><a class="reference internal" href="../add_plugin.html">Adding a plugin</a></li>
<li class="toctree-l3"><a class="reference internal" href="../add_plugin_goapi.html">Add a plugin’s GO API</a></li>
<li class="toctree-l3"><a class="reference internal" href="../gitreview.html">Getting a Patch Reviewed</a></li>
<li class="toctree-l3"><a class="reference internal" href="../softwarearchitecture.html">Software Architecture</a></li>
<li class="toctree-l3"><a class="reference internal" href="../infrastructure.html">VPPINFRA (Infrastructure)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../vlib.html">VLIB (Vector Processing Library)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../vlib.html#packet-generator-input-script">Packet generator input script</a></li>
<li class="toctree-l3"><a class="reference internal" href="../vlib.html#start-vpp-with-2-worker-threads">Start vpp with 2 worker threads</a></li>
<li class="toctree-l3"><a class="reference internal" href="../vlib.html#enable-tracing-and-start-the-packet-generator">Enable tracing, and start the packet generator</a></li>
<li class="toctree-l3"><a class="reference internal" href="../vlib.html#sample-run">Sample Run</a></li>
<li class="toctree-l3"><a class="reference internal" href="../plugins.html">Plugins</a></li>
<li class="toctree-l3"><a class="reference internal" href="../vnet.html">VNET (VPP Network Stack)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../featurearcs.html">Feature Arcs</a></li>
<li class="toctree-l3"><a class="reference internal" href="../metadata.html">Buffer Metadata</a></li>
<li class="toctree-l3"><a class="reference internal" href="../metadata.html#buffer-metadata-extensions">Buffer Metadata Extensions</a></li>
<li class="toctree-l3"><a class="reference internal" href="../multiarch/index.html">Multi-architecture support</a></li>
<li class="toctree-l3"><a class="reference internal" href="../bihash.html">Bounded-index Extensible Hashing (bihash)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../vpp_api_module.html">VPP API module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../binary_api_support.html">Binary API Support</a></li>
<li class="toctree-l3"><a class="reference internal" href="../buildsystem/index.html">Build System</a></li>
<li class="toctree-l3"><a class="reference internal" href="../eventviewer.html">Event-logger</a></li>
<li class="toctree-l3"><a class="reference internal" href="../eventviewer.html#g2-graphical-event-viewer">G2 graphical event viewer</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="index.html">FIB 2.0 Hierarchical, Protocol, Independent</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="prerequisites.html">Prerequisites</a></li>
<li class="toctree-l4 current"><a class="reference internal" href="thedatamodel.html">The Data Model</a></li>
<li class="toctree-l4"><a class="reference internal" href="tunnels.html">Tunnels</a></li>
<li class="toctree-l4"><a class="reference internal" href="mplsfib.html">MPLS FIB</a></li>
<li class="toctree-l4"><a class="reference internal" href="multicast.html">IP Multicast FIB</a></li>
<li class="toctree-l4"><a class="reference internal" href="fastconvergence.html">Fast Convergence</a></li>
<li class="toctree-l4"><a class="reference internal" href="scale.html">Scale</a></li>
<li class="toctree-l4"><a class="reference internal" href="scale.html#ip4-heap">IP4 Heap</a></li>
<li class="toctree-l4"><a class="reference internal" href="scale.html#ip6-heap">IP6 Heap</a></li>
<li class="toctree-l4"><a class="reference internal" href="scale.html#main-heap">Main Heap</a></li>
<li class="toctree-l4"><a class="reference internal" href="scale.html#stats-heap">Stats Heap</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../buildwireshark.html">How to build a vpp dispatch trace aware Wireshark</a></li>
<li class="toctree-l3"><a class="reference internal" href="../punt.html">Punting Packets</a></li>
<li class="toctree-l3"><a class="reference internal" href="../quic_plugin.html">QUIC HostStack</a></li>
<li class="toctree-l3"><a class="reference internal" href="../cross_compile_macos.html">Cross compilation on MacOS</a></li>
<li class="toctree-l3"><a class="reference internal" href="../cnat.html">Cloud NAT</a></li>
<li class="toctree-l3"><a class="reference internal" href="../VPPAPI.html">VPP API Language    {#api_lang_doc}</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../writingdocs/index.html">Writing Documents</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../links/index.html">VPP Wiki, Doxygen and Other Links</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../usecases/index.html">Use Cases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../featuresbyrelease/index.html">Features by Release</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../troubleshooting/index.html">Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../events/index.html">Events</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../reference/index.html">Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../relatedprojects/index.html">Related Projects</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../archive/index.html">Archive</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../about.html">About</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">The Vector Packet Processor</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Getting Started</a> &raquo;</li>
        
          <li><a href="../index.html">For Developers</a> &raquo;</li>
        
          <li><a href="index.html">FIB 2.0 Hierarchical, Protocol, Independent</a> &raquo;</li>
        
          <li><a href="thedatamodel.html">The Data Model</a> &raquo;</li>
        
          <li><a href="controlplane.html">The Control Plane</a> &raquo;</li>
        
      <li>Graph Walks</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../../_sources/gettingstarted/developers/fib20/graphwalks.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="graph-walks">
<span id="graphwalks"></span><h1>Graph Walks<a class="headerlink" href="#graph-walks" title="Permalink to this headline">¶</a></h1>
<p>All FIB object types are allocated from a VPP memory pool <a class="footnote-reference brackets" href="#f13" id="id1">1</a>. The objects are thus
susceptible to memory re-allocation, therefore the use of a bare “C” pointer to refer
to a child or parent is not possible. Instead there is the concept of a <em>fib_node_ptr_t</em>
which is a tuple of type,index. The type indicates what type of object it is
(and hence which pool to use) and the index is the index in that pool. This allows
for the safe retrieval of any object type.</p>
<p>When a child resolves via a parent it does so knowing the type of that parent. The
child to parent relationship is thus fully known to the child, and hence a forward
walk of the graph (from child to parent) is trivial. However, a parent does not choose
its children, it does not even choose the type. All object types that form part of the
FIB control plane graph all inherit from a single base class14; <em>fib_node_t</em>. A <em>fib_node_t</em>
identifies the object’s index and its associated virtual function table provides the
parent a mechanism to visit that object during the walk. The reason for a back-walk
is to inform all children that the state of the parent has changed in some way, and
that the child may itself need to update.</p>
<p>To support the many to one, child to parent, relationship a parent must maintain a
list of its children. The requirements of this list are;</p>
<ul class="simple">
<li><p>O(1) insertion and delete time. Several child-parent relationships are made/broken during route addition/deletion.</p></li>
<li><p>Ordering. High priority children are at the front, low priority at the back (see section Fast Convergence)</p></li>
<li><p>Insertion at arbitrary locations.</p></li>
</ul>
<p>To realise these requirements the child-list is a doubly linked-list, where each element
contains a <em>fib_node_ptr_t</em>. The VPP pool memory model applies to the list elements, so
they are also identified by an index. When a child is added to a list it is returned the
index of the element. Using this index the element can be removed in constant time.
The list supports ‘push-front’ and ‘push-back’ semantics for ordering. To walk the children
of a parent is then to iterate of this list.</p>
<p>A back-walk of the graph is a depth first search where all children in all levels of the
hierarchy are visited. Such walks can therefore encounter all object instances in the
FIB control plane graph, numbering in the millions. A FIB control-plane graph is cyclic
in the presence of a recursion loop, so the walk implementation has mechanisms to detect
this and exit early.</p>
<p>A back-walk can be either synchronous or asynchronous. A synchronous walk will visit the
entire section of the graph before control is returned to the caller, an asynchronous
walk will queue the walk to a background process, to run at a later time, and immediately
return to the caller. To implement asynchronous walks a <em>fib_walk_t</em> object it added to
the front of the parent’s child list. As children are visited the <em>fib_walk_t</em> object
advances through the list. Since it is inserted in the list, when the walk suspends
and resumes, it can continue at the correct location. It is also safe with respect to
the deletion of children from the list. New children are added to the head of the list,
and so will not encounter the walk, but since they are new, they already have the up to
date state of the parent.</p>
<p>A VLIB process ‘fib-walk’ runs to perform the asynchronous walks. VLIB has no priority
scheduling between respective processes, so the fib-walk process does work in small
increments so it does not block the main route download process. Since the main download
process effectively has priority numerous asynchronous back-walks can be started on the
same parent instance before the fib-walk process can run. FIB is a ‘final state’ application.
If a parent changes n times, it is not necessary for the children to also update n
times, instead it is only necessary that this child updates to the latest, or final,
state. Consequently when multiple walks on a parent (and hence potential updates to a
child) are queued, these walks can be merged into a single walk.</p>
<p>Choosing between a synchronous and an asynchronous walk is therefore a trade-off between
time it takes to propagate a change in the parent to all of its children, versus the
time it takes to act on a single route update. For example, if a route update where to
affect millions of child recursive routes, then the rate at which such updates could be
processed would be dependent on the number of child recursive route which would not be
good. At the time of writing FIB2.0 uses synchronous walk in all locations except when
walking the children of a path-list, and it has more than 32 <a class="footnote-reference brackets" href="#f15" id="id2">3</a> children. This avoids the
case mentioned above.</p>
<p class="rubric">Footnotes:</p>
<dl class="footnote brackets">
<dt class="label" id="f13"><span class="brackets"><a class="fn-backref" href="#id1">1</a></span></dt>
<dd><p>Fast memory allocation is crucial to fast route update times.</p>
</dd>
<dt class="label" id="f14"><span class="brackets">2</span></dt>
<dd><p>VPP may be written in C and not C++ but inheritance is still possible.</p>
</dd>
<dt class="label" id="f15"><span class="brackets"><a class="fn-backref" href="#id2">3</a></span></dt>
<dd><p>The value is arbitrary and yet to be tuned.</p>
</dd>
</dl>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="dataplane.html" class="btn btn-neutral float-right" title="The Data Plane" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="attachedexport.html" class="btn btn-neutral float-left" title="Attached Export" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018-2020, Linux Foundation

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>