<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Load Balancer plugin &mdash; The Vector Packet Processor v22.02-rc0-128-g4450b03ba
 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/rules.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="LACP Protocol" href="lacp.html" />
    <link rel="prev" title="PNAT 1:1 match &amp; rewrite NAT" href="pnat.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> The Vector Packet Processor
            <img src="../../_static/fd-io_red_white.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                v22.02-rc0-128-g4450b03ba

              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">About VPP</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../aboutvpp/scalar-vs-vector-packet-processing.html">Scalar vs Vector packet processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../aboutvpp/extensible.html">The Packet Processing Graph</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../aboutvpp/networkstack.html">Network Stack Features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../aboutvpp/hoststack.html">Host Stack</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../aboutvpp/developer.html">Additional features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../aboutvpp/supported.html">Supported archs and OS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../aboutvpp/performance.html">Performance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../aboutvpp/releasenotes/index.html">Release notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../aboutvpp/featurelist.html">VPP Supported Features</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Use Cases</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../usecases/containers/index.html">VPP with Containers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usecases/simpleperf/index.html">VPP with Iperf3 and TRex</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usecases/vppcloud/index.html">VPP in the Cloud</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usecases/vhost/index.html">VPP with Virtual Machines</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usecases/vmxnet3.html">VPP with VMware/Vmxnet3</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usecases/home_gateway.html">VPP as a Home Gateway</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usecases/acls.html">Access Control Lists with VPP</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usecases/networksim.html">Generating traffic with VPP</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usecases/webapp.html">Web applications with VPP</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usecases/container_test.html">Simulating networks with VPP</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usecases/trafficgen.html">Stateless Traffic Gen with VPP</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usecases/ikev2/index.html">IKEv2 with VPP</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usecases/contiv/index.html">VPP in kubernetes (Contiv/Deprecated)</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Getting started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../gettingstarted/installing/index.html">Downloading and Installing VPP</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../gettingstarted/running/index.html">Running VPP</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../gettingstarted/progressivevpp/index.html">Progressive VPP Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../gettingstarted/troubleshooting/index.html">Troubleshooting</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developer Documentation</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../build-run-debug/index.html">Build, Run &amp; Debug</a></li>
<li class="toctree-l1"><a class="reference internal" href="../corearchitecture/index.html">Core Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../corefeatures/index.html">Core Features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../plugindoc/index.html">Adding a new plugin or feature</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Plugins</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="quic.html">QUIC HostStack</a></li>
<li class="toctree-l2"><a class="reference internal" href="cnat.html">Cloud NAT</a></li>
<li class="toctree-l2"><a class="reference internal" href="lcp.html">Linux Control Plane Integration</a></li>
<li class="toctree-l2"><a class="reference internal" href="srv6/index.html">SRv6 Plugins</a></li>
<li class="toctree-l2"><a class="reference internal" href="marvell.html">Marvell device plugin</a></li>
<li class="toctree-l2"><a class="reference internal" href="lldp.html">LLDP Protocol</a></li>
<li class="toctree-l2"><a class="reference internal" href="nat64.html">Stateful NAT64</a></li>
<li class="toctree-l2"><a class="reference internal" href="nat44_ei_ha.html">Active-Passive NAT HA</a></li>
<li class="toctree-l2"><a class="reference internal" href="pnat.html">PNAT 1:1 match &amp; rewrite NAT</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Load Balancer plugin</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#version">Version</a></li>
<li class="toctree-l3"><a class="reference internal" href="#overview">Overview</a></li>
<li class="toctree-l3"><a class="reference internal" href="#performance">Performance</a></li>
<li class="toctree-l3"><a class="reference internal" href="#configuration">Configuration</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#global-lb-parameters">Global LB parameters</a></li>
<li class="toctree-l4"><a class="reference internal" href="#configure-the-vips">Configure the VIPs</a></li>
<li class="toctree-l4"><a class="reference internal" href="#configure-the-ass-for-each-vip">Configure the ASs (for each VIP)</a></li>
<li class="toctree-l4"><a class="reference internal" href="#configure-snat">Configure SNAT</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#monitoring">Monitoring</a></li>
<li class="toctree-l3"><a class="reference internal" href="#design-notes">Design notes</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#multi-threading">Multi-Threading</a></li>
<li class="toctree-l4"><a class="reference internal" href="#hash-table">Hash Table</a></li>
<li class="toctree-l4"><a class="reference internal" href="#reference-counting">Reference counting</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="lacp.html">LACP Protocol</a></li>
<li class="toctree-l2"><a class="reference internal" href="flowprobe.html">IPFIX flow record plugin</a></li>
<li class="toctree-l2"><a class="reference internal" href="map_lw4o6.html">MAP and Lw4o6</a></li>
<li class="toctree-l2"><a class="reference internal" href="mdata.html">Buffer metadata change tracker</a></li>
<li class="toctree-l2"><a class="reference internal" href="dhcp6_pd.html">DHCPv6 prefix delegation</a></li>
<li class="toctree-l2"><a class="reference internal" href="ioam.html">Inband OAM (iOAM)</a></li>
<li class="toctree-l2"><a class="reference internal" href="wireguard.html">Wireguard vpp-plugin</a></li>
<li class="toctree-l2"><a class="reference internal" href="srtp.html">SRTP Protocol</a></li>
<li class="toctree-l2"><a class="reference internal" href="acl_multicore.html">Multicore support for ACL plugin</a></li>
<li class="toctree-l2"><a class="reference internal" href="acl_hash_lookup.html">ACL plugin constant-time lookup</a></li>
<li class="toctree-l2"><a class="reference internal" href="acl_lookup_context.html">ACL Lookup contexts</a></li>
<li class="toctree-l2"><a class="reference internal" href="bufmon_doc.html">Buffers monitoring plugin</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../devicedrivers/index.html">Device drivers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tests/overview.html">VPP Test Framework</a></li>
<li class="toctree-l1"><a class="reference internal" href="../extras/index.html">VPP extra tools</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Interfacing with VPP</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../interfacing/binapi/index.html">The binary API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../interfacing/c/index.html">C api client</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../interfacing/cpp/index.html">C++ api client</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../interfacing/go/index.html">Go api (govpp)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../interfacing/rust/index.html">Rust api client</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../interfacing/libmemif/index.html">Memif library (libmemif)</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Contributing</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../contributing/gitreview.html">Getting a Patch Reviewed</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contributing/writingdocs.html">Writing VPP Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contributing/reportingissues/index.html">Reporting Bugs</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Debug CLI</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../cli-reference/gettingstarted/index.html">Getting Started with the debug CLI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cli-reference/interface/index.html">Interface Commands</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cli-reference/index.html">Reference</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Configuration file</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../configuration/config_getting_started.html">Getting started with the configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../configuration/reference.html">Configuration Reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">The Vector Packet Processor</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="index.html">Plugins</a> &raquo;</li>
      <li>Load Balancer plugin</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/developer/plugins/lb.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="load-balancer-plugin">
<h1>Load Balancer plugin<a class="headerlink" href="#load-balancer-plugin" title="Permalink to this headline"></a></h1>
<section id="version">
<h2>Version<a class="headerlink" href="#version" title="Permalink to this headline"></a></h2>
<p>The load balancer plugin is currently in <em>beta</em> version. Both CLIs and
APIs are subject to <em>heavy</em> changes, which also means feedback is really
welcome regarding features, apis, etc…</p>
</section>
<section id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline"></a></h2>
<p>This plugin provides load balancing for VPP in a way that is largely
inspired from Google’s MagLev:
<a class="reference external" href="http://research.google.com/pubs/pub44824.html">http://research.google.com/pubs/pub44824.html</a></p>
<p>The load balancer is configured with a set of Virtual IPs (VIP, which
can be prefixes), and for each VIP, with a set of Application Server
addresses (ASs).</p>
<p>There are four encap types to steer traffic to different ASs: 1).
IPv4+GRE ad IPv6+GRE encap types: Traffic received for a given VIP (or
VIP prefix) is tunneled using GRE towards the different ASs in a way
that (tries to) ensure that a given session will always be tunneled to
the same AS.</p>
<p>2). IPv4+L3DSR encap types: L3DSR is used to overcome Layer 2
limitations of Direct Server Return Load Balancing. It maps VIP to DSCP
bits, and reuse TOS bits to transfer DSCP bits to server, and then
server will get VIP from DSCP-to-VIP mapping.</p>
<p>Both VIPs or ASs can be IPv4 or IPv6, but for a given VIP, all ASs must
be using the same encap. type (i.e. IPv4+GRE or IPv6+GRE or IPv4+L3DSR).
Meaning that for a given VIP, all AS addresses must be of the same
family.</p>
<p>3). IPv4/IPv6 + NAT4/NAT6 encap types: This type provides kube-proxy
data plane on user space, which is used to replace linux kernel’s
kube-proxy based on iptables.</p>
<p>Currently, load balancer plugin supports three service types: a) Cluster
IP plus Port: support any protocols, including TCP, UDP. b) Node IP plus
Node Port: currently only support UDP. c) External Load Balancer.</p>
<p>For Cluster IP plus Port case: kube-proxy is configured with a set of
Virtual IPs (VIP, which can be prefixes), and for each VIP, with a set
of AS addresses (ASs).</p>
<p>For a specific session received for a given VIP (or VIP prefix), first
packet selects a AS according to internal load balancing algorithm, then
does DNAT operation and sent to chosen AS. At the same time, will create
a session entry to store AS chosen result. Following packets for that
session will look up session table first, which ensures that a given
session will always be routed to the same AS.</p>
<p>For returned packet from AS, it will do SNAT operation and sent out.</p>
<p>Please refer to below for details:
<a class="reference external" href="https://schd.ws/hosted_files/ossna2017/1e/VPP_K8S_GTPU_OSSNA.pdf">https://schd.ws/hosted_files/ossna2017/1e/VPP_K8S_GTPU_OSSNA.pdf</a></p>
</section>
<section id="performance">
<h2>Performance<a class="headerlink" href="#performance" title="Permalink to this headline"></a></h2>
<p>The load balancer has been tested up to 1 millions flows and still
forwards more than 3Mpps per core in such circumstances. Although 3Mpps
seems already good, it is likely that performance will be improved in
next versions.</p>
</section>
<section id="configuration">
<h2>Configuration<a class="headerlink" href="#configuration" title="Permalink to this headline"></a></h2>
<section id="global-lb-parameters">
<h3>Global LB parameters<a class="headerlink" href="#global-lb-parameters" title="Permalink to this headline"></a></h3>
<p>The load balancer needs to be configured with some parameters:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">lb</span> <span class="n">conf</span> <span class="p">[</span><span class="n">ip4</span><span class="o">-</span><span class="n">src</span><span class="o">-</span><span class="n">address</span> <span class="o">&lt;</span><span class="n">addr</span><span class="o">&gt;</span><span class="p">]</span> <span class="p">[</span><span class="n">ip6</span><span class="o">-</span><span class="n">src</span><span class="o">-</span><span class="n">address</span> <span class="o">&lt;</span><span class="n">addr</span><span class="o">&gt;</span><span class="p">]</span>
        <span class="p">[</span><span class="n">buckets</span> <span class="o">&lt;</span><span class="n">n</span><span class="o">&gt;</span><span class="p">]</span> <span class="p">[</span><span class="n">timeout</span> <span class="o">&lt;</span><span class="n">s</span><span class="o">&gt;</span><span class="p">]</span>
</pre></div>
</div>
<p>ip4-src-address: the source address used to send encap. packets using
IPv4 for GRE4 mode. or Node IP4 address for NAT4 mode.</p>
<p>ip6-src-address: the source address used to send encap. packets using
IPv6 for GRE6 mode. or Node IP6 address for NAT6 mode.</p>
<p>buckets: the <em>per-thread</em> established-connections-table number of
buckets.</p>
<p>timeout: the number of seconds a connection will remain in the
established-connections-table while no packet for this flow is received.</p>
</section>
<section id="configure-the-vips">
<h3>Configure the VIPs<a class="headerlink" href="#configure-the-vips" title="Permalink to this headline"></a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">lb</span> <span class="n">vip</span> <span class="o">&lt;</span><span class="n">prefix</span><span class="o">&gt;</span> <span class="p">[</span><span class="n">encap</span> <span class="p">(</span><span class="n">gre6</span><span class="o">|</span><span class="n">gre4</span><span class="o">|</span><span class="n">l3dsr</span><span class="o">|</span><span class="n">nat4</span><span class="o">|</span><span class="n">nat6</span><span class="p">)]</span> \
  <span class="p">[</span><span class="n">dscp</span> <span class="o">&lt;</span><span class="n">n</span><span class="o">&gt;</span><span class="p">]</span> <span class="p">[</span><span class="n">port</span> <span class="o">&lt;</span><span class="n">n</span><span class="o">&gt;</span> <span class="n">target_port</span> <span class="o">&lt;</span><span class="n">n</span><span class="o">&gt;</span> <span class="n">node_port</span> <span class="o">&lt;</span><span class="n">n</span><span class="o">&gt;</span><span class="p">]</span> <span class="p">[</span><span class="n">new_len</span> <span class="o">&lt;</span><span class="n">n</span><span class="o">&gt;</span><span class="p">]</span> <span class="p">[</span><span class="k">del</span><span class="p">]</span>
</pre></div>
</div>
<p>new_len is the size of the new-connection-table. It should be 1 or 2
orders of magnitude bigger than the number of ASs for the VIP in order
to ensure a good load balancing. Encap l3dsr and dscp is used to map VIP
to dscp bit and rewrite DSCP bit in packets. So the selected server
could get VIP from DSCP bit in this packet and perform DSR. Encap
nat4/nat6 and port/target_port/node_port is used to do kube-proxy data
plane.</p>
<p>Examples:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">lb</span> <span class="n">vip</span> <span class="mi">2002</span><span class="p">::</span><span class="o">/</span><span class="mi">16</span> <span class="n">encap</span> <span class="n">gre6</span> <span class="n">new_len</span> <span class="mi">1024</span>
<span class="n">lb</span> <span class="n">vip</span> <span class="mi">2003</span><span class="p">::</span><span class="o">/</span><span class="mi">16</span> <span class="n">encap</span> <span class="n">gre4</span> <span class="n">new_len</span> <span class="mi">2048</span>
<span class="n">lb</span> <span class="n">vip</span> <span class="mf">80.0.0.0</span><span class="o">/</span><span class="mi">8</span> <span class="n">encap</span> <span class="n">gre6</span> <span class="n">new_len</span> <span class="mi">16</span>
<span class="n">lb</span> <span class="n">vip</span> <span class="mf">90.0.0.0</span><span class="o">/</span><span class="mi">8</span> <span class="n">encap</span> <span class="n">gre4</span> <span class="n">new_len</span> <span class="mi">1024</span>
<span class="n">lb</span> <span class="n">vip</span> <span class="mf">100.0.0.0</span><span class="o">/</span><span class="mi">8</span> <span class="n">encap</span> <span class="n">l3dsr</span> <span class="n">dscp</span> <span class="mi">2</span> <span class="n">new_len</span> <span class="mi">32</span>
<span class="n">lb</span> <span class="n">vip</span> <span class="mf">90.1.2.1</span><span class="o">/</span><span class="mi">32</span> <span class="n">encap</span> <span class="n">nat4</span> <span class="n">port</span> <span class="mi">3306</span> <span class="n">target_port</span> <span class="mi">3307</span> <span class="n">node_port</span> <span class="mi">30964</span> <span class="n">new_len</span> <span class="mi">1024</span>
<span class="n">lb</span> <span class="n">vip</span> <span class="mi">2004</span><span class="p">::</span><span class="o">/</span><span class="mi">16</span> <span class="n">encap</span> <span class="n">nat6</span> <span class="n">port</span> <span class="mi">6306</span> <span class="n">target_port</span> <span class="mi">6307</span> <span class="n">node_port</span> <span class="mi">30966</span> <span class="n">new_len</span> <span class="mi">1024</span>
</pre></div>
</div>
</section>
<section id="configure-the-ass-for-each-vip">
<h3>Configure the ASs (for each VIP)<a class="headerlink" href="#configure-the-ass-for-each-vip" title="Permalink to this headline"></a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">lb</span> <span class="k">as</span> <span class="o">&lt;</span><span class="n">vip</span><span class="o">-</span><span class="n">prefix</span><span class="o">&gt;</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">address</span><span class="o">&gt;</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">address</span><span class="o">&gt;</span> <span class="p">[</span><span class="o">...</span><span class="p">]]]</span> <span class="p">[</span><span class="k">del</span><span class="p">]</span>
</pre></div>
</div>
<p>You can add (or delete) as many ASs at a time (for a single VIP). Note
that the AS address family must correspond to the VIP encap. IP family.</p>
<p>Examples:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">lb</span> <span class="k">as</span> <span class="mi">2002</span><span class="p">::</span><span class="o">/</span><span class="mi">16</span> <span class="mi">2001</span><span class="p">::</span><span class="mi">2</span> <span class="mi">2001</span><span class="p">::</span><span class="mi">3</span> <span class="mi">2001</span><span class="p">::</span><span class="mi">4</span>
<span class="n">lb</span> <span class="k">as</span> <span class="mi">2003</span><span class="p">::</span><span class="o">/</span><span class="mi">16</span> <span class="mf">10.0.0.1</span> <span class="mf">10.0.0.2</span>
<span class="n">lb</span> <span class="k">as</span> <span class="mf">80.0.0.0</span><span class="o">/</span><span class="mi">8</span> <span class="mi">2001</span><span class="p">::</span><span class="mi">2</span>
<span class="n">lb</span> <span class="k">as</span> <span class="mf">90.0.0.0</span><span class="o">/</span><span class="mi">8</span> <span class="mf">10.0.0.1</span>
</pre></div>
</div>
</section>
<section id="configure-snat">
<h3>Configure SNAT<a class="headerlink" href="#configure-snat" title="Permalink to this headline"></a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">lb</span> <span class="nb">set</span> <span class="n">interface</span> <span class="n">nat4</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">intfc</span><span class="o">&gt;</span> <span class="p">[</span><span class="k">del</span><span class="p">]</span>
</pre></div>
</div>
<p>Set SNAT feature in a specific interface. (applicable in NAT4 mode only)</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">lb</span> <span class="nb">set</span> <span class="n">interface</span> <span class="n">nat6</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">intfc</span><span class="o">&gt;</span> <span class="p">[</span><span class="k">del</span><span class="p">]</span>
</pre></div>
</div>
<p>Set SNAT feature in a specific interface. (applicable in NAT6 mode only)</p>
</section>
</section>
<section id="monitoring">
<h2>Monitoring<a class="headerlink" href="#monitoring" title="Permalink to this headline"></a></h2>
<p>The plugin provides quite a bunch of counters and information. These are
still subject to quite significant changes.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">show</span> <span class="n">lb</span>
<span class="n">show</span> <span class="n">lb</span> <span class="n">vip</span>
<span class="n">show</span> <span class="n">lb</span> <span class="n">vip</span> <span class="n">verbose</span>

<span class="n">show</span> <span class="n">node</span> <span class="n">counters</span>
</pre></div>
</div>
</section>
<section id="design-notes">
<h2>Design notes<a class="headerlink" href="#design-notes" title="Permalink to this headline"></a></h2>
<section id="multi-threading">
<h3>Multi-Threading<a class="headerlink" href="#multi-threading" title="Permalink to this headline"></a></h3>
<p>MagLev is a distributed system which pseudo-randomly generates a
new-connections-table based on AS names such that each server configured
with the same set of ASs ends up with the same table. Connection
stickiness is then ensured with an established-connections-table. Using
ECMP, it is assumed (but not relied on) that servers will mostly receive
traffic for different flows.</p>
<p>This implementation pushes the parallelism a little bit further by using
one established-connections table per thread. This is equivalent to
assuming that RSS will make a job similar to ECMP, and is pretty useful
as threads don’t need to get a lock in order to write in the table.</p>
</section>
<section id="hash-table">
<h3>Hash Table<a class="headerlink" href="#hash-table" title="Permalink to this headline"></a></h3>
<p>A load balancer requires an efficient read and write hash table. The
hash table used by ip6-forward is very read-efficient, but not so much
for writing. In addition, it is not a big deal if writing into the hash
table fails (again, MagLev uses a flow table but does not heavily
relies on it).</p>
<p>The plugin therefore uses a very specific (and stupid) hash table. -
Fixed (and power of 2) number of buckets (configured at runtime) - Fixed
(and power of 2) elements per buckets (configured at compilation time)</p>
</section>
<section id="reference-counting">
<h3>Reference counting<a class="headerlink" href="#reference-counting" title="Permalink to this headline"></a></h3>
<p>When an AS is removed, there is two possible ways to react. - Keep using
the AS for established connections - Change AS for established
connections (likely to cause error for TCP)</p>
<p>In the first case, although an AS is removed from the configuration, its
associated state needs to stay around as long as it is used by at least
one thread.</p>
<p>In order to avoid locks, a specific reference counter is used. The
design is quite similar to clib counters but: - It is possible to
decrease the value - Summing will not zero the per-thread counters -
Only the thread can reallocate its own counters vector (to avoid
concurrency issues)</p>
<p>This reference counter is lock free, but reading a count of 0 does not
mean the value can be freed unless it is ensured by <em>other</em> means that
no other thread is concurrently referencing the object. In the case of
this plugin, it is assumed that no concurrent event will take place
after a few seconds.</p>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="pnat.html" class="btn btn-neutral float-left" title="PNAT 1:1 match &amp; rewrite NAT" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="lacp.html" class="btn btn-neutral float-right" title="LACP Protocol" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2018-2021, Linux Foundation.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>