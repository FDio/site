<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>VPP Test Framework &mdash; The Vector Packet Processor v22.02-rc0-128-g4450b03ba
 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/rules.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="VPP extra tools" href="../extras/index.html" />
    <link rel="prev" title="AF_XDP device driver" href="../devicedrivers/af_xdp.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> The Vector Packet Processor
            <img src="../../_static/fd-io_red_white.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                v22.02-rc0-128-g4450b03ba

              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">About VPP</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../aboutvpp/scalar-vs-vector-packet-processing.html">Scalar vs Vector packet processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../aboutvpp/extensible.html">The Packet Processing Graph</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../aboutvpp/networkstack.html">Network Stack Features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../aboutvpp/hoststack.html">Host Stack</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../aboutvpp/developer.html">Additional features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../aboutvpp/supported.html">Supported archs and OS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../aboutvpp/performance.html">Performance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../aboutvpp/releasenotes/index.html">Release notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../aboutvpp/featurelist.html">VPP Supported Features</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Use Cases</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../usecases/containers/index.html">VPP with Containers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usecases/simpleperf/index.html">VPP with Iperf3 and TRex</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usecases/vppcloud/index.html">VPP in the Cloud</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usecases/vhost/index.html">VPP with Virtual Machines</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usecases/vmxnet3.html">VPP with VMware/Vmxnet3</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usecases/home_gateway.html">VPP as a Home Gateway</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usecases/acls.html">Access Control Lists with VPP</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usecases/networksim.html">Generating traffic with VPP</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usecases/webapp.html">Web applications with VPP</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usecases/container_test.html">Simulating networks with VPP</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usecases/trafficgen.html">Stateless Traffic Gen with VPP</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usecases/ikev2/index.html">IKEv2 with VPP</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usecases/contiv/index.html">VPP in kubernetes (Contiv/Deprecated)</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Getting started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../gettingstarted/installing/index.html">Downloading and Installing VPP</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../gettingstarted/running/index.html">Running VPP</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../gettingstarted/progressivevpp/index.html">Progressive VPP Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../gettingstarted/troubleshooting/index.html">Troubleshooting</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developer Documentation</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../build-run-debug/index.html">Build, Run &amp; Debug</a></li>
<li class="toctree-l1"><a class="reference internal" href="../corearchitecture/index.html">Core Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../corefeatures/index.html">Core Features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../plugindoc/index.html">Adding a new plugin or feature</a></li>
<li class="toctree-l1"><a class="reference internal" href="../plugins/index.html">Plugins</a></li>
<li class="toctree-l1"><a class="reference internal" href="../devicedrivers/index.html">Device drivers</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">VPP Test Framework</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#overview">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="#anatomy-of-a-test-case">Anatomy of a test case</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id1">Logging</a></li>
<li class="toctree-l2"><a class="reference internal" href="#parallel-test-execution">Parallel test execution</a></li>
<li class="toctree-l2"><a class="reference internal" href="#test-temporary-directory-and-vpp-life-cycle">Test temporary directory and VPP life cycle</a></li>
<li class="toctree-l2"><a class="reference internal" href="#virtual-environment">Virtual environment</a></li>
<li class="toctree-l2"><a class="reference internal" href="#naming-conventions">Naming conventions</a></li>
<li class="toctree-l2"><a class="reference internal" href="#automatically-generated-addresses">Automatically generated addresses</a></li>
<li class="toctree-l2"><a class="reference internal" href="#packet-flow-in-the-vtf">Packet flow in the VPP Test Framework</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#test-framework-vpp">Test framework -&gt; VPP</a></li>
<li class="toctree-l3"><a class="reference internal" href="#vpp-test-framework">VPP -&gt; test framework</a></li>
<li class="toctree-l3"><a class="reference internal" href="#automatic-filtering-of-packets">Automatic filtering of packets:</a></li>
<li class="toctree-l3"><a class="reference internal" href="#common-api-flow-for-sending-receiving-packets">Common API flow for sending/receiving packets:</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#test-framework-objects">Test framework objects</a></li>
<li class="toctree-l2"><a class="reference internal" href="#how-vpp-apis-clis-are-called">How VPP APIs/CLIs are called</a></li>
<li class="toctree-l2"><a class="reference internal" href="#utility-methods">Utility methods</a></li>
<li class="toctree-l2"><a class="reference internal" href="#example-how-to-add-a-new-test">Example: how to add a new test</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../extras/index.html">VPP extra tools</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Interfacing with VPP</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../interfacing/binapi/index.html">The binary API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../interfacing/c/index.html">C api client</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../interfacing/cpp/index.html">C++ api client</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../interfacing/go/index.html">Go api (govpp)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../interfacing/rust/index.html">Rust api client</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../interfacing/libmemif/index.html">Memif library (libmemif)</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Contributing</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../contributing/gitreview.html">Getting a Patch Reviewed</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contributing/writingdocs.html">Writing VPP Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contributing/reportingissues/index.html">Reporting Bugs</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Debug CLI</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../cli-reference/gettingstarted/index.html">Getting Started with the debug CLI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cli-reference/interface/index.html">Interface Commands</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cli-reference/index.html">Reference</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Configuration file</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../configuration/config_getting_started.html">Getting started with the configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../configuration/reference.html">Configuration Reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">The Vector Packet Processor</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
      <li>VPP Test Framework</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/developer/tests/overview.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="vtf">
<h1>VPP Test Framework<a class="headerlink" href="#vtf" title="Permalink to this headline"></a></h1>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#overview" id="id2">Overview</a></p></li>
<li><p><a class="reference internal" href="#anatomy-of-a-test-case" id="id3">Anatomy of a test case</a></p></li>
<li><p><a class="reference internal" href="#id1" id="id4">Logging</a></p></li>
<li><p><a class="reference internal" href="#parallel-test-execution" id="id5">Parallel test execution</a></p></li>
<li><p><a class="reference internal" href="#test-temporary-directory-and-vpp-life-cycle" id="id6">Test temporary directory and VPP life cycle</a></p></li>
<li><p><a class="reference internal" href="#virtual-environment" id="id7">Virtual environment</a></p></li>
<li><p><a class="reference internal" href="#naming-conventions" id="id8">Naming conventions</a></p></li>
<li><p><a class="reference internal" href="#automatically-generated-addresses" id="id9">Automatically generated addresses</a></p></li>
<li><p><a class="reference internal" href="#packet-flow-in-the-vtf" id="id10">Packet flow in the VPP Test Framework</a></p></li>
<li><p><a class="reference internal" href="#test-framework-objects" id="id11">Test framework objects</a></p></li>
<li><p><a class="reference internal" href="#how-vpp-apis-clis-are-called" id="id12">How VPP APIs/CLIs are called</a></p></li>
<li><p><a class="reference internal" href="#utility-methods" id="id13">Utility methods</a></p></li>
<li><p><a class="reference internal" href="#example-how-to-add-a-new-test" id="id14">Example: how to add a new test</a></p></li>
</ul>
</div>
<section id="overview">
<h2><a class="toc-backref" href="#id2">Overview</a><a class="headerlink" href="#overview" title="Permalink to this headline"></a></h2>
<p>The goal of the VPP Test Framework is to ease writing, running and debugging
unit tests for the VPP. For this, python was chosen as a high level language
allowing rapid development with <a class="reference external" href="http://www.secdev.org/projects/scapy/">scapy</a> providing the necessary tool for creating
and dissecting packets.</p>
</section>
<section id="anatomy-of-a-test-case">
<h2><a class="toc-backref" href="#id3">Anatomy of a test case</a><a class="headerlink" href="#anatomy-of-a-test-case" title="Permalink to this headline"></a></h2>
<p>Python’s <a class="reference external" href="https://docs.python.org/2/library/unittest.html">unittest</a> is used as the base framework upon which the VPP test
framework is built. A test suite in the VPP Test Framework consists of multiple classes
derived from <cite>VppTestCase</cite>, which is itself derived from <a class="reference external" href="https://docs.python.org/2/library/unittest.html#unittest.TestCase">TestCase</a>.
The test class defines one or more test functions, which act as test cases.</p>
<p>Function flow when running a test case is:</p>
<ol class="arabic simple">
<li><p><cite>setUpClass &lt;VppTestCase.setUpClass&gt;</cite>:
This function is called once for each test class, allowing a one-time test
setup to be executed. If this functions throws an exception,
none of the test functions are executed.</p></li>
<li><p><cite>setUp &lt;VppTestCase.setUp&gt;</cite>:
The setUp function runs before each of the test functions. If this function
throws an exception other than <a class="reference external" href="https://docs.python.org/2/library/exceptions.html#exceptions.AssertionError">AssertionError</a> or <a class="reference external" href="https://docs.python.org/2/library/unittest.html#unittest.SkipTest">SkipTest</a>, then this is
considered an error, not a test failure.</p></li>
<li><p><em>test_&lt;name&gt;</em>:
This is the guts of the test case. It should execute the test scenario
and use the various assert functions from the unittest framework to check
necessary. Multiple test_&lt;name&gt; methods can exist in a test case.</p></li>
<li><p><cite>tearDown &lt;VppTestCase.tearDown&gt;</cite>:
The tearDown function is called after each test function with the purpose
of doing partial cleanup.</p></li>
<li><p><cite>tearDownClass &lt;VppTestCase.tearDownClass&gt;</cite>:
Method called once after running all of the test functions to perform
the final cleanup.</p></li>
</ol>
</section>
<section id="id1">
<h2><a class="toc-backref" href="#id4">Logging</a><a class="headerlink" href="#id1" title="Permalink to this headline"></a></h2>
<p>Each test case has a logger automatically created for it, stored in
‘logger’ property, based on <a class="reference external" href="https://docs.python.org/2/library/logging.html">logging</a>. Use the logger’s standard methods
debug(), info(), error(), … to emit log messages to the logger.</p>
<p>All the log messages go always into a log file in temporary directory
(see below).</p>
<p>To control the messages printed to console, specify the V= parameter.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>make <span class="nb">test</span>         <span class="c1"># minimum verbosity</span>
make <span class="nb">test</span> <span class="nv">V</span><span class="o">=</span><span class="m">1</span>     <span class="c1"># moderate verbosity</span>
make <span class="nb">test</span> <span class="nv">V</span><span class="o">=</span><span class="m">2</span>     <span class="c1"># maximum verbosity</span>
</pre></div>
</div>
</section>
<section id="parallel-test-execution">
<h2><a class="toc-backref" href="#id5">Parallel test execution</a><a class="headerlink" href="#parallel-test-execution" title="Permalink to this headline"></a></h2>
<p>VPP Test Framework test suites can be run in parallel. Each test suite is executed
in a separate process spawned by Python multiprocessing <a class="reference external" href="https://docs.python.org/2/library/multiprocessing.html#the-process-class">process</a>.</p>
<p>The results from child test suites are sent to parent through <a class="reference external" href="https://docs.python.org/2/library/multiprocessing.html#multiprocessing.Pipe">pipes</a>, which are
aggregated and summarized at the end of the run.</p>
<p>Stdout, stderr and logs logged in child processes are redirected to individual
parent <a class="reference external" href="https://docs.python.org/2/library/multiprocessing.html#managers">managed</a> queues. The data from these queues are then emitted to stdout
of the parent process in the order the test suites have finished. In case there
are no finished test suites (such as at the beginning of the run), the data
from last started test suite are emitted in real time.</p>
<p>To enable parallel test run, specify the number of parallel processes:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>make <span class="nb">test</span> <span class="nv">TEST_JOBS</span><span class="o">=</span>n       <span class="c1"># at most n processes will be spawned</span>
make <span class="nb">test</span> <span class="nv">TEST_JOBS</span><span class="o">=</span>auto    <span class="c1"># chosen based on the number of cores</span>
                            <span class="c1"># and the size of shared memory</span>
</pre></div>
</div>
</section>
<section id="test-temporary-directory-and-vpp-life-cycle">
<h2><a class="toc-backref" href="#id6">Test temporary directory and VPP life cycle</a><a class="headerlink" href="#test-temporary-directory-and-vpp-life-cycle" title="Permalink to this headline"></a></h2>
<p>Test separation is achieved by separating the test files and vpp instances.
Each test creates a temporary directory and it’s name is used to create
a shared memory prefix which is used to run a VPP instance.
The temporary directory name contains the testcase class name for easy
reference, so for testcase named ‘TestVxlan’ the directory could be named
e.g. vpp-unittest-TestVxlan-UNUP3j.
This way, there is no conflict between any other VPP instances running
on the box and the test VPP. Any temporary files created by the test case
are stored in this temporary test directory.</p>
<p>The test temporary directory holds the following interesting files:</p>
<ul class="simple">
<li><p>log.txt - this contains the logger output on max verbosity</p></li>
<li><p>pg*_in.pcap - last injected packet stream into VPP, named after the interface,
so for pg0, the file will be named pg0_in.pcap</p></li>
<li><p>pg*_out.pcap - last capture file created by VPP for interface, similarly,
named after the interface, so for e.g. pg1, the file will be named
pg1_out.pcap</p></li>
<li><p>history files - whenever the capture is restarted or a new stream is added,
the existing files are rotated and renamed, so all the pcap files
are always saved for later debugging if needed</p></li>
<li><p>core - if vpp dumps a core, it’ll be stored in the temporary directory</p></li>
<li><p>vpp_stdout.txt - file containing output which vpp printed to stdout</p></li>
<li><p>vpp_stderr.txt - file containing output which vpp printed to stderr</p></li>
</ul>
<p><em>NOTE</em>: existing temporary directories named vpp-unittest-* are automatically
removed when invoking ‘make test*’ or ‘make retest*’ to keep the temporary
directory clean.</p>
</section>
<section id="virtual-environment">
<h2><a class="toc-backref" href="#id7">Virtual environment</a><a class="headerlink" href="#virtual-environment" title="Permalink to this headline"></a></h2>
<p><a class="reference external" href="http://docs.python-guide.org/en/latest/dev/virtualenvs/">Virtualenv</a> is a python module which provides a means to create an environment
containing the dependencies required by the VPP Test Framework, allowing a separation
from any existing system-wide packages. VPP Test Framework’s Makefile automatically
creates a <a class="reference external" href="http://docs.python-guide.org/en/latest/dev/virtualenvs/">virtualenv</a> inside build-root and installs the required packages
in that environment. The environment is entered whenever executing a test
via one of the make test targets.</p>
</section>
<section id="naming-conventions">
<h2><a class="toc-backref" href="#id8">Naming conventions</a><a class="headerlink" href="#naming-conventions" title="Permalink to this headline"></a></h2>
<p>Most unit tests do some kind of packet manipulation - sending and receiving
packets between VPP and virtual hosts connected to the VPP. Referring
to the sides, addresses, etc. is always done as if looking from the VPP side,
thus:</p>
<ul class="simple">
<li><p><em>local_</em> prefix is used for the VPP side.
So e.g. <cite>local_ip4 &lt;VppInterface.local_ip4&gt;</cite> address is the IPv4 address
assigned to the VPP interface.</p></li>
<li><p><em>remote_</em> prefix is used for the virtual host side.
So e.g. <cite>remote_mac &lt;VppInterface.remote_mac&gt;</cite> address is the MAC address
assigned to the virtual host connected to the VPP.</p></li>
</ul>
</section>
<section id="automatically-generated-addresses">
<h2><a class="toc-backref" href="#id9">Automatically generated addresses</a><a class="headerlink" href="#automatically-generated-addresses" title="Permalink to this headline"></a></h2>
<p>To send packets, one needs to typically provide some addresses, otherwise
the packets will be dropped. The interface objects in VPP Test Framework automatically
provide addresses based on (typically) their indexes, which ensures
there are no conflicts and eases debugging by making the addressing scheme
consistent.</p>
<p>The developer of a test case typically doesn’t need to work with the actual
numbers, rather using the properties of the objects. The addresses typically
come in two flavors: ‘&lt;address&gt;’ and ‘&lt;address&gt;n’ - note the ‘n’ suffix.
The former address is a Python string, while the latter is translated using
socket.inet_pton to raw format in network byte order - this format is suitable
for passing as an argument to VPP APIs.</p>
<p>e.g. for the IPv4 address assigned to the VPP interface:</p>
<ul class="simple">
<li><p>local_ip4 - Local IPv4 address on VPP interface (string)</p></li>
<li><p>local_ip4n - Local IPv4 address - raw, suitable as API parameter.</p></li>
</ul>
<p>These addresses need to be configured in VPP to be usable using e.g.
<cite>VppInterface.config_ip4</cite> API. Please see the documentation to
<cite>VppInterface</cite> for more details.</p>
<p>By default, there is one remote address of each kind created for L3:
remote_ip4 and remote_ip6. If the test needs more addresses, because it’s
simulating more remote hosts, they can be generated using
<cite>generate_remote_hosts</cite> API and the entries for them inserted into the ARP
table using <cite>configure_ipv4_neighbors</cite> API.</p>
</section>
<section id="packet-flow-in-the-vtf">
<h2><a class="toc-backref" href="#id10">Packet flow in the VPP Test Framework</a><a class="headerlink" href="#packet-flow-in-the-vtf" title="Permalink to this headline"></a></h2>
<section id="test-framework-vpp">
<h3>Test framework -&gt; VPP<a class="headerlink" href="#test-framework-vpp" title="Permalink to this headline"></a></h3>
<p>VPP Test Framework doesn’t send any packets to VPP directly. Traffic is instead injected
using packet-generator interfaces, represented by the <cite>VppPGInterface</cite> class.
Packets are written into a temporary .pcap file, which is then read by the VPP
and the packets are injected into the VPP world.</p>
<p>To add a list of packets to an interface, call the <cite>VppPGInterface.add_stream</cite>
method on that interface. Once everything is prepared, call <cite>pg_start</cite> method to
start the packet generator on the VPP side.</p>
</section>
<section id="vpp-test-framework">
<h3>VPP -&gt; test framework<a class="headerlink" href="#vpp-test-framework" title="Permalink to this headline"></a></h3>
<p>Similarly, VPP doesn’t send any packets to VPP Test Framework directly. Instead, packet
capture feature is used to capture and write traffic to a temporary .pcap file,
which is then read and analyzed by the VPP Test Framework.</p>
<p>The following APIs are available to the test case for reading pcap files.</p>
<ul class="simple">
<li><p><cite>VppPGInterface.get_capture</cite>: this API is suitable for bulk &amp; batch
style of test, where a list of packets is prepared &amp; sent, then the
received packets are read and verified. The API needs the number of
packets which are expected to be captured (ignoring filtered
packets - see below) to know when the pcap file is completely
written by the VPP. If using packet infos for verifying packets,
then the counts of the packet infos can be automatically used by
<cite>VppPGInterface.get_capture</cite> to get the proper count (in this case
the default value None can be supplied as expected_count or omitted
altogether).</p></li>
<li><p><cite>VppPGInterface.wait_for_packet</cite>: this API is suitable for
interactive style of test, e.g. when doing session management,
three-way handshakes, etc. This API waits for and returns a single
packet, keeping the capture file in place and remembering
context. Repeated invocations return following packets (or raise
Exception if timeout is reached) from the same capture file (=
packets arriving on the same interface).</p></li>
</ul>
<p><em>NOTE</em>: it is not recommended to mix these APIs unless you understand
how they work internally. None of these APIs rotate the pcap capture
file, so calling e.g. <cite>VppPGInterface.get_capture</cite> after
<cite>VppPGInterface.wait_for_packet</cite> will return already read packets.  It
is safe to switch from one API to another after calling
<cite>VppPGInterface.enable_capture</cite> as that API rotates the capture file.</p>
</section>
<section id="automatic-filtering-of-packets">
<h3>Automatic filtering of packets:<a class="headerlink" href="#automatic-filtering-of-packets" title="Permalink to this headline"></a></h3>
<p>Both APIs (<cite>VppPGInterface.get_capture</cite> and
<cite>VppPGInterface.wait_for_packet</cite>) by default filter the packet
capture, removing known uninteresting packets from it - these are IPv6
Router Advertisements and IPv6 Router Alerts. These packets are
unsolicited and from the point of VPP Test Framework are random. If a test wants
to receive these packets, it should specify either None or a custom
filtering function as the value to the ‘filter_out_fn’ argument.</p>
</section>
<section id="common-api-flow-for-sending-receiving-packets">
<h3>Common API flow for sending/receiving packets:<a class="headerlink" href="#common-api-flow-for-sending-receiving-packets" title="Permalink to this headline"></a></h3>
<p>We will describe a simple scenario, where packets are sent from pg0 to pg1
interface, assuming that the interfaces were created using
<cite>create_pg_interfaces</cite> API.</p>
<ol class="arabic">
<li><p>Create a list of packets for pg0:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">packet_count</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">packets</span> <span class="o">=</span> <span class="n">create_packets</span><span class="p">(</span><span class="n">src</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pg0</span><span class="p">,</span> <span class="n">dst</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pg1</span><span class="p">,</span>
                         <span class="n">count</span><span class="o">=</span><span class="n">packet_count</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p>Add that list of packets to the source interface:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="bp">self</span><span class="o">.</span><span class="n">pg0</span><span class="o">.</span><span class="n">add_stream</span><span class="p">(</span><span class="n">packets</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p>Enable capture on the destination interface:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="bp">self</span><span class="o">.</span><span class="n">pg1</span><span class="o">.</span><span class="n">enable_capture</span><span class="p">()</span>
</pre></div>
</div>
</li>
<li><p>Start the packet generator:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="bp">self</span><span class="o">.</span><span class="n">pg_start</span><span class="p">()</span>
</pre></div>
</div>
</li>
<li><p>Wait for capture file to appear and read it:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">capture</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pg1</span><span class="o">.</span><span class="n">get_capture</span><span class="p">(</span><span class="n">expected_count</span><span class="o">=</span><span class="n">packet_count</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p>Verify packets match sent packets:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="bp">self</span><span class="o">.</span><span class="n">verify_capture</span><span class="p">(</span><span class="n">send</span><span class="o">=</span><span class="n">packets</span><span class="p">,</span> <span class="n">captured</span><span class="o">=</span><span class="n">capture</span><span class="p">)</span>
</pre></div>
</div>
</li>
</ol>
</section>
</section>
<section id="test-framework-objects">
<h2><a class="toc-backref" href="#id11">Test framework objects</a><a class="headerlink" href="#test-framework-objects" title="Permalink to this headline"></a></h2>
<p>The following objects provide VPP abstraction and provide a means to do
common tasks easily in the test cases.</p>
<ul class="simple">
<li><p><cite>VppInterface</cite>: abstract class representing generic VPP interface
and contains some common functionality, which is then used by derived classes</p></li>
<li><p><cite>VppPGInterface</cite>: class representing VPP packet-generator interface.
The interface is created/destroyed when the object is created/destroyed.</p></li>
<li><p><cite>VppSubInterface</cite>: VPP sub-interface abstract class, containing common
functionality for e.g. <cite>VppDot1QSubint</cite> and <cite>VppDot1ADSubint</cite> classes</p></li>
</ul>
</section>
<section id="how-vpp-apis-clis-are-called">
<h2><a class="toc-backref" href="#id12">How VPP APIs/CLIs are called</a><a class="headerlink" href="#how-vpp-apis-clis-are-called" title="Permalink to this headline"></a></h2>
<p>Vpp provides python bindings in a python module called vpp-papi, which the test
framework installs in the virtual environment. A shim layer represented by
the <cite>VppPapiProvider</cite> class is built on top of the vpp-papi, serving these
purposes:</p>
<ol class="arabic simple">
<li><p>Automatic return value checks:
After each API is called, the return value is checked against the expected
return value (by default 0, but can be overridden) and an exception
is raised if the check fails.</p></li>
<li><p>Automatic call of hooks:</p>
<ol class="loweralpha simple">
<li><p><cite>before_cli &lt;Hook.before_cli&gt;</cite> and <cite>before_api &lt;Hook.before_api&gt;</cite> hooks
are used for debug logging and stepping through the test</p></li>
<li><p><cite>after_cli &lt;Hook.after_cli&gt;</cite> and <cite>after_api &lt;Hook.after_api&gt;</cite> hooks
are used for monitoring the vpp process for crashes</p></li>
</ol>
</li>
<li><p>Simplification of API calls:
Many of the VPP APIs take a lot of parameters and by providing sane defaults
for these, the API is much easier to use in the common case and the code is
more readable. E.g. ip_add_del_route API takes ~25 parameters, of which
in the common case, only 3 are needed.</p></li>
</ol>
</section>
<section id="utility-methods">
<h2><a class="toc-backref" href="#id13">Utility methods</a><a class="headerlink" href="#utility-methods" title="Permalink to this headline"></a></h2>
<p>Some interesting utility methods are:</p>
<ul class="simple">
<li><p><cite>ppp</cite>: ‘Pretty Print Packet’ - returns a string containing the same output
as Scapy’s packet.show() would print</p></li>
<li><p><cite>ppc</cite>: ‘Pretty Print Capture’ - returns a string containing printout of
a capture (with configurable limit on the number of packets printed from it)
using <cite>ppp</cite></p></li>
</ul>
<p><em>NOTE</em>: Do not use Scapy’s packet.show() in the tests, because it prints
the output to stdout. All output should go to the logger associated with
the test case.</p>
</section>
<section id="example-how-to-add-a-new-test">
<h2><a class="toc-backref" href="#id14">Example: how to add a new test</a><a class="headerlink" href="#example-how-to-add-a-new-test" title="Permalink to this headline"></a></h2>
<p>In this example, we will describe how to add a new test case which tests
basic IPv4 forwarding.</p>
<ol class="arabic">
<li><p>Add a new file called test_ip4_fwd.py in the test directory, starting
with a few imports:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">framework</span> <span class="kn">import</span> <span class="n">VppTestCase</span>
<span class="kn">from</span> <span class="nn">scapy.layers.l2</span> <span class="kn">import</span> <span class="n">Ether</span>
<span class="kn">from</span> <span class="nn">scapy.packet</span> <span class="kn">import</span> <span class="n">Raw</span>
<span class="kn">from</span> <span class="nn">scapy.layers.inet</span> <span class="kn">import</span> <span class="n">IP</span><span class="p">,</span> <span class="n">UDP</span>
<span class="kn">from</span> <span class="nn">random</span> <span class="kn">import</span> <span class="n">randint</span>
</pre></div>
</div>
</li>
<li><p>Create a class inherited from the VppTestCase:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">IP4FwdTestCase</span><span class="p">(</span><span class="n">VppTestCase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; IPv4 simple forwarding test case &quot;&quot;&quot;</span>
</pre></div>
</div>
</li>
<li><p>Add a setUpClass function containing the setup needed for our test to run:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@classmethod</span>
<span class="k">def</span> <span class="nf">setUpClass</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="nb">super</span><span class="p">(</span><span class="n">IP4FwdTestCase</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">setUpClass</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">create_pg_interfaces</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>  <span class="c1">#  create pg0 and pg1</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pg_interfaces</span><span class="p">:</span>
        <span class="n">i</span><span class="o">.</span><span class="n">admin_up</span><span class="p">()</span>  <span class="c1"># put the interface up</span>
        <span class="n">i</span><span class="o">.</span><span class="n">config_ip4</span><span class="p">()</span>  <span class="c1"># configure IPv4 address on the interface</span>
        <span class="n">i</span><span class="o">.</span><span class="n">resolve_arp</span><span class="p">()</span>  <span class="c1"># resolve ARP, so that we know VPP MAC</span>
</pre></div>
</div>
</li>
<li><p>Create a helper method to create the packets to send:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">create_stream</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src_if</span><span class="p">,</span> <span class="n">dst_if</span><span class="p">,</span> <span class="n">count</span><span class="p">):</span>
    <span class="n">packets</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">count</span><span class="p">):</span>
        <span class="c1"># create packet info stored in the test case instance</span>
        <span class="n">info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_packet_info</span><span class="p">(</span><span class="n">src_if</span><span class="p">,</span> <span class="n">dst_if</span><span class="p">)</span>
        <span class="c1"># convert the info into packet payload</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">info_to_payload</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>
        <span class="c1"># create the packet itself</span>
        <span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">Ether</span><span class="p">(</span><span class="n">dst</span><span class="o">=</span><span class="n">src_if</span><span class="o">.</span><span class="n">local_mac</span><span class="p">,</span> <span class="n">src</span><span class="o">=</span><span class="n">src_if</span><span class="o">.</span><span class="n">remote_mac</span><span class="p">)</span> <span class="o">/</span>
             <span class="n">IP</span><span class="p">(</span><span class="n">src</span><span class="o">=</span><span class="n">src_if</span><span class="o">.</span><span class="n">remote_ip4</span><span class="p">,</span> <span class="n">dst</span><span class="o">=</span><span class="n">dst_if</span><span class="o">.</span><span class="n">remote_ip4</span><span class="p">)</span> <span class="o">/</span>
             <span class="n">UDP</span><span class="p">(</span><span class="n">sport</span><span class="o">=</span><span class="n">randint</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">2000</span><span class="p">),</span> <span class="n">dport</span><span class="o">=</span><span class="mi">5678</span><span class="p">)</span> <span class="o">/</span>
             <span class="n">Raw</span><span class="p">(</span><span class="n">payload</span><span class="p">))</span>
        <span class="c1"># store a copy of the packet in the packet info</span>
        <span class="n">info</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="c1"># append the packet to the list</span>
        <span class="n">packets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

    <span class="c1"># return the created packet list</span>
    <span class="k">return</span> <span class="n">packets</span>
</pre></div>
</div>
</li>
<li><p>Create a helper method to verify the capture:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">verify_capture</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src_if</span><span class="p">,</span> <span class="n">dst_if</span><span class="p">,</span> <span class="n">capture</span><span class="p">):</span>
    <span class="n">packet_info</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">packet</span> <span class="ow">in</span> <span class="n">capture</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ip</span> <span class="o">=</span> <span class="n">packet</span><span class="p">[</span><span class="n">IP</span><span class="p">]</span>
            <span class="n">udp</span> <span class="o">=</span> <span class="n">packet</span><span class="p">[</span><span class="n">UDP</span><span class="p">]</span>
            <span class="c1"># convert the payload to packet info object</span>
            <span class="n">payload_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">payload_to_info</span><span class="p">(</span><span class="n">packet</span><span class="p">[</span><span class="n">Raw</span><span class="p">])</span>
            <span class="c1"># make sure the indexes match</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assert_equal</span><span class="p">(</span><span class="n">payload_info</span><span class="o">.</span><span class="n">src</span><span class="p">,</span> <span class="n">src_if</span><span class="o">.</span><span class="n">sw_if_index</span><span class="p">,</span>
                              <span class="s2">&quot;source sw_if_index&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assert_equal</span><span class="p">(</span><span class="n">payload_info</span><span class="o">.</span><span class="n">dst</span><span class="p">,</span> <span class="n">dst_if</span><span class="o">.</span><span class="n">sw_if_index</span><span class="p">,</span>
                              <span class="s2">&quot;destination sw_if_index&quot;</span><span class="p">)</span>
            <span class="n">packet_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_next_packet_info_for_interface2</span><span class="p">(</span>
                              <span class="n">src_if</span><span class="o">.</span><span class="n">sw_if_index</span><span class="p">,</span>
                              <span class="n">dst_if</span><span class="o">.</span><span class="n">sw_if_index</span><span class="p">,</span>
                              <span class="n">packet_info</span><span class="p">)</span>
            <span class="c1"># make sure we didn&#39;t run out of saved packets</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="n">packet_info</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assert_equal</span><span class="p">(</span><span class="n">payload_info</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">packet_info</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
                              <span class="s2">&quot;packet info index&quot;</span><span class="p">)</span>
            <span class="n">saved_packet</span> <span class="o">=</span> <span class="n">packet_info</span><span class="o">.</span><span class="n">data</span>  <span class="c1"># fetch the saved packet</span>
            <span class="c1"># assert the values match</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assert_equal</span><span class="p">(</span><span class="n">ip</span><span class="o">.</span><span class="n">src</span><span class="p">,</span> <span class="n">saved_packet</span><span class="p">[</span><span class="n">IP</span><span class="p">]</span><span class="o">.</span><span class="n">src</span><span class="p">,</span>
                              <span class="s2">&quot;IP source address&quot;</span><span class="p">)</span>
            <span class="c1"># ... more assertions here</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assert_equal</span><span class="p">(</span><span class="n">udp</span><span class="o">.</span><span class="n">sport</span><span class="p">,</span> <span class="n">saved_packet</span><span class="p">[</span><span class="n">UDP</span><span class="p">]</span><span class="o">.</span><span class="n">sport</span><span class="p">,</span>
                              <span class="s2">&quot;UDP source port&quot;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">ppp</span><span class="p">(</span><span class="s2">&quot;Unexpected or invalid packet:&quot;</span><span class="p">,</span>
                              <span class="n">packet</span><span class="p">))</span>
            <span class="k">raise</span>
    <span class="n">remaining_packet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_next_packet_info_for_interface2</span><span class="p">(</span>
               <span class="n">src_if</span><span class="o">.</span><span class="n">sw_if_index</span><span class="p">,</span>
               <span class="n">dst_if</span><span class="o">.</span><span class="n">sw_if_index</span><span class="p">,</span>
               <span class="n">packet_info</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">remaining_packet</span><span class="p">,</span>
                      <span class="s2">&quot;Interface </span><span class="si">%s</span><span class="s2">: Packet expected from interface &quot;</span>
                      <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> didn&#39;t arrive&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dst_if</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">src_if</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
</pre></div>
</div>
</li>
<li><p>Add the test code to test_basic function:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">test_basic</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">count</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="c1"># create the packet stream</span>
    <span class="n">packets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_stream</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pg0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pg1</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span>
    <span class="c1"># add the stream to the source interface</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">pg0</span><span class="o">.</span><span class="n">add_stream</span><span class="p">(</span><span class="n">packets</span><span class="p">)</span>
    <span class="c1"># enable capture on both interfaces</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">pg0</span><span class="o">.</span><span class="n">enable_capture</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">pg1</span><span class="o">.</span><span class="n">enable_capture</span><span class="p">()</span>
    <span class="c1"># start the packet generator</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">pg_start</span><span class="p">()</span>
    <span class="c1"># get capture - the proper count of packets was saved by</span>
    <span class="c1"># create_packet_info() based on dst_if parameter</span>
    <span class="n">capture</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pg1</span><span class="o">.</span><span class="n">get_capture</span><span class="p">()</span>
    <span class="c1"># assert nothing captured on pg0 (always do this last, so that</span>
    <span class="c1"># some time has already passed since pg_start())</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">pg0</span><span class="o">.</span><span class="n">assert_nothing_captured</span><span class="p">()</span>
    <span class="c1"># verify capture</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">verify_capture</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pg0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pg1</span><span class="p">,</span> <span class="n">capture</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p>Run the test by issuing ‘make test’ or, to run only this specific
test, issue ‘make test TEST=test_ip4_fwd’.</p></li>
</ol>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../devicedrivers/af_xdp.html" class="btn btn-neutral float-left" title="AF_XDP device driver" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../extras/index.html" class="btn btn-neutral float-right" title="VPP extra tools" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2018-2021, Linux Foundation.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>