<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Multi-threading in VPP &mdash; The Vector Packet Processor v22.02-rc0-128-g4450b03ba
 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/rules.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Core Features" href="../corefeatures/index.html" />
    <link rel="prev" title="VPP mem preload" href="mem.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> The Vector Packet Processor
            <img src="../../_static/fd-io_red_white.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                v22.02-rc0-128-g4450b03ba

              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">About VPP</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../aboutvpp/scalar-vs-vector-packet-processing.html">Scalar vs Vector packet processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../aboutvpp/extensible.html">The Packet Processing Graph</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../aboutvpp/networkstack.html">Network Stack Features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../aboutvpp/hoststack.html">Host Stack</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../aboutvpp/developer.html">Additional features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../aboutvpp/supported.html">Supported archs and OS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../aboutvpp/performance.html">Performance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../aboutvpp/releasenotes/index.html">Release notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../aboutvpp/featurelist.html">VPP Supported Features</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Use Cases</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../usecases/containers/index.html">VPP with Containers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usecases/simpleperf/index.html">VPP with Iperf3 and TRex</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usecases/vppcloud/index.html">VPP in the Cloud</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usecases/vhost/index.html">VPP with Virtual Machines</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usecases/vmxnet3.html">VPP with VMware/Vmxnet3</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usecases/home_gateway.html">VPP as a Home Gateway</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usecases/acls.html">Access Control Lists with VPP</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usecases/networksim.html">Generating traffic with VPP</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usecases/webapp.html">Web applications with VPP</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usecases/container_test.html">Simulating networks with VPP</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usecases/trafficgen.html">Stateless Traffic Gen with VPP</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usecases/ikev2/index.html">IKEv2 with VPP</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usecases/contiv/index.html">VPP in kubernetes (Contiv/Deprecated)</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Getting started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../gettingstarted/installing/index.html">Downloading and Installing VPP</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../gettingstarted/running/index.html">Running VPP</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../gettingstarted/progressivevpp/index.html">Progressive VPP Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../gettingstarted/troubleshooting/index.html">Troubleshooting</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developer Documentation</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../build-run-debug/index.html">Build, Run &amp; Debug</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Core Architecture</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="softwarearchitecture.html">Software Architecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="infrastructure.html">VPPINFRA (Infrastructure)</a></li>
<li class="toctree-l2"><a class="reference internal" href="vlib.html">VLIB (Vector Processing Library)</a></li>
<li class="toctree-l2"><a class="reference internal" href="vnet.html">VNET (VPP Network Stack)</a></li>
<li class="toctree-l2"><a class="reference internal" href="featurearcs.html">Feature Arcs</a></li>
<li class="toctree-l2"><a class="reference internal" href="buffer_metadata.html">Buffer Metadata</a></li>
<li class="toctree-l2"><a class="reference internal" href="multiarch/index.html">Multi-architecture support</a></li>
<li class="toctree-l2"><a class="reference internal" href="bihash.html">Bounded-index Extensible Hashing (bihash)</a></li>
<li class="toctree-l2"><a class="reference internal" href="buildsystem/index.html">Build System</a></li>
<li class="toctree-l2"><a class="reference internal" href="mem.html">VPP mem preload</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Multi-threading in VPP</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#modes">Modes</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#single-thread">Single-thread</a></li>
<li class="toctree-l4"><a class="reference internal" href="#multi-thread-with-worker-threads">Multi-thread with Worker Threads</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#thread-placement">Thread placement</a></li>
<li class="toctree-l3"><a class="reference internal" href="#sample-configurations">Sample Configurations</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#manual-placement">Manual Placement</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#auto-placement">Auto placement</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#buffer-memory-allocation">Buffer Memory Allocation</a></li>
<li class="toctree-l4"><a class="reference internal" href="#interface-placement-in-multi-thread-setup">Interface Placement in Multi-thread Setup</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../corefeatures/index.html">Core Features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../plugindoc/index.html">Adding a new plugin or feature</a></li>
<li class="toctree-l1"><a class="reference internal" href="../plugins/index.html">Plugins</a></li>
<li class="toctree-l1"><a class="reference internal" href="../devicedrivers/index.html">Device drivers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tests/overview.html">VPP Test Framework</a></li>
<li class="toctree-l1"><a class="reference internal" href="../extras/index.html">VPP extra tools</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Interfacing with VPP</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../interfacing/binapi/index.html">The binary API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../interfacing/c/index.html">C api client</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../interfacing/cpp/index.html">C++ api client</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../interfacing/go/index.html">Go api (govpp)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../interfacing/rust/index.html">Rust api client</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../interfacing/libmemif/index.html">Memif library (libmemif)</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Contributing</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../contributing/gitreview.html">Getting a Patch Reviewed</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contributing/writingdocs.html">Writing VPP Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contributing/reportingissues/index.html">Reporting Bugs</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Debug CLI</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../cli-reference/gettingstarted/index.html">Getting Started with the debug CLI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cli-reference/interface/index.html">Interface Commands</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cli-reference/index.html">Reference</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Configuration file</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../configuration/config_getting_started.html">Getting started with the configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../configuration/reference.html">Configuration Reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">The Vector Packet Processor</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="index.html">Core Architecture</a> &raquo;</li>
      <li>Multi-threading in VPP</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/developer/corearchitecture/multi_thread.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="multi-threading-in-vpp">
<span id="vpp-multi-thread"></span><h1>Multi-threading in VPP<a class="headerlink" href="#multi-threading-in-vpp" title="Permalink to this headline"></a></h1>
<section id="modes">
<h2>Modes<a class="headerlink" href="#modes" title="Permalink to this headline"></a></h2>
<p>VPP can work in 2 different modes:</p>
<ul class="simple">
<li><p>single-thread</p></li>
<li><p>multi-thread with worker threads</p></li>
</ul>
<section id="single-thread">
<h3>Single-thread<a class="headerlink" href="#single-thread" title="Permalink to this headline"></a></h3>
<p>In a single-thread mode there is one main thread which handles both
packet processing and other management functions (Command-Line Interface
(CLI), API, stats). This is the default setup. There is no special
startup config needed.</p>
</section>
<section id="multi-thread-with-worker-threads">
<h3>Multi-thread with Worker Threads<a class="headerlink" href="#multi-thread-with-worker-threads" title="Permalink to this headline"></a></h3>
<p>In this mode, the main threads handles management functions(debug CLI,
API, stats collection) and one or more worker threads handle packet
processing from input to output of the packet.</p>
<p>Each worker thread polls input queues on subset of interfaces.</p>
<p>With RSS (Receive Side Scaling) enabled multiple threads can service one
physical interface (RSS function on NIC distributes traffic between
different queues which are serviced by different worker threads).</p>
</section>
</section>
<section id="thread-placement">
<h2>Thread placement<a class="headerlink" href="#thread-placement" title="Permalink to this headline"></a></h2>
<p>Thread placement is defined in the startup config under the cpu { … }
section.</p>
<p>The VPP platform can place threads automatically or manually. Automatic
placement works in the following way:</p>
<ul class="simple">
<li><p>if “skip-cores X” is defined first X cores will not be used</p></li>
<li><p>if “main-core X” is defined, VPP main thread will be placed on core
X, otherwise 1st available one will be used</p></li>
<li><p>if “workers N” is defined vpp will allocate first N available cores
and it will run threads on them</p></li>
<li><p>if “corelist-workers A,B1-Bn,C1-Cn” is defined vpp will automatically
assign those CPU cores to worker threads</p></li>
</ul>
<p>User can see active placement of cores by using the VPP debug CLI
command show threads:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">vpd# show threads</span>
<span class="go">ID     Name                Type        LWP     lcore  Core   Socket State</span>
<span class="go">0      vpe_main                        59723   2      2      0      wait</span>
<span class="go">1      vpe_wk_0            workers     59755   4      4      0      running</span>
<span class="go">2      vpe_wk_1            workers     59756   5      5      0      running</span>
<span class="go">3      vpe_wk_2            workers     59757   6      0      1      running</span>
<span class="go">4      vpe_wk_3            workers     59758   7      1      1      running</span>
<span class="go">5                          stats       59775</span>
<span class="go">vpd#</span>
</pre></div>
</div>
<p>The sample output above shows the main thread running on core 2 (2nd
core on the CPU socket 0), worker threads running on cores 4-7.</p>
</section>
<section id="sample-configurations">
<h2>Sample Configurations<a class="headerlink" href="#sample-configurations" title="Permalink to this headline"></a></h2>
<p>By default, at start-up VPP uses
configuration values from: <code class="docutils literal notranslate"><span class="pre">/etc/vpp/startup.conf</span></code></p>
<p>The following sections describe some of the additional changes that can be made to this file.
This file is initially populated from the files located in the following directory <code class="docutils literal notranslate"><span class="pre">/vpp/vpp/conf/</span></code></p>
<section id="manual-placement">
<h3>Manual Placement<a class="headerlink" href="#manual-placement" title="Permalink to this headline"></a></h3>
<p>Manual placement places the main thread on core 1, workers on cores
4,5,20,21.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">cpu {</span>
<span class="go">  main-core 1</span>
<span class="go">  corelist-workers  4-5,20-21</span>
<span class="go">}</span>
</pre></div>
</div>
</section>
</section>
<section id="auto-placement">
<h2>Auto placement<a class="headerlink" href="#auto-placement" title="Permalink to this headline"></a></h2>
<p>Auto placement is likely to place the main thread on core 1 and workers
on cores 2,3,4.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">cpu {</span>
<span class="go">  skip-cores 1</span>
<span class="go">  workers 3</span>
<span class="go">}</span>
</pre></div>
</div>
<section id="buffer-memory-allocation">
<h3>Buffer Memory Allocation<a class="headerlink" href="#buffer-memory-allocation" title="Permalink to this headline"></a></h3>
<p>The VPP platform is NUMA aware. It can allocate memory for buffers on
different CPU sockets (NUMA nodes). The amount of memory allocated can
be defined in the startup config for each CPU socket by using the
socket-mem A[[,B],C] statement inside the dpdk { … } section.</p>
<p>For example:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">dpdk {</span>
<span class="go">  socket-mem 1024,1024</span>
<span class="go">}</span>
</pre></div>
</div>
<p>The above configuration allocates 1GB of memory on NUMA#0 and 1GB on
NUMA#1. Each worker thread uses buffers which are local to itself.</p>
<p>Buffer memory is allocated from hugepages. VPP prefers 1G pages if they
are available. If not 2MB pages will be used.</p>
<p>VPP takes care of mounting/unmounting hugepages file-system
automatically so there is no need to do that manually.</p>
<p>’‘’NOTE’’’: If you are running latest VPP release, there is no need for
specifying socket-mem manually. VPP will discover all NUMA nodes and it
will allocate 512M on each by default. socket-mem is only needed if
bigger number of mbufs is required (default is 16384 per socket and can
be changed with num-mbufs startup config command).</p>
</section>
<section id="interface-placement-in-multi-thread-setup">
<h3>Interface Placement in Multi-thread Setup<a class="headerlink" href="#interface-placement-in-multi-thread-setup" title="Permalink to this headline"></a></h3>
<p>On startup, the VPP platform assigns interfaces (or interface, queue
pairs if RSS is used) to different worker threads in round robin
fashion.</p>
<p>The following example shows debug CLI commands to show and change
interface placement:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">vpd# sh dpdk interface placement</span>
<span class="go">Thread 1 (vpp_wk_0 at lcore 5):</span>
<span class="go"> TenGigabitEthernet2/0/0 queue 0</span>
<span class="go"> TenGigabitEthernet2/0/1 queue 0</span>
<span class="go">Thread 2 (vpp_wk_1 at lcore 6):</span>
<span class="go"> TenGigabitEthernet2/0/0 queue 1</span>
<span class="go"> TenGigabitEthernet2/0/1 queue 1</span>
</pre></div>
</div>
<p>The following shows an example of moving TenGigabitEthernet2/0/1 queue 1
processing to 1st worker thread:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">vpd# set interface placement TenGigabitEthernet2/0/1 queue 1 thread 1</span>

<span class="go">vpp# sh dpdk interface placement</span>
<span class="go">Thread 1 (vpp_wk_0 at lcore 5):</span>
<span class="go"> TenGigabitEthernet2/0/0 queue 0</span>
<span class="go"> TenGigabitEthernet2/0/1 queue 0</span>
<span class="go"> TenGigabitEthernet2/0/1 queue 1</span>
<span class="go">Thread 2 (vpp_wk_1 at lcore 6):</span>
<span class="go"> TenGigabitEthernet2/0/0 queue 1</span>
</pre></div>
</div>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="mem.html" class="btn btn-neutral float-left" title="VPP mem preload" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../corefeatures/index.html" class="btn btn-neutral float-right" title="Core Features" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2018-2021, Linux Foundation.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>