

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Manual Installation &mdash; Vector Packet Processor 01 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/rules.css" type="text/css" />
    <link rel="author" title="About these documents" href="../../about.html" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Creating VPP Startup Configuration" href="VPP_CONFIG.html" />
    <link rel="prev" title="Contiv-VPP Vagrant Installation" href="Vagrant.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> Vector Packet Processor
          

          
            
            <img src="../../_static/fd-io_red_white.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                19.08
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../overview/index.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../gettingstarted/index.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../links/index.html">VPP Wiki, Doxygen and Other Links</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Use Cases</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../containers.html">VPP with Containers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../simpleperf/index.html">VPP with Iperf3 and TRex</a></li>
<li class="toctree-l2"><a class="reference internal" href="../vhost/index.html">FD.io VPP with Virtual Machines</a></li>
<li class="toctree-l2"><a class="reference internal" href="../vmxnet3.html">VPP with VMware/Vmxnet3</a></li>
<li class="toctree-l2"><a class="reference internal" href="../acls.html">Access Control Lists (ACLs) with FD.io VPP</a></li>
<li class="toctree-l2"><a class="reference internal" href="../vppcloud.html">VPP inside the Cloud</a></li>
<li class="toctree-l2"><a class="reference internal" href="../homegateway.html">Using VPP as a Home Gateway</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">Contiv/VPP</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="K8s_Overview.html">Contiv/VPP Kubernetes Network Plugin</a></li>
<li class="toctree-l3"><a class="reference internal" href="SECURITY.html">Security</a></li>
<li class="toctree-l3"><a class="reference internal" href="Vagrant.html">Contiv-VPP Vagrant Installation</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Manual Installation</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#clone-the-contiv-respository">Clone the Contiv Respository</a></li>
<li class="toctree-l4"><a class="reference internal" href="#preparing-your-hosts">Preparing Your Hosts</a></li>
<li class="toctree-l4"><a class="reference internal" href="#installing-kubernetes-with-contiv-vpp-cni-plugin">Installing Kubernetes with Contiv-VPP CNI plugin</a></li>
<li class="toctree-l4"><a class="reference internal" href="#contiv-specific-kubeadm-installation-on-aarch64">Contiv-specific kubeadm installation on Aarch64</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="VPP_CONFIG.html">Creating VPP Startup Configuration</a></li>
<li class="toctree-l3"><a class="reference internal" href="VMWARE_FUSION_HOST.html">Preparing a VmWare Fusion Host</a></li>
<li class="toctree-l3"><a class="reference internal" href="NETWORKING.html">Contiv/VPP Network Operation</a></li>
<li class="toctree-l3"><a class="reference internal" href="SINGLE_NIC_SETUP.html">Setting up a Node with a Single NIC</a></li>
<li class="toctree-l3"><a class="reference internal" href="MULTI_NIC_SETUP.html">Setting Up a Node with Multiple NICs</a></li>
<li class="toctree-l3"><a class="reference internal" href="CUSTOM_MGMT_NETWORK.html">Setting Up a Custom Management Network on Multi-Homed Nodes</a></li>
<li class="toctree-l3"><a class="reference internal" href="Prometheus.html">Prometheus Statistics</a></li>
<li class="toctree-l3"><a class="reference internal" href="VPP_PACKET_TRACING_K8S.html">How to do VPP Packet Tracing in Kubernetes</a></li>
<li class="toctree-l3"><a class="reference internal" href="VPPTRACE.html">Using vpptrace.sh for VPP Packet Tracing</a></li>
<li class="toctree-l3"><a class="reference internal" href="CORE_FILES.html">Capturing VPP core dumps</a></li>
<li class="toctree-l3"><a class="reference internal" href="BUG_REPORTS.html">Debugging and Reporting Bugs in Contiv-VPP</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../networksim.html">Network Simulator Plugin</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../featuresbyrelease/index.html">Features by Release</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../troubleshooting/index.html">Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../events/index.html">Events</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../reference/index.html">Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../relatedprojects/index.html">Related Projects</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../archive/index.html">Archive</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../about.html">About</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Vector Packet Processor</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Use Cases</a> &raquo;</li>
        
          <li><a href="index.html">Contiv/VPP</a> &raquo;</li>
        
      <li>Manual Installation</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/usecases/contiv/MANUAL_INSTALL.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="manual-installation">
<h1>Manual Installation<a class="headerlink" href="#manual-installation" title="Permalink to this headline">¶</a></h1>
<p>This document describes how to clone the Contiv respository and then use <a class="reference external" href="https://kubernetes.io/docs/setup/independent/create-cluster-kubeadm/">kubeadm</a> to manually install Kubernetes
with Contiv-VPP networking on one or more bare metal or VM hosts.</p>
<div class="section" id="clone-the-contiv-respository">
<h2>Clone the Contiv Respository<a class="headerlink" href="#clone-the-contiv-respository" title="Permalink to this headline">¶</a></h2>
<p>To clone the Contiv respository enter the following command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">git</span> <span class="n">clone</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">contiv</span><span class="o">/</span><span class="n">vpp</span><span class="o">/&lt;</span><span class="n">repository</span><span class="o">-</span><span class="n">name</span><span class="o">&gt;</span>
</pre></div>
</div>
<p><strong>Note:</strong> Replace <em><repository-name></em> with the name you want assigned to your cloned contiv repository.</p>
<p>The cloned repository has important folders that contain content that are referenced in this Contiv documentation; those folders are noted below:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>vpp-contiv2$ ls
build       build-root  doxygen  gmod       LICENSE      Makefile   RELEASE.md   src
build-data  docs        extras   INFO.yaml  MAINTAINERS  README.md  sphinx_venv  test
</pre></div>
</div>
</div>
<div class="section" id="preparing-your-hosts">
<h2>Preparing Your Hosts<a class="headerlink" href="#preparing-your-hosts" title="Permalink to this headline">¶</a></h2>
<div class="section" id="host-specific-configurations">
<h3>Host-specific Configurations<a class="headerlink" href="#host-specific-configurations" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p><strong>VmWare VMs</strong>: the vmxnet3 driver is required on each interface that will
be used by VPP. Please see <a class="reference external" href="https://github.com/contiv/vpp/tree/master/docs/VMWARE_FUSION_HOST">here</a> for instructions how to install the
vmxnet3 driver on VmWare Fusion.</p></li>
</ul>
</div>
<div class="section" id="setting-up-network-adapter-s">
<h3>Setting up Network Adapter(s)<a class="headerlink" href="#setting-up-network-adapter-s" title="Permalink to this headline">¶</a></h3>
<div class="section" id="setting-up-dpdk">
<h4>Setting up DPDK<a class="headerlink" href="#setting-up-dpdk" title="Permalink to this headline">¶</a></h4>
<p>DPDK setup must be completed <strong>on each node</strong> as follows:</p>
<ul>
<li><p>Load the PCI UIO driver:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ sudo modprobe uio_pci_generic
</pre></div>
</div>
</li>
<li><p>Verify that the PCI UIO driver has loaded successfully:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ lsmod | grep uio
uio_pci_generic        16384  0
uio                    20480  1 uio_pci_generic
</pre></div>
</div>
<p>Please note that this driver needs to be loaded upon each server bootup,
so you may want to add <code class="docutils literal notranslate"><span class="pre">uio_pci_generic</span></code> into the <code class="docutils literal notranslate"><span class="pre">/etc/modules</span></code> file,
or a file in the <code class="docutils literal notranslate"><span class="pre">/etc/modules-load.d/</span></code> directory. For example, the
<code class="docutils literal notranslate"><span class="pre">/etc/modules</span></code> file could look as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># /etc/modules: kernel modules to load at boot time.</span>
<span class="c1">#</span>
<span class="c1"># This file contains the names of kernel modules that should be loaded</span>
<span class="c1"># at boot time, one per line. Lines beginning with &quot;#&quot; are ignored.</span>
<span class="n">uio_pci_generic</span>
</pre></div>
</div>
</li>
</ul>
</div>
<div class="section" id="determining-network-adapter-pci-addresses">
<h4>Determining Network Adapter PCI Addresses<a class="headerlink" href="#determining-network-adapter-pci-addresses" title="Permalink to this headline">¶</a></h4>
<p>You need the PCI address of the network interface that VPP will use for the multi-node pod interconnect. On Debian-based
distributions, you can use <code class="docutils literal notranslate"><span class="pre">lshw</span></code>(*):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ sudo lshw -class network -businfo
Bus info          Device      Class      Description
====================================================
pci@0000:00:03.0  ens3        network    Virtio network device
pci@0000:00:04.0  ens4        network    Virtio network device
</pre></div>
</div>
<p><strong>Note:</strong> On CentOS/RedHat/Fedora distributions, <code class="docutils literal notranslate"><span class="pre">lshw</span></code> may not be available by default, install it by issuing the following command:
<code class="docutils literal notranslate"><span class="pre">yum</span> <span class="pre">-y</span> <span class="pre">install</span> <span class="pre">lshw</span></code></p>
</div>
<div class="section" id="configuring-vswitch-to-use-network-adapters">
<h4>Configuring vswitch to Use Network Adapters<a class="headerlink" href="#configuring-vswitch-to-use-network-adapters" title="Permalink to this headline">¶</a></h4>
<p>Finally, you need to set up the vswitch to use the network adapters:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://github.com/contiv/vpp/tree/master/docs/SINGLE_NIC_SETUP">Setup on a node with a single NIC</a></p></li>
<li><p><a class="reference external" href="https://github.com/contiv/vpp/tree/master/docs/MULTI_NIC_SETUP">Setup a node with multiple NICs</a></p></li>
</ul>
</div>
</div>
<div class="section" id="using-a-node-setup-script">
<h3>Using a Node Setup Script<a class="headerlink" href="#using-a-node-setup-script" title="Permalink to this headline">¶</a></h3>
<p>You can perform the above steps using the <a class="reference external" href="https://github.com/contiv/vpp/tree/master/k8s/README.md#setup-node-sh">node setup script</a>.</p>
</div>
</div>
<div class="section" id="installing-kubernetes-with-contiv-vpp-cni-plugin">
<h2>Installing Kubernetes with Contiv-VPP CNI plugin<a class="headerlink" href="#installing-kubernetes-with-contiv-vpp-cni-plugin" title="Permalink to this headline">¶</a></h2>
<p>After the nodes you will be using in your K8s cluster are prepared, you can
install the cluster using <a class="reference external" href="https://kubernetes.io/docs/setup/independent/create-cluster-kubeadm/">kubeadm</a>.</p>
<div class="section" id="installing-kubeadm-on-your-hosts">
<h3>(1/4) Installing Kubeadm on Your Hosts<a class="headerlink" href="#installing-kubeadm-on-your-hosts" title="Permalink to this headline">¶</a></h3>
<p>For first-time installation, see <a class="reference external" href="https://kubernetes.io/docs/setup/independent/install-kubeadm/">Installing kubeadm</a>. To update an
existing installation,  you should do a <code class="docutils literal notranslate"><span class="pre">apt-get</span> <span class="pre">update</span> <span class="pre">&amp;&amp;</span> <span class="pre">apt-get</span> <span class="pre">upgrade</span></code>
or <code class="docutils literal notranslate"><span class="pre">yum</span> <span class="pre">update</span></code> to get the latest version of kubeadm.</p>
<p>On each host with multiple NICs where the NIC that will be used for Kubernetes
management traffic is not the one pointed to by the default route out of the
host, a <a class="reference external" href="https://github.com/contiv/vpp/tree/master/docs/CUSTOM_MGMT_NETWORK">custom management network</a> for Kubernetes must be configured.</p>
<div class="section" id="using-kubernetes-1-10-and-above">
<h4>Using Kubernetes 1.10 and Above<a class="headerlink" href="#using-kubernetes-1-10-and-above" title="Permalink to this headline">¶</a></h4>
<p>In K8s 1.10, support for huge pages in a pod has been introduced. For now, this
feature must be either disabled or memory limit must be defined for vswitch container.</p>
<p>To disable huge pages, perform the following
steps as root:</p>
<ul class="simple">
<li><p>Using your favorite editor, disable huge pages in the kubelet configuration
file (<code class="docutils literal notranslate"><span class="pre">/etc/systemd/system/kubelet.service.d/10-kubeadm.conf</span></code> or <code class="docutils literal notranslate"><span class="pre">/etc/default/kubelet</span></code> for version 1.11+):</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="n">Environment</span><span class="o">=</span><span class="s2">&quot;KUBELET_EXTRA_ARGS=--feature-gates HugePages=false&quot;</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Restart the kubelet daemon:</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="n">systemctl</span> <span class="n">daemon</span><span class="o">-</span><span class="n">reload</span>
  <span class="n">systemctl</span> <span class="n">restart</span> <span class="n">kubelet</span>
</pre></div>
</div>
<p>To define memory limit, append the following snippet to vswitch container in deployment yaml file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>			<span class="n">resources</span><span class="p">:</span>
              <span class="n">limits</span><span class="p">:</span>
                <span class="n">hugepages</span><span class="o">-</span><span class="mi">2</span><span class="n">Mi</span><span class="p">:</span> <span class="mi">1024</span><span class="n">Mi</span>
                <span class="n">memory</span><span class="p">:</span> <span class="mi">1024</span><span class="n">Mi</span>
</pre></div>
</div>
<p>or set <code class="docutils literal notranslate"><span class="pre">contiv.vswitch.defineMemoryLimits</span></code> to <code class="docutils literal notranslate"><span class="pre">true</span></code> in <a class="reference external" href="https://github.com/contiv/vpp/blob/master/k8s/contiv-vpp/README">helm values</a>.</p>
</div>
</div>
<div class="section" id="initializing-your-master">
<h3>(2/4) Initializing Your Master<a class="headerlink" href="#initializing-your-master" title="Permalink to this headline">¶</a></h3>
<p>Before initializing the master, you may want to <a class="reference external" href="#tearing-down-kubernetes">remove</a> any
previously installed K8s components. Then, proceed with master initialization
as described in the <a class="reference external" href="https://kubernetes.io/docs/setup/independent/create-cluster-kubeadm/#initializing-your-master">kubeadm manual</a>. Execute the following command as
root:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubeadm</span> <span class="n">init</span> <span class="o">--</span><span class="n">token</span><span class="o">-</span><span class="n">ttl</span> <span class="mi">0</span> <span class="o">--</span><span class="n">pod</span><span class="o">-</span><span class="n">network</span><span class="o">-</span><span class="n">cidr</span><span class="o">=</span><span class="mf">10.1</span><span class="o">.</span><span class="mf">0.0</span><span class="o">/</span><span class="mi">16</span>
</pre></div>
</div>
<p><strong>Note:</strong> <code class="docutils literal notranslate"><span class="pre">kubeadm</span> <span class="pre">init</span></code> will autodetect the network interface to advertise
the master on as the interface with the default gateway. If you want to use a
different interface (i.e. a custom management network setup), specify the
<code class="docutils literal notranslate"><span class="pre">--apiserver-advertise-address=&lt;ip-address&gt;</span></code> argument to kubeadm init. For
example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubeadm</span> <span class="n">init</span> <span class="o">--</span><span class="n">token</span><span class="o">-</span><span class="n">ttl</span> <span class="mi">0</span> <span class="o">--</span><span class="n">pod</span><span class="o">-</span><span class="n">network</span><span class="o">-</span><span class="n">cidr</span><span class="o">=</span><span class="mf">10.1</span><span class="o">.</span><span class="mf">0.0</span><span class="o">/</span><span class="mi">16</span> <span class="o">--</span><span class="n">apiserver</span><span class="o">-</span><span class="n">advertise</span><span class="o">-</span><span class="n">address</span><span class="o">=</span><span class="mf">192.168</span><span class="o">.</span><span class="mf">56.106</span>
</pre></div>
</div>
<p><strong>Note:</strong> The CIDR specified with the flag <code class="docutils literal notranslate"><span class="pre">--pod-network-cidr</span></code> is used by
kube-proxy, and it <strong>must include</strong> the <code class="docutils literal notranslate"><span class="pre">PodSubnetCIDR</span></code> from the <code class="docutils literal notranslate"><span class="pre">IPAMConfig</span></code>
section in the Contiv-vpp config map in Contiv-vpp’s deployment file
<a class="reference external" href="https://github.com/contiv/vpp/blob/master/k8s/contiv-vpp/values.yaml">contiv-vpp.yaml</a>. Pods in the host network namespace
are a special case; they share their respective interfaces and IP addresses with
the host. For proxying to work properly it is therefore required for services
with backends running on the host to also <strong>include the node management IP</strong>
within the <code class="docutils literal notranslate"><span class="pre">--pod-network-cidr</span></code> subnet. For example, with the default
<code class="docutils literal notranslate"><span class="pre">PodSubnetCIDR=10.1.0.0/16</span></code> and <code class="docutils literal notranslate"><span class="pre">PodIfIPCIDR=10.2.1.0/24</span></code>, the subnet
<code class="docutils literal notranslate"><span class="pre">10.3.0.0/16</span></code> could be allocated for the management network and
<code class="docutils literal notranslate"><span class="pre">--pod-network-cidr</span></code> could be defined as <code class="docutils literal notranslate"><span class="pre">10.0.0.0/8</span></code>, so as to include IP
addresses of all pods in all network namespaces:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubeadm</span> <span class="n">init</span> <span class="o">--</span><span class="n">token</span><span class="o">-</span><span class="n">ttl</span> <span class="mi">0</span> <span class="o">--</span><span class="n">pod</span><span class="o">-</span><span class="n">network</span><span class="o">-</span><span class="n">cidr</span><span class="o">=</span><span class="mf">10.0</span><span class="o">.</span><span class="mf">0.0</span><span class="o">/</span><span class="mi">8</span> <span class="o">--</span><span class="n">apiserver</span><span class="o">-</span><span class="n">advertise</span><span class="o">-</span><span class="n">address</span><span class="o">=</span><span class="mf">10.3</span><span class="o">.</span><span class="mf">1.1</span>
</pre></div>
</div>
<p>If Kubernetes was initialized successfully, it prints out this message:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Your Kubernetes master has initialized successfully!
</pre></div>
</div>
<p>After successful initialization, don’t forget to set up your .kube directory
as a regular user (as instructed by <code class="docutils literal notranslate"><span class="pre">kubeadm</span></code>):</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>mkdir -p <span class="nv">$HOME</span>/.kube
sudo cp -i /etc/kubernetes/admin.conf <span class="nv">$HOME</span>/.kube/config
sudo chown <span class="k">$(</span>id -u<span class="k">)</span>:<span class="k">$(</span>id -g<span class="k">)</span> <span class="nv">$HOME</span>/.kube/config
</pre></div>
</div>
</div>
<div class="section" id="installing-the-contiv-vpp-pod-network">
<h3>(3/4) Installing the Contiv-VPP Pod Network<a class="headerlink" href="#installing-the-contiv-vpp-pod-network" title="Permalink to this headline">¶</a></h3>
<p>If you have already used the Contiv-VPP plugin before, you may need to pull
the most recent Docker images on each node:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">bash</span> <span class="o">&lt;</span><span class="p">(</span><span class="n">curl</span> <span class="o">-</span><span class="n">s</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">raw</span><span class="o">.</span><span class="n">githubusercontent</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">contiv</span><span class="o">/</span><span class="n">vpp</span><span class="o">/</span><span class="n">master</span><span class="o">/</span><span class="n">k8s</span><span class="o">/</span><span class="n">pull</span><span class="o">-</span><span class="n">images</span><span class="o">.</span><span class="n">sh</span><span class="p">)</span>
</pre></div>
</div>
<p>Install the Contiv-VPP network for your cluster as follows:</p>
<ul>
<li><p>If you do not use the STN feature, install Contiv-vpp as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="n">apply</span> <span class="o">-</span><span class="n">f</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">raw</span><span class="o">.</span><span class="n">githubusercontent</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">contiv</span><span class="o">/</span><span class="n">vpp</span><span class="o">/</span><span class="n">master</span><span class="o">/</span><span class="n">k8s</span><span class="o">/</span><span class="n">contiv</span><span class="o">-</span><span class="n">vpp</span><span class="o">.</span><span class="n">yaml</span>
</pre></div>
</div>
</li>
<li><p>If you use the STN feature, download the <code class="docutils literal notranslate"><span class="pre">contiv-vpp.yaml</span></code> file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">wget</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">raw</span><span class="o">.</span><span class="n">githubusercontent</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">contiv</span><span class="o">/</span><span class="n">vpp</span><span class="o">/</span><span class="n">master</span><span class="o">/</span><span class="n">k8s</span><span class="o">/</span><span class="n">contiv</span><span class="o">-</span><span class="n">vpp</span><span class="o">.</span><span class="n">yaml</span>
</pre></div>
</div>
<p>Then edit the STN configuration as described <a class="reference external" href="https://github.com/contiv/vpp/tree/master/docs/SINGLE_NIC_SETUP.md#configuring-stn-in-contiv-vpp-k8s-deployment-files">here</a>. Finally, create
the Contiv-vpp deployment from the edited file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="n">apply</span> <span class="o">-</span><span class="n">f</span> <span class="o">./</span><span class="n">contiv</span><span class="o">-</span><span class="n">vpp</span><span class="o">.</span><span class="n">yaml</span>
</pre></div>
</div>
</li>
</ul>
<p>Beware contiv-etcd data is persisted in <code class="docutils literal notranslate"><span class="pre">/var/etcd</span></code> by default. It has to be cleaned up manually after <code class="docutils literal notranslate"><span class="pre">kubeadm</span> <span class="pre">reset</span></code>.
Otherwise outdated data will be loaded by a subsequent deployment.</p>
<p>You can also generate random subfolder, alternatively:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">curl</span> <span class="o">--</span><span class="n">silent</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">raw</span><span class="o">.</span><span class="n">githubusercontent</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">contiv</span><span class="o">/</span><span class="n">vpp</span><span class="o">/</span><span class="n">master</span><span class="o">/</span><span class="n">k8s</span><span class="o">/</span><span class="n">contiv</span><span class="o">-</span><span class="n">vpp</span><span class="o">.</span><span class="n">yaml</span> <span class="o">|</span> <span class="n">sed</span> <span class="s2">&quot;s/\/var\/etcd\/contiv-data/\/var\/etcd\/contiv-data\/$RANDOM/g&quot;</span> <span class="o">|</span> <span class="n">kubectl</span> <span class="n">apply</span> <span class="o">-</span><span class="n">f</span> <span class="o">-</span>
</pre></div>
</div>
<div class="section" id="deployment-verification">
<h4>Deployment Verification<a class="headerlink" href="#deployment-verification" title="Permalink to this headline">¶</a></h4>
<p>After some time, all contiv containers should enter the running state:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">root</span><span class="nd">@cvpp</span><span class="p">:</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">jan</span><span class="c1"># kubectl get pods -n kube-system -o wide | grep contiv</span>
<span class="n">NAME</span>                           <span class="n">READY</span>     <span class="n">STATUS</span>    <span class="n">RESTARTS</span>   <span class="n">AGE</span>       <span class="n">IP</span>               <span class="n">NODE</span>
<span class="o">...</span>
<span class="n">contiv</span><span class="o">-</span><span class="n">etcd</span><span class="o">-</span><span class="n">gwc84</span>              <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>       <span class="n">Running</span>   <span class="mi">0</span>          <span class="mi">14</span><span class="n">h</span>       <span class="mf">192.168</span><span class="o">.</span><span class="mf">56.106</span>   <span class="n">cvpp</span>
<span class="n">contiv</span><span class="o">-</span><span class="n">ksr</span><span class="o">-</span><span class="mi">5</span><span class="n">c2vk</span>               <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>       <span class="n">Running</span>   <span class="mi">2</span>          <span class="mi">14</span><span class="n">h</span>       <span class="mf">192.168</span><span class="o">.</span><span class="mf">56.106</span>   <span class="n">cvpp</span>
<span class="n">contiv</span><span class="o">-</span><span class="n">vswitch</span><span class="o">-</span><span class="n">l59nv</span>           <span class="mi">2</span><span class="o">/</span><span class="mi">2</span>       <span class="n">Running</span>   <span class="mi">0</span>          <span class="mi">14</span><span class="n">h</span>       <span class="mf">192.168</span><span class="o">.</span><span class="mf">56.106</span>   <span class="n">cvpp</span>
</pre></div>
</div>
<p>In particular, make sure that the Contiv-VPP pod IP addresses are the same as
the IP address specified in the <code class="docutils literal notranslate"><span class="pre">--apiserver-advertise-address=&lt;ip-address&gt;</span></code>
argument to kubeadm init.</p>
<p>Verify that the VPP successfully grabbed the network interface specified in
the VPP startup config (<code class="docutils literal notranslate"><span class="pre">GigabitEthernet0/4/0</span></code> in our case):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ sudo vppctl
vpp# sh inter
              Name               Idx       State          Counter          Count
GigabitEthernet0/4/0              1         up       rx packets                  1294
                                                     rx bytes                  153850
                                                     tx packets                   512
                                                     tx bytes                   21896
                                                     drops                        962
                                                     ip4                         1032
host-40df9b44c3d42f4              3         up       rx packets                126601
                                                     rx bytes                44628849
                                                     tx packets                132155
                                                     tx bytes                27205450
                                                     drops                         24
                                                     ip4                       126585
                                                     ip6                           16
host-vppv2                        2         up       rx packets                132162
                                                     rx bytes                27205824
                                                     tx packets                126658
                                                     tx bytes                44634963
                                                     drops                         15
                                                     ip4                       132147
                                                     ip6                           14
local0                            0        down
</pre></div>
</div>
<p>You should also see the interface to kube-dns (<code class="docutils literal notranslate"><span class="pre">host-40df9b44c3d42f4</span></code>) and to the
node’s IP stack (<code class="docutils literal notranslate"><span class="pre">host-vppv2</span></code>).</p>
</div>
<div class="section" id="master-isolation-optional">
<h4>Master Isolation (Optional)<a class="headerlink" href="#master-isolation-optional" title="Permalink to this headline">¶</a></h4>
<p>By default, your cluster will not schedule pods on the master for security
reasons. If you want to be able to schedule pods on the master, (e.g., for a
single-machine Kubernetes cluster for development), then run:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="n">taint</span> <span class="n">nodes</span> <span class="o">--</span><span class="nb">all</span> <span class="n">node</span><span class="o">-</span><span class="n">role</span><span class="o">.</span><span class="n">kubernetes</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">master</span><span class="o">-</span>
</pre></div>
</div>
<p>More details about installing the pod network can be found in the
<a class="reference external" href="https://kubernetes.io/docs/setup/independent/create-cluster-kubeadm/#pod-network">kubeadm manual</a>.</p>
</div>
</div>
<div class="section" id="joining-your-nodes">
<h3>(4/4) Joining Your Nodes<a class="headerlink" href="#joining-your-nodes" title="Permalink to this headline">¶</a></h3>
<p>To add a new node to your cluster, run as root the command that was output
by kubeadm init. For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubeadm</span> <span class="n">join</span> <span class="o">--</span><span class="n">token</span> <span class="o">&lt;</span><span class="n">token</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="n">master</span><span class="o">-</span><span class="n">ip</span><span class="o">&gt;</span><span class="p">:</span><span class="o">&lt;</span><span class="n">master</span><span class="o">-</span><span class="n">port</span><span class="o">&gt;</span> <span class="o">--</span><span class="n">discovery</span><span class="o">-</span><span class="n">token</span><span class="o">-</span><span class="n">ca</span><span class="o">-</span><span class="n">cert</span><span class="o">-</span><span class="nb">hash</span> <span class="n">sha256</span><span class="p">:</span><span class="o">&lt;</span><span class="nb">hash</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>More details can be found int the <a class="reference external" href="https://kubernetes.io/docs/setup/independent/create-cluster-kubeadm/#joining-your-nodes">kubeadm manual</a>.</p>
<div class="section" id="id1">
<h4>Deployment Verification<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h4>
<p>After some time, all contiv containers should enter the running state:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">root</span><span class="nd">@cvpp</span><span class="p">:</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">jan</span><span class="c1"># kubectl get pods -n kube-system -o wide | grep contiv</span>
<span class="n">NAME</span>                           <span class="n">READY</span>     <span class="n">STATUS</span>    <span class="n">RESTARTS</span>   <span class="n">AGE</span>       <span class="n">IP</span>               <span class="n">NODE</span>
<span class="n">contiv</span><span class="o">-</span><span class="n">etcd</span><span class="o">-</span><span class="n">gwc84</span>              <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>       <span class="n">Running</span>   <span class="mi">0</span>          <span class="mi">14</span><span class="n">h</span>       <span class="mf">192.168</span><span class="o">.</span><span class="mf">56.106</span>   <span class="n">cvpp</span>
<span class="n">contiv</span><span class="o">-</span><span class="n">ksr</span><span class="o">-</span><span class="mi">5</span><span class="n">c2vk</span>               <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>       <span class="n">Running</span>   <span class="mi">2</span>          <span class="mi">14</span><span class="n">h</span>       <span class="mf">192.168</span><span class="o">.</span><span class="mf">56.106</span>   <span class="n">cvpp</span>
<span class="n">contiv</span><span class="o">-</span><span class="n">vswitch</span><span class="o">-</span><span class="n">h6759</span>           <span class="mi">2</span><span class="o">/</span><span class="mi">2</span>       <span class="n">Running</span>   <span class="mi">0</span>          <span class="mi">14</span><span class="n">h</span>       <span class="mf">192.168</span><span class="o">.</span><span class="mf">56.105</span>   <span class="n">cvpp</span><span class="o">-</span><span class="n">slave2</span>
<span class="n">contiv</span><span class="o">-</span><span class="n">vswitch</span><span class="o">-</span><span class="n">l59nv</span>           <span class="mi">2</span><span class="o">/</span><span class="mi">2</span>       <span class="n">Running</span>   <span class="mi">0</span>          <span class="mi">14</span><span class="n">h</span>       <span class="mf">192.168</span><span class="o">.</span><span class="mf">56.106</span>   <span class="n">cvpp</span>
<span class="n">etcd</span><span class="o">-</span><span class="n">cvpp</span>                      <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>       <span class="n">Running</span>   <span class="mi">0</span>          <span class="mi">14</span><span class="n">h</span>       <span class="mf">192.168</span><span class="o">.</span><span class="mf">56.106</span>   <span class="n">cvpp</span>
<span class="n">kube</span><span class="o">-</span><span class="n">apiserver</span><span class="o">-</span><span class="n">cvpp</span>            <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>       <span class="n">Running</span>   <span class="mi">0</span>          <span class="mi">14</span><span class="n">h</span>       <span class="mf">192.168</span><span class="o">.</span><span class="mf">56.106</span>   <span class="n">cvpp</span>
<span class="n">kube</span><span class="o">-</span><span class="n">controller</span><span class="o">-</span><span class="n">manager</span><span class="o">-</span><span class="n">cvpp</span>   <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>       <span class="n">Running</span>   <span class="mi">0</span>          <span class="mi">14</span><span class="n">h</span>       <span class="mf">192.168</span><span class="o">.</span><span class="mf">56.106</span>   <span class="n">cvpp</span>
<span class="n">kube</span><span class="o">-</span><span class="n">dns</span><span class="o">-</span><span class="mi">545</span><span class="n">bc4bfd4</span><span class="o">-</span><span class="n">fr6j9</span>      <span class="mi">3</span><span class="o">/</span><span class="mi">3</span>       <span class="n">Running</span>   <span class="mi">0</span>          <span class="mi">14</span><span class="n">h</span>       <span class="mf">10.1</span><span class="o">.</span><span class="mf">134.2</span>       <span class="n">cvpp</span>
<span class="n">kube</span><span class="o">-</span><span class="n">proxy</span><span class="o">-</span><span class="n">q8sv2</span>               <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>       <span class="n">Running</span>   <span class="mi">0</span>          <span class="mi">14</span><span class="n">h</span>       <span class="mf">192.168</span><span class="o">.</span><span class="mf">56.106</span>   <span class="n">cvpp</span>
<span class="n">kube</span><span class="o">-</span><span class="n">proxy</span><span class="o">-</span><span class="n">s8kv9</span>               <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>       <span class="n">Running</span>   <span class="mi">0</span>          <span class="mi">14</span><span class="n">h</span>       <span class="mf">192.168</span><span class="o">.</span><span class="mf">56.105</span>   <span class="n">cvpp</span><span class="o">-</span><span class="n">slave2</span>
<span class="n">kube</span><span class="o">-</span><span class="n">scheduler</span><span class="o">-</span><span class="n">cvpp</span>            <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>       <span class="n">Running</span>   <span class="mi">0</span>          <span class="mi">14</span><span class="n">h</span>       <span class="mf">192.168</span><span class="o">.</span><span class="mf">56.106</span>   <span class="n">cvpp</span>
</pre></div>
</div>
<p>In particular, verify that a vswitch pod and a kube-proxy pod is running on
each joined node, as shown above.</p>
<p>On each joined node, verify that the VPP successfully grabbed the network
interface specified in the VPP startup config (<code class="docutils literal notranslate"><span class="pre">GigabitEthernet0/4/0</span></code> in
our case):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ sudo vppctl
vpp# sh inter
              Name               Idx       State          Counter          Count
GigabitEthernet0/4/0              1         up
...
</pre></div>
</div>
<p>From the vpp CLI on a joined node you can also ping kube-dns to verify
node-to-node connectivity. For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">vpp</span><span class="c1"># ping 10.1.134.2</span>
<span class="mi">64</span> <span class="nb">bytes</span> <span class="kn">from</span> <span class="mf">10.1</span><span class="o">.</span><span class="mf">134.2</span><span class="p">:</span> <span class="n">icmp_seq</span><span class="o">=</span><span class="mi">1</span> <span class="n">ttl</span><span class="o">=</span><span class="mi">64</span> <span class="n">time</span><span class="o">=.</span><span class="mi">1557</span> <span class="n">ms</span>
<span class="mi">64</span> <span class="nb">bytes</span> <span class="kn">from</span> <span class="mf">10.1</span><span class="o">.</span><span class="mf">134.2</span><span class="p">:</span> <span class="n">icmp_seq</span><span class="o">=</span><span class="mi">2</span> <span class="n">ttl</span><span class="o">=</span><span class="mi">64</span> <span class="n">time</span><span class="o">=.</span><span class="mi">1339</span> <span class="n">ms</span>
<span class="mi">64</span> <span class="nb">bytes</span> <span class="kn">from</span> <span class="mf">10.1</span><span class="o">.</span><span class="mf">134.2</span><span class="p">:</span> <span class="n">icmp_seq</span><span class="o">=</span><span class="mi">3</span> <span class="n">ttl</span><span class="o">=</span><span class="mi">64</span> <span class="n">time</span><span class="o">=.</span><span class="mi">1295</span> <span class="n">ms</span>
<span class="mi">64</span> <span class="nb">bytes</span> <span class="kn">from</span> <span class="mf">10.1</span><span class="o">.</span><span class="mf">134.2</span><span class="p">:</span> <span class="n">icmp_seq</span><span class="o">=</span><span class="mi">4</span> <span class="n">ttl</span><span class="o">=</span><span class="mi">64</span> <span class="n">time</span><span class="o">=.</span><span class="mi">1714</span> <span class="n">ms</span>
<span class="mi">64</span> <span class="nb">bytes</span> <span class="kn">from</span> <span class="mf">10.1</span><span class="o">.</span><span class="mf">134.2</span><span class="p">:</span> <span class="n">icmp_seq</span><span class="o">=</span><span class="mi">5</span> <span class="n">ttl</span><span class="o">=</span><span class="mi">64</span> <span class="n">time</span><span class="o">=.</span><span class="mi">1317</span> <span class="n">ms</span>

<span class="n">Statistics</span><span class="p">:</span> <span class="mi">5</span> <span class="n">sent</span><span class="p">,</span> <span class="mi">5</span> <span class="n">received</span><span class="p">,</span> <span class="mi">0</span><span class="o">%</span> <span class="n">packet</span> <span class="n">loss</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="deploying-example-applications">
<h3>Deploying Example Applications<a class="headerlink" href="#deploying-example-applications" title="Permalink to this headline">¶</a></h3>
<div class="section" id="simple-deployment">
<h4>Simple Deployment<a class="headerlink" href="#simple-deployment" title="Permalink to this headline">¶</a></h4>
<p>You can go ahead and create a simple deployment:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ kubectl run nginx --image=nginx --replicas=2
</pre></div>
</div>
<p>Use <code class="docutils literal notranslate"><span class="pre">kubectl</span> <span class="pre">describe</span> <span class="pre">pod</span></code> to get the IP address of a pod, e.g.:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ kubectl describe pod nginx | grep IP
</pre></div>
</div>
<p>You should see two ip addresses, for example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">IP</span><span class="p">:</span>		<span class="mf">10.1</span><span class="o">.</span><span class="mf">1.3</span>
<span class="n">IP</span><span class="p">:</span>		<span class="mf">10.1</span><span class="o">.</span><span class="mf">1.4</span>
</pre></div>
</div>
<p>You can check the pods’ connectivity in one of the following ways:</p>
<ul class="simple">
<li><p>Connect to the VPP debug CLI and ping any pod:</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="n">sudo</span> <span class="n">vppctl</span>
  <span class="n">vpp</span><span class="c1"># ping 10.1.1.3</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Start busybox and ping any pod:</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="n">kubectl</span> <span class="n">run</span> <span class="n">busybox</span> <span class="o">--</span><span class="n">rm</span> <span class="o">-</span><span class="n">ti</span> <span class="o">--</span><span class="n">image</span><span class="o">=</span><span class="n">busybox</span> <span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">sh</span>
  <span class="n">If</span> <span class="n">you</span> <span class="n">don</span><span class="s1">&#39;t see a command prompt, try pressing enter.</span>
  <span class="o">/</span> <span class="c1">#</span>
  <span class="o">/</span> <span class="c1"># ping 10.1.1.3</span>
</pre></div>
</div>
<ul class="simple">
<li><p>You should be able to ping any pod from the host:</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="n">ping</span> <span class="mf">10.1</span><span class="o">.</span><span class="mf">1.3</span>
</pre></div>
</div>
</div>
<div class="section" id="deploying-pods-on-different-nodes">
<h4>Deploying Pods on Different Nodes<a class="headerlink" href="#deploying-pods-on-different-nodes" title="Permalink to this headline">¶</a></h4>
<p>to enable pod deployment on the master, untaint the master first:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="n">taint</span> <span class="n">nodes</span> <span class="o">--</span><span class="nb">all</span> <span class="n">node</span><span class="o">-</span><span class="n">role</span><span class="o">.</span><span class="n">kubernetes</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">master</span><span class="o">-</span>
</pre></div>
</div>
<p>In order to verify inter-node pod connectivity, we need to tell Kubernetes
to deploy one pod on the master node and one POD on the worker. For this,
we can use node selectors.</p>
<p>In your deployment YAMLs, add the <code class="docutils literal notranslate"><span class="pre">nodeSelector</span></code> sections that refer to
preferred node hostnames, e.g.:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="n">nodeSelector</span><span class="p">:</span>
    <span class="n">kubernetes</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">hostname</span><span class="p">:</span> <span class="n">vm5</span>
</pre></div>
</div>
<p>Example of whole JSONs:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">apiVersion</span><span class="p">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">Pod</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">nginx1</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="n">nodeSelector</span><span class="p">:</span>
    <span class="n">kubernetes</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">hostname</span><span class="p">:</span> <span class="n">vm5</span>
  <span class="n">containers</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">nginx</span>
      
	  <span class="p">:</span> <span class="n">nginx</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">apiVersion</span><span class="p">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">Pod</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">nginx2</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="n">nodeSelector</span><span class="p">:</span>
    <span class="n">kubernetes</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">hostname</span><span class="p">:</span> <span class="n">vm6</span>
  <span class="n">containers</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">nginx</span>
      <span class="n">image</span><span class="p">:</span> <span class="n">nginx</span>
</pre></div>
</div>
<p>After deploying the JSONs, verify they were deployed on different hosts:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ kubectl get pods -o wide
NAME      READY     STATUS    RESTARTS   AGE       IP           NODE
nginx1    1/1       Running   0          13m       10.1.36.2    vm5
nginx2    1/1       Running   0          13m       10.1.219.3   vm6
</pre></div>
</div>
<p>Now you can verify the connectivity to both nginx PODs from a busybox POD:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="n">run</span> <span class="n">busybox</span> <span class="o">--</span><span class="n">rm</span> <span class="o">-</span><span class="n">it</span> <span class="o">--</span><span class="n">image</span><span class="o">=</span><span class="n">busybox</span> <span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">sh</span>

<span class="o">/</span> <span class="c1"># wget 10.1.36.2</span>
<span class="n">Connecting</span> <span class="n">to</span> <span class="mf">10.1</span><span class="o">.</span><span class="mf">36.2</span> <span class="p">(</span><span class="mf">10.1</span><span class="o">.</span><span class="mf">36.2</span><span class="p">:</span><span class="mi">80</span><span class="p">)</span>
<span class="n">index</span><span class="o">.</span><span class="n">html</span>           <span class="mi">100</span><span class="o">%</span> <span class="o">|*******************************************************************************************************************************************************************|</span>   <span class="mi">612</span>   <span class="mi">0</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span> <span class="n">ETA</span>

<span class="o">/</span> <span class="c1"># rm index.html</span>

<span class="o">/</span> <span class="c1"># wget 10.1.219.3</span>
<span class="n">Connecting</span> <span class="n">to</span> <span class="mf">10.1</span><span class="o">.</span><span class="mf">219.3</span> <span class="p">(</span><span class="mf">10.1</span><span class="o">.</span><span class="mf">219.3</span><span class="p">:</span><span class="mi">80</span><span class="p">)</span>
<span class="n">index</span><span class="o">.</span><span class="n">html</span>           <span class="mi">100</span><span class="o">%</span> <span class="o">|*******************************************************************************************************************************************************************|</span>   <span class="mi">612</span>   <span class="mi">0</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span> <span class="n">ETA</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="uninstalling-contiv-vpp">
<h3>Uninstalling Contiv-VPP<a class="headerlink" href="#uninstalling-contiv-vpp" title="Permalink to this headline">¶</a></h3>
<p>To uninstall the network plugin itself, use <code class="docutils literal notranslate"><span class="pre">kubectl</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="n">delete</span> <span class="o">-</span><span class="n">f</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">raw</span><span class="o">.</span><span class="n">githubusercontent</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">contiv</span><span class="o">/</span><span class="n">vpp</span><span class="o">/</span><span class="n">master</span><span class="o">/</span><span class="n">k8s</span><span class="o">/</span><span class="n">contiv</span><span class="o">-</span><span class="n">vpp</span><span class="o">.</span><span class="n">yaml</span>
</pre></div>
</div>
</div>
<div class="section" id="tearing-down-kubernetes">
<h3>Tearing down Kubernetes<a class="headerlink" href="#tearing-down-kubernetes" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>First, drain the node and make sure that the node is empty before
shutting it down:</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="n">kubectl</span> <span class="n">drain</span> <span class="o">&lt;</span><span class="n">node</span> <span class="n">name</span><span class="o">&gt;</span> <span class="o">--</span><span class="n">delete</span><span class="o">-</span><span class="n">local</span><span class="o">-</span><span class="n">data</span> <span class="o">--</span><span class="n">force</span> <span class="o">--</span><span class="n">ignore</span><span class="o">-</span><span class="n">daemonsets</span>
  <span class="n">kubectl</span> <span class="n">delete</span> <span class="n">node</span> <span class="o">&lt;</span><span class="n">node</span> <span class="n">name</span><span class="o">&gt;</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Next, on the node being removed, reset all kubeadm installed state:</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  rm -rf $HOME/.kube
  sudo su
  kubeadm reset
</pre></div>
</div>
<ul class="simple">
<li><p>If you added environment variable definitions into
<code class="docutils literal notranslate"><span class="pre">/etc/systemd/system/kubelet.service.d/10-kubeadm.conf</span></code>, this would have been a process from the <a class="reference external" href="https://github.com/contiv/vpp/blob/master/docs/CUSTOM_MGMT_NETWORK.md#setting-up-a-custom-management-network-on-multi-homed-nodes">Custom Management Network file</a>, then remove the definitions now.</p></li>
</ul>
</div>
<div class="section" id="troubleshooting">
<h3>Troubleshooting<a class="headerlink" href="#troubleshooting" title="Permalink to this headline">¶</a></h3>
<p>Some of the issues that can occur during the installation are:</p>
<ul>
<li><p>Forgetting to create and initialize the <code class="docutils literal notranslate"><span class="pre">.kube</span></code> directory in your home
directory (As instructed by <code class="docutils literal notranslate"><span class="pre">kubeadm</span> <span class="pre">init</span> <span class="pre">--token-ttl</span> <span class="pre">0</span></code>). This can manifest
itself as the following error:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">W1017</span> <span class="mi">09</span><span class="p">:</span><span class="mi">25</span><span class="p">:</span><span class="mf">43.403159</span>    <span class="mi">2233</span> <span class="n">factory_object_mapping</span><span class="o">.</span><span class="n">go</span><span class="p">:</span><span class="mi">423</span><span class="p">]</span> <span class="n">Failed</span> <span class="n">to</span> <span class="n">download</span> <span class="n">OpenAPI</span> <span class="p">(</span><span class="n">Get</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="mf">192.168</span><span class="o">.</span><span class="mf">209.128</span><span class="p">:</span><span class="mi">6443</span><span class="o">/</span><span class="n">swagger</span><span class="o">-</span><span class="mf">2.0</span><span class="o">.</span><span class="mf">0.</span><span class="n">pb</span><span class="o">-</span><span class="n">v1</span><span class="p">:</span> <span class="n">x509</span><span class="p">:</span> <span class="n">certificate</span> <span class="n">signed</span> <span class="n">by</span> <span class="n">unknown</span> <span class="n">authority</span> <span class="p">(</span><span class="n">possibly</span> <span class="n">because</span> <span class="n">of</span> <span class="s2">&quot;crypto/rsa: verification error&quot;</span> <span class="k">while</span> <span class="n">trying</span> <span class="n">to</span> <span class="n">verify</span> <span class="n">candidate</span> <span class="n">authority</span> <span class="n">certificate</span> <span class="s2">&quot;kubernetes&quot;</span><span class="p">)),</span> <span class="n">falling</span> <span class="n">back</span> <span class="n">to</span> <span class="n">swagger</span>
<span class="n">Unable</span> <span class="n">to</span> <span class="n">connect</span> <span class="n">to</span> <span class="n">the</span> <span class="n">server</span><span class="p">:</span> <span class="n">x509</span><span class="p">:</span> <span class="n">certificate</span> <span class="n">signed</span> <span class="n">by</span> <span class="n">unknown</span> <span class="n">authority</span> <span class="p">(</span><span class="n">possibly</span> <span class="n">because</span> <span class="n">of</span> <span class="s2">&quot;crypto/rsa: verification error&quot;</span> <span class="k">while</span> <span class="n">trying</span> <span class="n">to</span> <span class="n">verify</span> <span class="n">candidate</span> <span class="n">authority</span> <span class="n">certificate</span> <span class="s2">&quot;kubernetes&quot;</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p>Previous installation lingering on the file system.
<code class="docutils literal notranslate"><span class="pre">'kubeadm</span> <span class="pre">init</span> <span class="pre">--token-ttl</span> <span class="pre">0</span></code> fails to initialize kubelet with one or more
of the following error messages:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">...</span>
<span class="p">[</span><span class="n">kubelet</span><span class="o">-</span><span class="n">check</span><span class="p">]</span> <span class="n">It</span> <span class="n">seems</span> <span class="n">like</span> <span class="n">the</span> <span class="n">kubelet</span> <span class="n">isn</span><span class="s1">&#39;t running or healthy.</span>
<span class="p">[</span><span class="n">kubelet</span><span class="o">-</span><span class="n">check</span><span class="p">]</span> <span class="n">The</span> <span class="n">HTTP</span> <span class="n">call</span> <span class="n">equal</span> <span class="n">to</span> <span class="s1">&#39;curl -sSL http://localhost:10255/healthz&#39;</span> <span class="n">failed</span> <span class="k">with</span> <span class="n">error</span><span class="p">:</span> <span class="n">Get</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span><span class="p">:</span><span class="mi">10255</span><span class="o">/</span><span class="n">healthz</span><span class="p">:</span> <span class="n">dial</span> <span class="n">tcp</span> <span class="p">[::</span><span class="mi">1</span><span class="p">]:</span><span class="mi">10255</span><span class="p">:</span> <span class="n">getsockopt</span><span class="p">:</span> <span class="n">connection</span> <span class="n">refused</span><span class="o">.</span>
<span class="o">...</span>
</pre></div>
</div>
</li>
</ul>
<p>If you run into any of the above issues, try to clean up and reinstall as root:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>sudo su
rm -rf $HOME/.kube
kubeadm reset
kubeadm init --token-ttl 0
rm -rf /var/etcd/contiv-data
rm -rf /var/bolt/bolt.db
</pre></div>
</div>
</div>
</div>
<div class="section" id="contiv-specific-kubeadm-installation-on-aarch64">
<h2>Contiv-specific kubeadm installation on Aarch64<a class="headerlink" href="#contiv-specific-kubeadm-installation-on-aarch64" title="Permalink to this headline">¶</a></h2>
<p>Supplemental instructions apply when using Contiv-VPP for Aarch64. Most
installation steps for Aarch64 are the same as that described earlier in this
chapter, so you should firstly read it before you start the installation on
Aarch64 platform.</p>
<p>Use the <a class="reference external" href="https://github.com/contiv/vpp/blob/master/docs/arm64/MANUAL_INSTALL_ARM64">Aarch64-specific kubeadm install instructions</a> to manually install
Kubernetes with Contiv-VPP networking on one or more bare-metals of Aarch64 platform.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="VPP_CONFIG.html" class="btn btn-neutral float-right" title="Creating VPP Startup Configuration" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="Vagrant.html" class="btn btn-neutral float-left" title="Contiv-VPP Vagrant Installation" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, Linux Foundation

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>