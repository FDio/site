<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Intel AVF device driver &mdash; The Vector Packet Processor v22.02-rc0-128-g4450b03ba
 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/rules.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="RDMA (ibverb) device driver" href="rdma.html" />
    <link rel="prev" title="Device drivers" href="index.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> The Vector Packet Processor
            <img src="../../_static/fd-io_red_white.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                v22.02-rc0-128-g4450b03ba

              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">About VPP</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../aboutvpp/scalar-vs-vector-packet-processing.html">Scalar vs Vector packet processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../aboutvpp/extensible.html">The Packet Processing Graph</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../aboutvpp/networkstack.html">Network Stack Features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../aboutvpp/hoststack.html">Host Stack</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../aboutvpp/developer.html">Additional features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../aboutvpp/supported.html">Supported archs and OS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../aboutvpp/performance.html">Performance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../aboutvpp/releasenotes/index.html">Release notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../aboutvpp/featurelist.html">VPP Supported Features</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Use Cases</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../usecases/containers/index.html">VPP with Containers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usecases/simpleperf/index.html">VPP with Iperf3 and TRex</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usecases/vppcloud/index.html">VPP in the Cloud</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usecases/vhost/index.html">VPP with Virtual Machines</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usecases/vmxnet3.html">VPP with VMware/Vmxnet3</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usecases/home_gateway.html">VPP as a Home Gateway</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usecases/acls.html">Access Control Lists with VPP</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usecases/networksim.html">Generating traffic with VPP</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usecases/webapp.html">Web applications with VPP</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usecases/container_test.html">Simulating networks with VPP</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usecases/trafficgen.html">Stateless Traffic Gen with VPP</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usecases/ikev2/index.html">IKEv2 with VPP</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usecases/contiv/index.html">VPP in kubernetes (Contiv/Deprecated)</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Getting started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../gettingstarted/installing/index.html">Downloading and Installing VPP</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../gettingstarted/running/index.html">Running VPP</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../gettingstarted/progressivevpp/index.html">Progressive VPP Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../gettingstarted/troubleshooting/index.html">Troubleshooting</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developer Documentation</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../build-run-debug/index.html">Build, Run &amp; Debug</a></li>
<li class="toctree-l1"><a class="reference internal" href="../corearchitecture/index.html">Core Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../corefeatures/index.html">Core Features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../plugindoc/index.html">Adding a new plugin or feature</a></li>
<li class="toctree-l1"><a class="reference internal" href="../plugins/index.html">Plugins</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Device drivers</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="#">Intel AVF device driver</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#overview">Overview</a></li>
<li class="toctree-l3"><a class="reference internal" href="#prerequisites">Prerequisites</a></li>
<li class="toctree-l3"><a class="reference internal" href="#known-issues">Known issues</a></li>
<li class="toctree-l3"><a class="reference internal" href="#usage">Usage</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#system-setup">System setup</a></li>
<li class="toctree-l4"><a class="reference internal" href="#promisc-mode">Promisc mode</a></li>
<li class="toctree-l4"><a class="reference internal" href="#l2-spoofing-check">L2 spoofing check</a></li>
<li class="toctree-l4"><a class="reference internal" href="#interface-creation">Interface Creation</a></li>
<li class="toctree-l4"><a class="reference internal" href="#interface-deletion">Interface Deletion</a></li>
<li class="toctree-l4"><a class="reference internal" href="#interface-statistics">Interface Statistics</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="rdma.html">RDMA (ibverb) device driver</a></li>
<li class="toctree-l2"><a class="reference internal" href="vmxnet3.html">VMWARE vmxnet3 device driver</a></li>
<li class="toctree-l2"><a class="reference internal" href="af_xdp.html">AF_XDP device driver</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../tests/overview.html">VPP Test Framework</a></li>
<li class="toctree-l1"><a class="reference internal" href="../extras/index.html">VPP extra tools</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Interfacing with VPP</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../interfacing/binapi/index.html">The binary API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../interfacing/c/index.html">C api client</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../interfacing/cpp/index.html">C++ api client</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../interfacing/go/index.html">Go api (govpp)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../interfacing/rust/index.html">Rust api client</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../interfacing/libmemif/index.html">Memif library (libmemif)</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Contributing</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../contributing/gitreview.html">Getting a Patch Reviewed</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contributing/writingdocs.html">Writing VPP Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contributing/reportingissues/index.html">Reporting Bugs</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Debug CLI</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../cli-reference/gettingstarted/index.html">Getting Started with the debug CLI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cli-reference/interface/index.html">Interface Commands</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cli-reference/index.html">Reference</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Configuration file</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../configuration/config_getting_started.html">Getting started with the configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../configuration/reference.html">Configuration Reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">The Vector Packet Processor</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="index.html">Device drivers</a> &raquo;</li>
      <li>Intel AVF device driver</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/developer/devicedrivers/avf.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="intel-avf-device-driver">
<h1>Intel AVF device driver<a class="headerlink" href="#intel-avf-device-driver" title="Permalink to this headline"></a></h1>
<section id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline"></a></h2>
<p>This plugins provides native device support for intel Adaptive Virtual
Function (AVF). AVF is driver specification for current and future Intel
Virtual Function devices. AVF defines communication channel between
Physical Functions (PF) and VF. In essence, today this driver can be
used only with Intel XL710 / X710 / XXV710 adapters.</p>
</section>
<section id="prerequisites">
<h2>Prerequisites<a class="headerlink" href="#prerequisites" title="Permalink to this headline"></a></h2>
<ul class="simple">
<li><p>Driver requires newer i40e PF linux driver to be installed on the
system, which supports virtualchnl interface. This code is tested
with i40e driver version 2.4.6.</p></li>
<li><p>Driver requires MSI-X interrupt support, which is not supported by
uio_pci_generic driver, so vfio-pci needs to be used. On systems
without IOMMU vfio driver can still be used with recent kernels which
support no-iommu mode.</p></li>
</ul>
</section>
<section id="known-issues">
<h2>Known issues<a class="headerlink" href="#known-issues" title="Permalink to this headline"></a></h2>
<p>This driver is still in experimental phase, however it shows very good
performance numbers.</p>
</section>
<section id="usage">
<h2>Usage<a class="headerlink" href="#usage" title="Permalink to this headline"></a></h2>
<section id="system-setup">
<h3>System setup<a class="headerlink" href="#system-setup" title="Permalink to this headline"></a></h3>
<ol class="arabic simple">
<li><p>load VFIO driver</p></li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">modprobe</span> <span class="n">vfio</span><span class="o">-</span><span class="n">pci</span>
</pre></div>
</div>
<ol class="arabic simple" start="2">
<li><p>(systems without IOMMU only) enable unsafe NOIOMMU mode</p></li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">echo</span> <span class="n">Y</span> <span class="o">|</span> <span class="n">sudo</span> <span class="n">tee</span> <span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">module</span><span class="o">/</span><span class="n">vfio</span><span class="o">/</span><span class="n">parameters</span><span class="o">/</span><span class="n">enable_unsafe_noiommu_mode</span>
</pre></div>
</div>
<ol class="arabic simple" start="3">
<li><p>Create and bind SR-IOV virtual function(s)</p></li>
</ol>
<p>Following script creates VF, assigns MAC address and binds VF to
vfio-pci</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>

<span class="k">if</span> <span class="o">[</span> <span class="nv">$USER</span> !<span class="o">=</span> <span class="s2">&quot;root&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
    <span class="nb">echo</span> <span class="s2">&quot;Restarting script with sudo...&quot;</span>
    sudo <span class="nv">$0</span> <span class="si">${</span><span class="p">*</span><span class="si">}</span>
    <span class="nb">exit</span>
<span class="k">fi</span>

setup <span class="o">()</span> <span class="o">{</span>
  <span class="nb">cd</span> /sys/bus/pci/devices/<span class="si">${</span><span class="nv">1</span><span class="si">}</span>
  <span class="nv">driver</span><span class="o">=</span><span class="k">$(</span>basename <span class="k">$(</span>readlink driver<span class="k">))</span>
  <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">driver</span><span class="si">}</span><span class="s2">&quot;</span> !<span class="o">=</span> <span class="s2">&quot;i40e&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    <span class="nb">echo</span> <span class="si">${</span><span class="nv">1</span><span class="si">}</span> <span class="p">|</span> tee driver/unbind
    <span class="nb">echo</span> <span class="si">${</span><span class="nv">1</span><span class="si">}</span> <span class="p">|</span> tee /sys/bus/pci/drivers/i40e/bind
  <span class="k">fi</span>
  <span class="nv">ifname</span><span class="o">=</span><span class="k">$(</span>basename net/*<span class="k">)</span>
  <span class="nb">echo</span> <span class="m">0</span> <span class="p">|</span> tee sriov_numvfs &gt; /dev/null
  <span class="nb">echo</span> <span class="m">1</span> <span class="p">|</span> tee sriov_numvfs &gt; /dev/null
  ip link <span class="nb">set</span> dev <span class="si">${</span><span class="nv">ifname</span><span class="si">}</span> vf <span class="m">0</span> mac <span class="si">${</span><span class="nv">2</span><span class="si">}</span>
  ip link show dev <span class="si">${</span><span class="nv">ifname</span><span class="si">}</span>
  <span class="nv">vf</span><span class="o">=</span><span class="k">$(</span>basename <span class="k">$(</span>readlink virtfn0<span class="k">))</span>
  <span class="nb">echo</span> <span class="si">${</span><span class="nv">vf</span><span class="si">}</span> <span class="p">|</span> tee virtfn0/driver/unbind
  <span class="nb">echo</span> vfio-pci <span class="p">|</span> tee virtfn0/driver_override
  <span class="nb">echo</span> <span class="si">${</span><span class="nv">vf</span><span class="si">}</span> <span class="p">|</span> sudo tee /sys/bus/pci/drivers/vfio-pci/bind
  <span class="nb">echo</span>  <span class="p">|</span> tee virtfn0/driver_override
<span class="o">}</span>

<span class="c1"># Setup one VF on PF 0000:3b:00.0 and assign MAC address</span>
setup <span class="m">0000</span>:3b:00.0 <span class="m">00</span>:11:22:33:44:00
<span class="c1"># Setup one VF on PF 0000:3b:00.1 and assign MAC address</span>
setup <span class="m">0000</span>:3b:00.1 <span class="m">00</span>:11:22:33:44:01
</pre></div>
</div>
</section>
<section id="promisc-mode">
<h3>Promisc mode<a class="headerlink" href="#promisc-mode" title="Permalink to this headline"></a></h3>
<p>In cases when interface is used in the L2 mode or promisc mode is needed
for some other reason, trust needs to be set to “on” using the linux “ip
link” utility.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ip</span> <span class="n">link</span> <span class="nb">set</span> <span class="n">dev</span> <span class="o">&lt;</span><span class="n">PF</span> <span class="n">inteface</span> <span class="n">name</span><span class="o">&gt;</span> <span class="n">vf</span> <span class="o">&lt;</span><span class="n">VF</span> <span class="nb">id</span><span class="o">&gt;</span> <span class="n">trust</span> <span class="n">on</span>
</pre></div>
</div>
</section>
<section id="l2-spoofing-check">
<h3>L2 spoofing check<a class="headerlink" href="#l2-spoofing-check" title="Permalink to this headline"></a></h3>
<p>By default Virtual Function is not allowed to send ethernet frames which
have source MAC address different than address assigned to the VF. In
some cases it is expected that VPP will send such frames (e.g. L2
bridging, bonding, l2 cross-connect) and in such cases spoof check needs
to be turned off by issuing following command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ip</span> <span class="n">link</span> <span class="nb">set</span> <span class="n">dev</span> <span class="o">&lt;</span><span class="n">PF</span> <span class="n">inteface</span> <span class="n">name</span><span class="o">&gt;</span> <span class="n">vf</span> <span class="o">&lt;</span><span class="n">VF</span> <span class="nb">id</span><span class="o">&gt;</span> <span class="n">spoofchk</span> <span class="n">off</span>
</pre></div>
</div>
</section>
<section id="interface-creation">
<h3>Interface Creation<a class="headerlink" href="#interface-creation" title="Permalink to this headline"></a></h3>
<p>Interfaces can be dynamically created by using following CLI:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">create</span> <span class="n">interface</span> <span class="n">avf</span> <span class="mi">0000</span><span class="p">:</span><span class="mi">3</span><span class="n">b</span><span class="p">:</span><span class="mf">02.0</span>
<span class="nb">set</span> <span class="nb">int</span> <span class="n">state</span> <span class="n">avf</span><span class="o">-</span><span class="mi">0</span><span class="o">/</span><span class="mi">3</span><span class="n">b</span><span class="o">/</span><span class="mi">2</span><span class="o">/</span><span class="mi">0</span> <span class="n">up</span>
</pre></div>
</div>
</section>
<section id="interface-deletion">
<h3>Interface Deletion<a class="headerlink" href="#interface-deletion" title="Permalink to this headline"></a></h3>
<p>Interface can be deleted with following CLI:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">delete</span> <span class="n">interface</span> <span class="n">avf</span> <span class="o">&lt;</span><span class="n">interface</span> <span class="n">name</span><span class="o">&gt;</span>
</pre></div>
</div>
</section>
<section id="interface-statistics">
<h3>Interface Statistics<a class="headerlink" href="#interface-statistics" title="Permalink to this headline"></a></h3>
<p>Interface statistics can be displayed with
<code class="docutils literal notranslate"><span class="pre">sh</span> <span class="pre">hardware-interface</span> <span class="pre">&lt;if-name&gt;</span></code> command.</p>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="index.html" class="btn btn-neutral float-left" title="Device drivers" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="rdma.html" class="btn btn-neutral float-right" title="RDMA (ibverb) device driver" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2018-2021, Linux Foundation.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>