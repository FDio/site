<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cloud NAT &mdash; The Vector Packet Processor v22.02-rc0-128-g4450b03ba
 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/rules.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Linux Control Plane Integration" href="lcp.html" />
    <link rel="prev" title="QUIC HostStack" href="quic.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> The Vector Packet Processor
            <img src="../../_static/fd-io_red_white.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                v22.02-rc0-128-g4450b03ba

              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">About VPP</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../aboutvpp/scalar-vs-vector-packet-processing.html">Scalar vs Vector packet processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../aboutvpp/extensible.html">The Packet Processing Graph</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../aboutvpp/networkstack.html">Network Stack Features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../aboutvpp/hoststack.html">Host Stack</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../aboutvpp/developer.html">Additional features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../aboutvpp/supported.html">Supported archs and OS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../aboutvpp/performance.html">Performance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../aboutvpp/releasenotes/index.html">Release notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../aboutvpp/featurelist.html">VPP Supported Features</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Use Cases</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../usecases/containers/index.html">VPP with Containers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usecases/simpleperf/index.html">VPP with Iperf3 and TRex</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usecases/vppcloud/index.html">VPP in the Cloud</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usecases/vhost/index.html">VPP with Virtual Machines</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usecases/vmxnet3.html">VPP with VMware/Vmxnet3</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usecases/home_gateway.html">VPP as a Home Gateway</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usecases/acls.html">Access Control Lists with VPP</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usecases/networksim.html">Generating traffic with VPP</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usecases/webapp.html">Web applications with VPP</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usecases/container_test.html">Simulating networks with VPP</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usecases/trafficgen.html">Stateless Traffic Gen with VPP</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usecases/ikev2/index.html">IKEv2 with VPP</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usecases/contiv/index.html">VPP in kubernetes (Contiv/Deprecated)</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Getting started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../gettingstarted/installing/index.html">Downloading and Installing VPP</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../gettingstarted/running/index.html">Running VPP</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../gettingstarted/progressivevpp/index.html">Progressive VPP Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../gettingstarted/troubleshooting/index.html">Troubleshooting</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developer Documentation</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../build-run-debug/index.html">Build, Run &amp; Debug</a></li>
<li class="toctree-l1"><a class="reference internal" href="../corearchitecture/index.html">Core Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../corefeatures/index.html">Core Features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../plugindoc/index.html">Adding a new plugin or feature</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Plugins</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="quic.html">QUIC HostStack</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Cloud NAT</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#overview">Overview</a></li>
<li class="toctree-l3"><a class="reference internal" href="#terminology-usage">Terminology &amp; Usage</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#translating-addresses">Translating Addresses</a></li>
<li class="toctree-l4"><a class="reference internal" href="#sourcenating-outgoing-traffic">SourceNATing outgoing traffic</a></li>
<li class="toctree-l4"><a class="reference internal" href="#other-parameters">Other parameters</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#extending-the-nat">Extending the NAT</a></li>
<li class="toctree-l3"><a class="reference internal" href="#known-limitations">Known limitations</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="lcp.html">Linux Control Plane Integration</a></li>
<li class="toctree-l2"><a class="reference internal" href="srv6/index.html">SRv6 Plugins</a></li>
<li class="toctree-l2"><a class="reference internal" href="marvell.html">Marvell device plugin</a></li>
<li class="toctree-l2"><a class="reference internal" href="lldp.html">LLDP Protocol</a></li>
<li class="toctree-l2"><a class="reference internal" href="nat64.html">Stateful NAT64</a></li>
<li class="toctree-l2"><a class="reference internal" href="nat44_ei_ha.html">Active-Passive NAT HA</a></li>
<li class="toctree-l2"><a class="reference internal" href="pnat.html">PNAT 1:1 match &amp; rewrite NAT</a></li>
<li class="toctree-l2"><a class="reference internal" href="lb.html">Load Balancer plugin</a></li>
<li class="toctree-l2"><a class="reference internal" href="lacp.html">LACP Protocol</a></li>
<li class="toctree-l2"><a class="reference internal" href="flowprobe.html">IPFIX flow record plugin</a></li>
<li class="toctree-l2"><a class="reference internal" href="map_lw4o6.html">MAP and Lw4o6</a></li>
<li class="toctree-l2"><a class="reference internal" href="mdata.html">Buffer metadata change tracker</a></li>
<li class="toctree-l2"><a class="reference internal" href="dhcp6_pd.html">DHCPv6 prefix delegation</a></li>
<li class="toctree-l2"><a class="reference internal" href="ioam.html">Inband OAM (iOAM)</a></li>
<li class="toctree-l2"><a class="reference internal" href="wireguard.html">Wireguard vpp-plugin</a></li>
<li class="toctree-l2"><a class="reference internal" href="srtp.html">SRTP Protocol</a></li>
<li class="toctree-l2"><a class="reference internal" href="acl_multicore.html">Multicore support for ACL plugin</a></li>
<li class="toctree-l2"><a class="reference internal" href="acl_hash_lookup.html">ACL plugin constant-time lookup</a></li>
<li class="toctree-l2"><a class="reference internal" href="acl_lookup_context.html">ACL Lookup contexts</a></li>
<li class="toctree-l2"><a class="reference internal" href="bufmon_doc.html">Buffers monitoring plugin</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../devicedrivers/index.html">Device drivers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tests/overview.html">VPP Test Framework</a></li>
<li class="toctree-l1"><a class="reference internal" href="../extras/index.html">VPP extra tools</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Interfacing with VPP</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../interfacing/binapi/index.html">The binary API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../interfacing/c/index.html">C api client</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../interfacing/cpp/index.html">C++ api client</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../interfacing/go/index.html">Go api (govpp)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../interfacing/rust/index.html">Rust api client</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../interfacing/libmemif/index.html">Memif library (libmemif)</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Contributing</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../contributing/gitreview.html">Getting a Patch Reviewed</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contributing/writingdocs.html">Writing VPP Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contributing/reportingissues/index.html">Reporting Bugs</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Debug CLI</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../cli-reference/gettingstarted/index.html">Getting Started with the debug CLI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cli-reference/interface/index.html">Interface Commands</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cli-reference/index.html">Reference</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Configuration file</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../configuration/config_getting_started.html">Getting started with the configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../configuration/reference.html">Configuration Reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">The Vector Packet Processor</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="index.html">Plugins</a> &raquo;</li>
      <li>Cloud NAT</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/developer/plugins/cnat.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="toctree-wrapper compound" id="dev-cnat">
</div>
<section id="cloud-nat">
<h1>Cloud NAT<a class="headerlink" href="#cloud-nat" title="Permalink to this headline"></a></h1>
<section id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline"></a></h2>
<p>This plugin covers specific NAT use-cases that come mostly
from the container networking world. On the contrary of the
NAT concepts used for e.g. a home gateway, there is no notion
of ‘outside’ and ‘inside’. We handle Virtual (or Real) IPs and
translations of the packets destined to them</p>
</section>
<section id="terminology-usage">
<h2>Terminology &amp; Usage<a class="headerlink" href="#terminology-usage" title="Permalink to this headline"></a></h2>
<p>Setting up the NAT will consist in the creation of a <code class="docutils literal notranslate"><span class="pre">translation</span></code>
that has several backends. A <code class="docutils literal notranslate"><span class="pre">translation</span></code> is 3-tuple containing :
a fully qualified IP address a port and a protocol. All packets
destined to it (ip, port) will then choose one of the backends,
and follow its rewrite rules.</p>
<p>A <code class="docutils literal notranslate"><span class="pre">backend</span></code> consists of four rewrites components (source &amp; destination
address, source &amp; destination port) that shall be applied to packets
on the way in, and reverted on the way back.</p>
<p>Backends are equally load-balanced with a flow hash. The choice
of a <code class="docutils literal notranslate"><span class="pre">backend</span></code> for a flow will trigger the creation of a NAT <code class="docutils literal notranslate"><span class="pre">session</span></code>,
that will store the packet rewrite to do and the one to undo
until the flow is reset or a timeout is reached</p>
<p>A <code class="docutils literal notranslate"><span class="pre">session</span></code> is a fully resolved 9-tuple of <code class="docutils literal notranslate"><span class="pre">src_ip,</span> <span class="pre">src_port,</span> <span class="pre">dest_ip,</span> <span class="pre">dest_port,</span> <span class="pre">proto</span></code>
to match incoming packets, and their new attributes <code class="docutils literal notranslate"><span class="pre">new_src_ip,</span> <span class="pre">new_src_port,</span> <span class="pre">new_dest_ip,</span> <span class="pre">new_dest_port</span></code>. It allows for <code class="docutils literal notranslate"><span class="pre">backend</span></code> stickiness and a fast-path for established connections.</p>
<p>These <code class="docutils literal notranslate"><span class="pre">sessions</span></code> expire after 30s for regular <code class="docutils literal notranslate"><span class="pre">sessions</span></code> and 1h for established
TCP connections. These can be changed in vpp’s configuration file</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">cnat {</span>
<span class="go">    session-max-age 60</span>
<span class="go">    tcp-max-age 3600</span>
<span class="go">}</span>
</pre></div>
</div>
<p>Traffic is matched by inserting FIB entries, that are represented
by a <code class="docutils literal notranslate"><span class="pre">client</span></code>. These maintain a refcount of the number of <code class="docutils literal notranslate"><span class="pre">sessions</span></code>
and/or <code class="docutils literal notranslate"><span class="pre">translations</span></code> depending on them and be cleaned up when
all have gone.</p>
<section id="translating-addresses">
<h3>Translating Addresses<a class="headerlink" href="#translating-addresses" title="Permalink to this headline"></a></h3>
<p>In this example, all packets destined to <code class="docutils literal notranslate"><span class="pre">30.0.0.2:80</span></code> will be
rewritten so that their destination IP is <code class="docutils literal notranslate"><span class="pre">20.0.0.1</span></code> and destination
port <code class="docutils literal notranslate"><span class="pre">8080</span></code>. Here <code class="docutils literal notranslate"><span class="pre">30.0.0.2</span></code> has to be a virtual IP, it cannot be
assigned to an interface</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">cnat translation add proto TCP vip 30.0.0.2 80 to -&gt;20.0.0.1 8080</span>
</pre></div>
</div>
<p>If <code class="docutils literal notranslate"><span class="pre">30.0.0.2</span></code> is the address of an interface, we can use the following
to do the same translation, and additionally change the source.
address with <code class="docutils literal notranslate"><span class="pre">1.2.3.4</span></code></p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">cnat translation add proto TCP real 30.0.0.2 80 to 1.2.3.4-&gt;20.0.0.1 8080</span>
</pre></div>
</div>
<p>To show existing translations and sessions you can use</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">cnat show session verbose</span>
<span class="go">cant show translation</span>
</pre></div>
</div>
</section>
<section id="sourcenating-outgoing-traffic">
<h3>SourceNATing outgoing traffic<a class="headerlink" href="#sourcenating-outgoing-traffic" title="Permalink to this headline"></a></h3>
<p>A independent part of the plugin allows changing the source address
of outgoing traffic on a per-interface basis.</p>
<p>In the following example, all traffic coming from <code class="docutils literal notranslate"><span class="pre">tap0</span></code> and NOT
going to <code class="docutils literal notranslate"><span class="pre">20.0.0.0/24</span></code> will be source NAT-ed with <code class="docutils literal notranslate"><span class="pre">30.0.0.1</span></code>.
On the way back the translation will be undone.</p>
<p>NB: <code class="docutils literal notranslate"><span class="pre">30.0.0.1</span></code> should be and address known to the FIB (e.g. the
address assigned to an interface)</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">cnat snat with 30.0.0.1</span>
<span class="go">cnat snat exclude 20.0.0.0/24</span>
<span class="go">set interface feature tap0 cnat-snat-ip4 arc ip4-unicast</span>
</pre></div>
</div>
</section>
<section id="other-parameters">
<h3>Other parameters<a class="headerlink" href="#other-parameters" title="Permalink to this headline"></a></h3>
<p>In vpp’s startup file, you can also configure the bihash sizes for</p>
<ul class="simple">
<li><p>the translation bihash <code class="docutils literal notranslate"><span class="pre">(proto,</span> <span class="pre">port)</span> <span class="pre">-&gt;</span> <span class="pre">translation</span></code></p></li>
<li><p>the session bihash <code class="docutils literal notranslate"><span class="pre">src_ip,</span> <span class="pre">src_port,</span> <span class="pre">dest_ip,</span> <span class="pre">dest_port,</span> <span class="pre">proto</span> <span class="pre">-&gt;</span> <span class="pre">new_src_ip,</span> <span class="pre">new_src_port,</span> <span class="pre">new_dest_ip,</span> <span class="pre">new_dest_port</span></code></p></li>
<li><p>the snat bihash for searching <code class="docutils literal notranslate"><span class="pre">snat</span> <span class="pre">exclude</span></code> prefixes</p></li>
</ul>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">cnat {</span>
<span class="go">    translation-db-memory 64K</span>
<span class="go">    translation-db-buckets 1024</span>
<span class="go">    session-db-memory 1M</span>
<span class="go">    session-db-buckets 1024</span>
<span class="go">    snat-db-memory 64M</span>
<span class="go">    snat-db-buckets 1024</span>
<span class="go">}</span>
</pre></div>
</div>
</section>
</section>
<section id="extending-the-nat">
<h2>Extending the NAT<a class="headerlink" href="#extending-the-nat" title="Permalink to this headline"></a></h2>
<p>This plugin is built to be extensible. For now two NAT types are defined, <code class="docutils literal notranslate"><span class="pre">cnat_node_vip.c</span></code> and <code class="docutils literal notranslate"><span class="pre">cnat_node_snat.c</span></code>. They both inherit from <code class="docutils literal notranslate"><span class="pre">cnat_node.h</span></code> which provides :</p>
<ul class="simple">
<li><p>Session lookup : <code class="docutils literal notranslate"><span class="pre">rv</span></code> will be set to <code class="docutils literal notranslate"><span class="pre">0</span></code> if a session was found</p></li>
<li><p>Translation primitives <code class="docutils literal notranslate"><span class="pre">cnat_translation_ip4</span></code> based on sessions</p></li>
<li><p>A session creation primitive <code class="docutils literal notranslate"><span class="pre">cnat_session_create</span></code></p></li>
</ul>
<p>Creating a session will also create a reverse session (for matching return traffic),
and call a NAT node back that will perform the translation.</p>
</section>
<section id="known-limitations">
<h2>Known limitations<a class="headerlink" href="#known-limitations" title="Permalink to this headline"></a></h2>
<p>This plugin is still under development, it lacks the following features :
* Load balancing doesn’t support parametric probabilities
* VRFs aren’t supported. All rules apply to fib table 0 only
* Programmatic session handling (deletion, lifetime updates) aren’t supported
* ICMP is not yet supported
* Traffic matching is only done based on <code class="docutils literal notranslate"><span class="pre">(proto,</span> <span class="pre">dst_addr,</span> <span class="pre">dst_port)</span></code> source matching isn’t supported
* Statistics &amp; session tracking are still rudimentary.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="quic.html" class="btn btn-neutral float-left" title="QUIC HostStack" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="lcp.html" class="btn btn-neutral float-right" title="Linux Control Plane Integration" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2018-2021, Linux Foundation.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>