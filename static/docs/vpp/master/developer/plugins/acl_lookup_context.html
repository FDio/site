<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ACL Lookup contexts &mdash; The Vector Packet Processor v22.02-rc0-128-g4450b03ba
 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/rules.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Buffers monitoring plugin" href="bufmon_doc.html" />
    <link rel="prev" title="ACL plugin constant-time lookup" href="acl_hash_lookup.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> The Vector Packet Processor
            <img src="../../_static/fd-io_red_white.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                v22.02-rc0-128-g4450b03ba

              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">About VPP</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../aboutvpp/scalar-vs-vector-packet-processing.html">Scalar vs Vector packet processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../aboutvpp/extensible.html">The Packet Processing Graph</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../aboutvpp/networkstack.html">Network Stack Features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../aboutvpp/hoststack.html">Host Stack</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../aboutvpp/developer.html">Additional features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../aboutvpp/supported.html">Supported archs and OS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../aboutvpp/performance.html">Performance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../aboutvpp/releasenotes/index.html">Release notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../aboutvpp/featurelist.html">VPP Supported Features</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Use Cases</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../usecases/containers/index.html">VPP with Containers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usecases/simpleperf/index.html">VPP with Iperf3 and TRex</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usecases/vppcloud/index.html">VPP in the Cloud</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usecases/vhost/index.html">VPP with Virtual Machines</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usecases/vmxnet3.html">VPP with VMware/Vmxnet3</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usecases/home_gateway.html">VPP as a Home Gateway</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usecases/acls.html">Access Control Lists with VPP</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usecases/networksim.html">Generating traffic with VPP</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usecases/webapp.html">Web applications with VPP</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usecases/container_test.html">Simulating networks with VPP</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usecases/trafficgen.html">Stateless Traffic Gen with VPP</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usecases/ikev2/index.html">IKEv2 with VPP</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usecases/contiv/index.html">VPP in kubernetes (Contiv/Deprecated)</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Getting started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../gettingstarted/installing/index.html">Downloading and Installing VPP</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../gettingstarted/running/index.html">Running VPP</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../gettingstarted/progressivevpp/index.html">Progressive VPP Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../gettingstarted/troubleshooting/index.html">Troubleshooting</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developer Documentation</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../build-run-debug/index.html">Build, Run &amp; Debug</a></li>
<li class="toctree-l1"><a class="reference internal" href="../corearchitecture/index.html">Core Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../corefeatures/index.html">Core Features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../plugindoc/index.html">Adding a new plugin or feature</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Plugins</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="quic.html">QUIC HostStack</a></li>
<li class="toctree-l2"><a class="reference internal" href="cnat.html">Cloud NAT</a></li>
<li class="toctree-l2"><a class="reference internal" href="lcp.html">Linux Control Plane Integration</a></li>
<li class="toctree-l2"><a class="reference internal" href="srv6/index.html">SRv6 Plugins</a></li>
<li class="toctree-l2"><a class="reference internal" href="marvell.html">Marvell device plugin</a></li>
<li class="toctree-l2"><a class="reference internal" href="lldp.html">LLDP Protocol</a></li>
<li class="toctree-l2"><a class="reference internal" href="nat64.html">Stateful NAT64</a></li>
<li class="toctree-l2"><a class="reference internal" href="nat44_ei_ha.html">Active-Passive NAT HA</a></li>
<li class="toctree-l2"><a class="reference internal" href="pnat.html">PNAT 1:1 match &amp; rewrite NAT</a></li>
<li class="toctree-l2"><a class="reference internal" href="lb.html">Load Balancer plugin</a></li>
<li class="toctree-l2"><a class="reference internal" href="lacp.html">LACP Protocol</a></li>
<li class="toctree-l2"><a class="reference internal" href="flowprobe.html">IPFIX flow record plugin</a></li>
<li class="toctree-l2"><a class="reference internal" href="map_lw4o6.html">MAP and Lw4o6</a></li>
<li class="toctree-l2"><a class="reference internal" href="mdata.html">Buffer metadata change tracker</a></li>
<li class="toctree-l2"><a class="reference internal" href="dhcp6_pd.html">DHCPv6 prefix delegation</a></li>
<li class="toctree-l2"><a class="reference internal" href="ioam.html">Inband OAM (iOAM)</a></li>
<li class="toctree-l2"><a class="reference internal" href="wireguard.html">Wireguard vpp-plugin</a></li>
<li class="toctree-l2"><a class="reference internal" href="srtp.html">SRTP Protocol</a></li>
<li class="toctree-l2"><a class="reference internal" href="acl_multicore.html">Multicore support for ACL plugin</a></li>
<li class="toctree-l2"><a class="reference internal" href="acl_hash_lookup.html">ACL plugin constant-time lookup</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">ACL Lookup contexts</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#why-lookup-contexts-and-not-match-me-an-acl">Why “lookup contexts” and not “match me an ACL” ?</a></li>
<li class="toctree-l3"><a class="reference internal" href="#what-is-a-lookup-context">What is a “lookup context” ?</a></li>
<li class="toctree-l3"><a class="reference internal" href="#using-acl-contexts-in-your-code">Using ACL contexts in your code</a></li>
<li class="toctree-l3"><a class="reference internal" href="#debug-clis">Debug CLIs</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="bufmon_doc.html">Buffers monitoring plugin</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../devicedrivers/index.html">Device drivers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tests/overview.html">VPP Test Framework</a></li>
<li class="toctree-l1"><a class="reference internal" href="../extras/index.html">VPP extra tools</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Interfacing with VPP</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../interfacing/binapi/index.html">The binary API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../interfacing/c/index.html">C api client</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../interfacing/cpp/index.html">C++ api client</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../interfacing/go/index.html">Go api (govpp)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../interfacing/rust/index.html">Rust api client</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../interfacing/libmemif/index.html">Memif library (libmemif)</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Contributing</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../contributing/gitreview.html">Getting a Patch Reviewed</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contributing/writingdocs.html">Writing VPP Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contributing/reportingissues/index.html">Reporting Bugs</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Debug CLI</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../cli-reference/gettingstarted/index.html">Getting Started with the debug CLI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cli-reference/interface/index.html">Interface Commands</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cli-reference/index.html">Reference</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Configuration file</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../configuration/config_getting_started.html">Getting started with the configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../configuration/reference.html">Configuration Reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">The Vector Packet Processor</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="index.html">Plugins</a> &raquo;</li>
      <li>ACL Lookup contexts</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/developer/plugins/acl_lookup_context.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="acl-lookup-contexts">
<h1>ACL Lookup contexts<a class="headerlink" href="#acl-lookup-contexts" title="Permalink to this headline"></a></h1>
<p>The initial implementation of the ACL plugin had tightly tied the policy
(L3-L4) ACLs to ingress/egress processing on an interface.</p>
<p>However, some uses outside of pure traffic control have appeared, for
example, ACL-based forwarding, etc. Also, improved algorithms of the ACL
lookup could benefit of the more abstract representation, not coupled to
the interfaces.</p>
<p>This describes a way to accommodate these use cases by generalizing the
ACL lookups into “ACL lookup contexts”, not tied to specific interfaces,
usable by other portions of the code by utilizing the exports.h header
file, which provides the necessary interface.</p>
<section id="why-lookup-contexts-and-not-match-me-an-acl">
<h2>Why “lookup contexts” and not “match me an ACL” ?<a class="headerlink" href="#why-lookup-contexts-and-not-match-me-an-acl" title="Permalink to this headline"></a></h2>
<p>The first reason is the logical grouping of multiple ACLs.</p>
<p>The interface matching code currently allows for matching multiple ACLs
in a ‘first-match’ fashion. Some other use cases also fall into a
similar pattern: they attempt to match a sequence of ACLs, and the first
matched ACL determines what the outcome is, e.g. where to forward
traffic. Thus, a match never happens on an ACL in isolation, but always
on a group of ACLs.</p>
<p>The second reason is potential optimizations in matching.</p>
<p>A naive match on series of ACLs each represented as a vector of ACEs
does not care about the API level - it could be “match one ACL”, or
“match the set of ACLs” - there will be just a simple loop iterating
over the ACLs to match, returning the first match. Be it in the ACL code
or in the user code.</p>
<p>However, for more involved lookup methods, providing a more high-level
interface of matching over the entire group of ACLs allows for future
improvements in the algorithms, delivered at once to all the users of
the API.</p>
</section>
<section id="what-is-a-lookup-context">
<h2>What is a “lookup context” ?<a class="headerlink" href="#what-is-a-lookup-context" title="Permalink to this headline"></a></h2>
<p>An ACL lookup context is an entity that groups the set of ACL#s together
for the purposes of a first-match lookup, and may store additional
internal information needed to optimize the lookups for that particular
vector of ACLs.</p>
</section>
<section id="using-acl-contexts-in-your-code">
<h2>Using ACL contexts in your code<a class="headerlink" href="#using-acl-contexts-in-your-code" title="Permalink to this headline"></a></h2>
<p>In order to use the ACL lookup contexts, you need to include
plugins/acl/exports.h into your code. This header includes all the
necessary dependencies required.</p>
<p>As you probably will invoke this code from another plugin, the
non-inline function calls are implemented via function pointers, which
you need to initialize by calling acl_plugin_exports_init(&amp;acl_plugin),
which, if everything succeeds, returns 0 and fills in the acl_plugin
structure with pointers to the exported methods - else it will return
clib_error_t with more information about what went wrong.</p>
<p>When you have initialized the symbols, you also need to register
yourself as a user of the ACL lookups - this allows to track the ACL
lookup context ownership, as well as make the debug show outputs more
user friendly.</p>
<p>To do that, call acl_plugin.register_user_module(caller_module_string,
val1_label, val2_label) - and record the returned value. This will be the
first parameter that you pass to create a new lookup context. The passed
strings must be static, and are used as descriptions for the ACL
contexts themselves, as well as labels for up to two user-supplied u32
labels, used to differentiate the lookup contexts for the debugging
purposes.</p>
<p>Creating a new context is done by calling
acl_plugin.get_lookup_context_index(user_id, val1, val2). The first
argument is your “user” ID obtained in a registration call earlier, the
other two arguments are u32s with semantics that you designate. They are
used purely for debugging purposes in the “show acl lookup context”
command.</p>
<p>To set the vector of ACL numbers to be looked up within the context, use
the function acl_plugin.set_acl_vec_for_context(lc_index, acl_list). The
first parameter specifies the context that you have created, the second
parameter is a vector of u32s, each u32 being the index of the ACL which
we should be looking up within this context. The command is idempotent,
i.e. it unapplies the previously applied list of ACLs, and then sets the
new list of ACLs.</p>
<p>Subsequent ACL updates for the already applied ACLs will cause the
re-application on an as-needed basis. Note, that the ACL application is
potentially a relatively costly operation, so it is only expected that
these changes will be done in the control plane, NOT in the datapath.</p>
<p>The matching within the context is done using two functions -
acl_plugin.fill_5tuple() and acl_plugin.match_5tuple() and their
corresponding inline versions, named acl_plugin_fill_5tuple_inline() and
acl_plugin_match_5tuple_inline(). The inline and non-inline versions
have the equivalent functionality, in that the non-inline version calls
the inline version. These two variants are provided for
debugging/maintenance reasons.</p>
<p>When you no longer need a particular context, you can return the
allocated resources by calling acl_plugin.put_lookup_context_index() to
mark it as free. The lookup structured associated with the vector of
ACLs set for the lookup are cleaned up automatically. However, the ACLs
themselves are not deleted and are available for subsequent reuse by
other lookup contexts if needed.</p>
<p>There is one delicate detail that you might want to be aware of. When
the non-inline functions reference the inline functions, they are
compiled as part of ACL plugin; whereas when you refer to the inline
functions from your code, they are compiled as part of your code. This
makes referring to a single acl_main structure a little trickier.</p>
<p>It is done by having a static p_acl_main within the .h file, which
points to acl_main of the ACL plugin, and is initialized by a static
constructor function.</p>
<p>This way the multiple includes and inlines will “just work” as one would
expect.</p>
</section>
<section id="debug-clis">
<h2>Debug CLIs<a class="headerlink" href="#debug-clis" title="Permalink to this headline"></a></h2>
<p>To see the state of the ACL lookup contexts, you can issue “show
acl-plugin lookup user” to see all of the users which registered for the
usage of the ACL plugin lookup contexts, and “show acl-plugin lookup
context” to show the actual contexts created. You will notice that the
latter command uses the values supplied during the module registration
in order to make the output more friendly.</p>
<p>The “show acl-plugin acl” and “show acl-plugin interface” commands have
also acquired the notion of lookup context, but there it is used from
the client perspective, since with this change the interface ACL lookup
itself is a user of ACL lookup contexts.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="acl_hash_lookup.html" class="btn btn-neutral float-left" title="ACL plugin constant-time lookup" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="bufmon_doc.html" class="btn btn-neutral float-right" title="Buffers monitoring plugin" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2018-2021, Linux Foundation.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>