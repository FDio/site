

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Using VPP as a Home Gateway &mdash; The Vector Packet Processor master documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/rules.css" type="text/css" />
    <link rel="author" title="About these documents" href="../about.html" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Contiv/VPP" href="contiv/index.html" />
    <link rel="prev" title="Automating VPP deployment" href="automatingthedeployment.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> The Vector Packet Processor
          

          
            
            <img src="../_static/fd-io_red_white.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                master
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../whatisvpp/index.html">The Vector Packet Processor (VPP)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../gettingstarted/index.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../links/index.html">VPP Wiki, Doxygen and Other Links</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Use Cases</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="containers.html">VPP with Containers</a></li>
<li class="toctree-l2"><a class="reference internal" href="simpleperf/index.html">VPP with Iperf3 and TRex</a></li>
<li class="toctree-l2"><a class="reference internal" href="vhost/index.html">FD.io VPP with Virtual Machines</a></li>
<li class="toctree-l2"><a class="reference internal" href="vmxnet3.html">VPP with VMware/Vmxnet3</a></li>
<li class="toctree-l2"><a class="reference internal" href="acls.html">Access Control Lists (ACLs) with FD.io VPP</a></li>
<li class="toctree-l2"><a class="reference internal" href="vppcloud.html">VPP inside the Cloud</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Using VPP as a Home Gateway</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#system-configuration-files">System configuration files</a></li>
<li class="toctree-l3"><a class="reference internal" href="#systemd-configuration">Systemd configuration</a></li>
<li class="toctree-l3"><a class="reference internal" href="#netplan-configuration">Netplan configuration</a></li>
<li class="toctree-l3"><a class="reference internal" href="#vpp-configuration-files">VPP Configuration Files</a></li>
<li class="toctree-l3"><a class="reference internal" href="#installing-new-vpp-software">Installing new vpp software</a></li>
<li class="toctree-l3"><a class="reference internal" href="#reasonably-robust-remote-software-installation">Reasonably Robust Remote Software Installation</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#build-host-script">Build-host script</a></li>
<li class="toctree-l4"><a class="reference internal" href="#target-script">Target script</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#testing-new-software">Testing new software</a></li>
<li class="toctree-l3"><a class="reference internal" href="#patches">Patches</a></li>
<li class="toctree-l3"><a class="reference internal" href="#using-the-time-based-mac-filter-plugin">Using the time-based mac filter plugin</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="contiv/index.html">Contiv/VPP</a></li>
<li class="toctree-l2"><a class="reference internal" href="networksim.html">Network Simulator Plugin</a></li>
<li class="toctree-l2"><a class="reference internal" href="webapp.html">Building VPP web applications</a></li>
<li class="toctree-l2"><a class="reference internal" href="container_test.html">Container-based network simulation</a></li>
<li class="toctree-l2"><a class="reference internal" href="trafficgen.html">Vpp Stateless Traffic Generation</a></li>
<li class="toctree-l2"><a class="reference internal" href="ikev2.html">IKEv2 in VPP</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../troubleshooting/index.html">Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/index.html">Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../relatedprojects/index.html">Related FD.IO Projects</a></li>
<li class="toctree-l1"><a class="reference internal" href="../about.html">About</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">The Vector Packet Processor</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">Use Cases</a> &raquo;</li>
        
      <li>Using VPP as a Home Gateway</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/usecases/hgw.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="using-vpp-as-a-home-gateway">
<h1>Using VPP as a Home Gateway<a class="headerlink" href="#using-vpp-as-a-home-gateway" title="Permalink to this headline">¶</a></h1>
<p>Vpp running on a small system (with appropriate NICs) makes a fine
home gateway. The resulting system performs far in excess of
requirements: a debug image runs at a vector size of ~1.2 terminating
a 150-mbit down / 10-mbit up cable modem connection.</p>
<p>At a minimum, install sshd and the isc-dhcp-server. If you prefer, you
can use dnsmasq.</p>
<div class="section" id="system-configuration-files">
<h2>System configuration files<a class="headerlink" href="#system-configuration-files" title="Permalink to this headline">¶</a></h2>
<p>/etc/vpp/startup.conf:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">unix</span> <span class="p">{</span>
  <span class="n">nodaemon</span>
  <span class="n">log</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="n">vpp</span><span class="o">/</span><span class="n">vpp</span><span class="o">.</span><span class="n">log</span>
  <span class="n">full</span><span class="o">-</span><span class="n">coredump</span>
  <span class="n">cli</span><span class="o">-</span><span class="n">listen</span> <span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">vpp</span><span class="o">/</span><span class="n">cli</span><span class="o">.</span><span class="n">sock</span>
  <span class="n">startup</span><span class="o">-</span><span class="n">config</span> <span class="o">/</span><span class="n">setup</span><span class="o">.</span><span class="n">gate</span>
  <span class="n">poll</span><span class="o">-</span><span class="n">sleep</span><span class="o">-</span><span class="n">usec</span> <span class="mi">100</span>
  <span class="n">gid</span> <span class="n">vpp</span>
<span class="p">}</span>
<span class="n">api</span><span class="o">-</span><span class="n">segment</span> <span class="p">{</span>
  <span class="n">gid</span> <span class="n">vpp</span>
<span class="p">}</span>
<span class="n">dpdk</span> <span class="p">{</span>
     <span class="n">dev</span> <span class="mi">0000</span><span class="p">:</span><span class="mi">03</span><span class="p">:</span><span class="mf">00.0</span>
     <span class="n">dev</span> <span class="mi">0000</span><span class="p">:</span><span class="mi">14</span><span class="p">:</span><span class="mf">00.0</span>
     <span class="n">etc</span><span class="o">.</span>
 <span class="p">}</span>

 <span class="n">plugins</span> <span class="p">{</span>
   <span class="c1">## Disable all plugins, selectively enable specific plugins</span>
       <span class="c1">## YMMV, you may wish to enable other plugins (acl, etc.)</span>
   <span class="n">plugin</span> <span class="n">default</span> <span class="p">{</span> <span class="n">disable</span> <span class="p">}</span>
   <span class="n">plugin</span> <span class="n">dpdk_plugin</span><span class="o">.</span><span class="n">so</span> <span class="p">{</span> <span class="n">enable</span> <span class="p">}</span>
   <span class="n">plugin</span> <span class="n">nat_plugin</span><span class="o">.</span><span class="n">so</span> <span class="p">{</span> <span class="n">enable</span> <span class="p">}</span>
       <span class="c1">## if you plan to use the time-based MAC filter</span>
   <span class="n">plugin</span> <span class="n">mactime_plugin</span><span class="o">.</span><span class="n">so</span> <span class="p">{</span> <span class="n">enable</span> <span class="p">}</span>
 <span class="p">}</span>
</pre></div>
</div>
<p>/etc/dhcp/dhcpd.conf:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">subnet</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">1.0</span> <span class="n">netmask</span> <span class="mf">255.255</span><span class="o">.</span><span class="mf">255.0</span> <span class="p">{</span>
  <span class="nb">range</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">1.10</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">1.99</span><span class="p">;</span>
  <span class="n">option</span> <span class="n">routers</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">1.1</span><span class="p">;</span>
  <span class="n">option</span> <span class="n">domain</span><span class="o">-</span><span class="n">name</span><span class="o">-</span><span class="n">servers</span> <span class="mf">8.8</span><span class="o">.</span><span class="mf">8.8</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>If you decide to enable the vpp dns name resolver, substitute
192.168.1.2 for 8.8.8.8 in the dhcp server configuration.</p>
<p>/etc/default/isc-dhcp-server:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># On which interfaces should the DHCP server (dhcpd) serve DHCP requests?</span>
<span class="c1"># Separate multiple interfaces with spaces, e.g. &quot;eth0 eth1&quot;.</span>
<span class="n">INTERFACESv4</span><span class="o">=</span><span class="s2">&quot;lstack&quot;</span>
<span class="n">INTERFACESv6</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
</pre></div>
</div>
<p>/etc/ssh/sshd_config:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># What ports, IPs and protocols we listen for</span>
<span class="n">Port</span> <span class="o">&lt;</span><span class="n">REDACTED</span><span class="o">-</span><span class="n">high</span><span class="o">-</span><span class="n">number</span><span class="o">-</span><span class="n">port</span><span class="o">&gt;</span>
<span class="c1"># Change to no to disable tunnelled clear text passwords</span>
<span class="n">PasswordAuthentication</span> <span class="n">no</span>
</pre></div>
</div>
<p>For your own comfort and safety, do NOT allow password authentication
and do not answer ssh requests on port 22. Experience shows several hack
attempts per hour on port 22, but none (ever) on random high-number
ports.</p>
</div>
<div class="section" id="systemd-configuration">
<h2>Systemd configuration<a class="headerlink" href="#systemd-configuration" title="Permalink to this headline">¶</a></h2>
<p>In a typical home-gateway use-case, vpp owns the one-and-only WAN link
with a prayer of reaching the public internet. Simple things like
updating distro software requires use of the “lstack” interface
created above, and configuring a plausible upstream DNS name resolver.</p>
<p>Configure /etc/systemd/resolved.conf as follows.</p>
<p>/etc/systemd/resolved.conf:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">Resolve</span><span class="p">]</span>
<span class="n">DNS</span><span class="o">=</span><span class="mf">8.8</span><span class="o">.</span><span class="mf">8.8</span>
<span class="c1">#FallbackDNS=</span>
<span class="c1">#Domains=</span>
<span class="c1">#LLMNR=no</span>
<span class="c1">#MulticastDNS=no</span>
<span class="c1">#DNSSEC=no</span>
<span class="c1">#Cache=yes</span>
<span class="c1">#DNSStubListener=yes</span>
</pre></div>
</div>
</div>
<div class="section" id="netplan-configuration">
<h2>Netplan configuration<a class="headerlink" href="#netplan-configuration" title="Permalink to this headline">¶</a></h2>
<p>If you want to configure a static IP address on one of your home-gateway
Ethernet ports on Ubuntu 18.04, you’ll need to configure netplan.
Netplan is relatively new. It and the network manager GUI and can be
cranky. In the configuration shown below,
s/enp4s0/&lt;your-interface&gt;/...</p>
<p>/etc/netplan-01-netcfg.yaml:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># This file describes the network interfaces available on your system</span>
<span class="c1"># For more information, see netplan(5).</span>
<span class="n">network</span><span class="p">:</span>
  <span class="n">version</span><span class="p">:</span> <span class="mi">2</span>
  <span class="n">renderer</span><span class="p">:</span> <span class="n">networkd</span>
  <span class="n">ethernets</span><span class="p">:</span>
    <span class="n">enp4s0</span><span class="p">:</span>
      <span class="n">dhcp4</span><span class="p">:</span> <span class="n">no</span>
      <span class="n">addresses</span><span class="p">:</span> <span class="p">[</span><span class="mf">192.168</span><span class="o">.</span><span class="mf">2.254</span><span class="o">/</span><span class="mi">24</span><span class="p">]</span>
      <span class="n">gateway4</span><span class="p">:</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">2.100</span>
      <span class="n">nameservers</span><span class="p">:</span>
        <span class="n">search</span><span class="p">:</span> <span class="p">[</span><span class="n">my</span><span class="o">.</span><span class="n">local</span><span class="p">]</span>
        <span class="n">addresses</span><span class="p">:</span> <span class="p">[</span><span class="mf">8.8</span><span class="o">.</span><span class="mf">8.8</span><span class="p">]</span>
</pre></div>
</div>
<p>/etc/systemd/network-10.enp4s0.network:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">Match</span><span class="p">]</span>
<span class="n">Name</span><span class="o">=</span><span class="n">enp4s0</span>

<span class="p">[</span><span class="n">Link</span><span class="p">]</span>
<span class="n">RequiredForOnline</span><span class="o">=</span><span class="n">no</span>

<span class="p">[</span><span class="n">Network</span><span class="p">]</span>
<span class="n">ConfigureWithoutCarrier</span><span class="o">=</span><span class="n">true</span>
<span class="n">Address</span><span class="o">=</span><span class="mf">192.168</span><span class="o">.</span><span class="mf">2.254</span><span class="o">/</span><span class="mi">24</span>
</pre></div>
</div>
<p>Note that we’ve picked an IP address for the home gateway which is on
an independent unrouteable subnet. This is handy for installing (and
possibly reverting) new vpp software.</p>
</div>
<div class="section" id="vpp-configuration-files">
<h2>VPP Configuration Files<a class="headerlink" href="#vpp-configuration-files" title="Permalink to this headline">¶</a></h2>
<p>Here we see a nice use-case for the vpp debug CLI macro expander:</p>
<p>/setup.gate:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">define</span> <span class="n">HOSTNAME</span> <span class="n">vpp1</span>
<span class="n">define</span> <span class="n">TRUNK</span> <span class="n">GigabitEthernet3</span><span class="o">/</span><span class="mi">0</span><span class="o">/</span><span class="mi">0</span>

<span class="n">comment</span> <span class="p">{</span> <span class="n">Specific</span> <span class="n">MAC</span> <span class="n">address</span> <span class="n">yields</span> <span class="n">a</span> <span class="n">constant</span> <span class="n">IP</span> <span class="n">address</span> <span class="p">}</span>
<span class="n">define</span> <span class="n">TRUNK_MACADDR</span> <span class="mi">48</span><span class="p">:</span><span class="n">f8</span><span class="p">:</span><span class="n">b3</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">01</span><span class="p">:</span><span class="mi">01</span>
<span class="n">define</span> <span class="n">BVI_MACADDR</span> <span class="mi">48</span><span class="p">:</span><span class="n">f8</span><span class="p">:</span><span class="n">b3</span><span class="p">:</span><span class="mi">01</span><span class="p">:</span><span class="mi">01</span><span class="p">:</span><span class="mi">02</span>

<span class="n">comment</span> <span class="p">{</span> <span class="n">inside</span> <span class="n">subnet</span> <span class="mf">192.168</span><span class="o">.&lt;</span><span class="n">inside_subnet</span><span class="o">&gt;.</span><span class="mi">0</span><span class="o">/</span><span class="mi">24</span> <span class="p">}</span>
<span class="n">define</span> <span class="n">INSIDE_SUBNET</span> <span class="mi">1</span>

<span class="n">define</span> <span class="n">INSIDE_PORT1</span> <span class="n">GigabitEthernet6</span><span class="o">/</span><span class="mi">0</span><span class="o">/</span><span class="mi">0</span>
<span class="n">define</span> <span class="n">INSIDE_PORT2</span> <span class="n">GigabitEthernet6</span><span class="o">/</span><span class="mi">0</span><span class="o">/</span><span class="mi">1</span>
<span class="n">define</span> <span class="n">INSIDE_PORT3</span> <span class="n">GigabitEthernet8</span><span class="o">/</span><span class="mi">0</span><span class="o">/</span><span class="mi">0</span>
<span class="n">define</span> <span class="n">INSIDE_PORT4</span> <span class="n">GigabitEthernet8</span><span class="o">/</span><span class="mi">0</span><span class="o">/</span><span class="mi">1</span>

<span class="n">comment</span> <span class="p">{</span> <span class="n">feature</span> <span class="n">selections</span> <span class="p">}</span>
<span class="n">define</span> <span class="n">FEATURE_NAT44</span> <span class="n">comment</span>
<span class="n">define</span> <span class="n">FEATURE_CNAT</span> <span class="n">uncomment</span>
<span class="n">define</span> <span class="n">FEATURE_DNS</span> <span class="n">comment</span>
<span class="n">define</span> <span class="n">FEATURE_IP6</span> <span class="n">comment</span>
<span class="n">define</span> <span class="n">FEATURE_MACTIME</span> <span class="n">uncomment</span>

<span class="n">exec</span> <span class="o">/</span><span class="n">setup</span><span class="o">.</span><span class="n">tmpl</span>
</pre></div>
</div>
<p>/setup.tmpl:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>show macro

set int mac address $(TRUNK) $(TRUNK_MACADDR)
set dhcp client intfc $(TRUNK) hostname $(HOSTNAME)
set int state $(TRUNK) up

bvi create instance 0
set int mac address bvi0 $(BVI_MACADDR)
set int l2 bridge bvi0 1 bvi
set int ip address bvi0 192.168.$(INSIDE_SUBNET).1/24
set int state bvi0 up

set int l2 bridge $(INSIDE_PORT1) 1
set int state $(INSIDE_PORT1) up
set int l2 bridge $(INSIDE_PORT2) 1
set int state $(INSIDE_PORT2) up
set int l2 bridge $(INSIDE_PORT3) 1
set int state $(INSIDE_PORT3) up
set int l2 bridge $(INSIDE_PORT4) 1
set int state $(INSIDE_PORT4) up

comment { dhcp server and host-stack access }
create tap host-if-name lstack host-ip4-addr 192.168.$(INSIDE_SUBNET).2/24 host-ip4-gw 192.168.$(INSIDE_SUBNET).1
set int l2 bridge tap0 1
set int state tap0 up

service restart isc-dhcp-server

$(FEATURE_NAT44) { nat44 enable users 50 user-sessions 750 sessions 63000 }
$(FEATURE_NAT44) { nat44 add interface address $(TRUNK) }
$(FEATURE_NAT44) { set interface nat44 in bvi0 out $(TRUNK) }

$(FEATURE_NAT44) { nat44 add static mapping local 192.168.$(INSIDE_SUBNET).2 22432 external $(TRUNK) 22432 tcp }

$(FEATURE_CNAT) { cnat snat with $(TRUNK) }
$(FEATURE_CNAT) { set interface feature bvi0 ip4-cnat-snat arc ip4-unicast }
$(FEATURE_CNAT) { cnat translation add proto tcp real $(TRUNK) 22432 to -&gt; 192.168.$(INSIDE_SUBNET).2 22432 }
$(FEATURE_CNAT) { $(FEATURE_DNS) { cnat translation add proto udp real $(TRUNK) 53053 to -&gt; 192.168.$(INSIDE_SUBNET).1 53053 } }

$(FEATURE_DNS) { $(FEATURE_NAT44) { nat44 add identity mapping external $(TRUNK) udp 53053 } }
$(FEATURE_DNS) { bin dns_name_server_add_del 8.8.8.8 }
$(FEATURE_DNS) { bin dns_enable_disable }

comment { set ct6 inside $(TRUNK) }
comment { set ct6 outside $(TRUNK) }

$(FEATURE_IP6) { set int ip6 table $(TRUNK) 0 }
$(FEATURE_IP6) { ip6 nd address autoconfig $(TRUNK) default-route }
$(FEATURE_IP6) { dhcp6 client $(TRUNK) }
$(FEATURE_IP6) { dhcp6 pd client $(TRUNK) prefix group hgw }
$(FEATURE_IP6) { set ip6 address bvi0 prefix group hgw ::1/64 }
$(FEATURE_IP6) { ip6 nd address autoconfig bvi0 default-route }
comment { iPhones seem to need lots of RA messages... }
$(FEATURE_IP6) { ip6 nd bvi0 ra-managed-config-flag ra-other-config-flag ra-interval 5 3 ra-lifetime 180 }
comment { ip6 nd bvi0 prefix 0::0/0  ra-lifetime 100000 }


$(FEATURE_MACTIME) { bin mactime_add_del_range name cisco-vpn mac a8:b4:56:e1:b8:3e allow-static }
$(FEATURE_MACTIME) { bin mactime_add_del_range name old-mac mac &lt;redacted&gt; allow-static }
$(FEATURE_MACTIME) { bin mactime_add_del_range name roku mac &lt;redacted&gt; allow-static }
$(FEATURE_MACTIME) { bin mactime_enable_disable $(INSIDE_PORT1) }
$(FEATURE_MACTIME) { bin mactime_enable_disable $(INSIDE_PORT2) }
$(FEATURE_MACTIME) { bin mactime_enable_disable $(INSIDE_PORT3) }
$(FEATURE_MACTIME) { bin mactime_enable_disable $(INSIDE_PORT4) }
</pre></div>
</div>
</div>
<div class="section" id="installing-new-vpp-software">
<h2>Installing new vpp software<a class="headerlink" href="#installing-new-vpp-software" title="Permalink to this headline">¶</a></h2>
<p>If you’re <strong>sure</strong> that a given set of vpp Debian packages will install
and work properly, you can install them while logged into the gateway
via the lstack / nat path. This procedure is a bit like standing on a
rug and yanking it. If all goes well, a perfect back-flip occurs. If
not, you may wish that you’d configured a static IP address on a
reserved Ethernet interface as described above.</p>
<p>Installing a new vpp image via ssh to 192.168.1.2:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># nohup dpkg -i *.deb &gt;/dev/null 2&gt;&amp;1 &amp;</span>
</pre></div>
</div>
<p>Within a few seconds, the inbound ssh connection SHOULD begin to respond
again. If it does not, you’ll have to debug the issue(s).</p>
</div>
<div class="section" id="reasonably-robust-remote-software-installation">
<h2>Reasonably Robust Remote Software Installation<a class="headerlink" href="#reasonably-robust-remote-software-installation" title="Permalink to this headline">¶</a></h2>
<p>Here are a couple of scripts which yield a reasonably robust software
installation scheme.</p>
<div class="section" id="build-host-script">
<h3>Build-host script<a class="headerlink" href="#build-host-script" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>#!/bin/bash

buildroot=/scratch/vpp-workspace/build-root
if [ $1x = &quot;testx&quot; ] ; then
    subdir=&quot;test&quot;
    ipaddr=&quot;192.168.2.48&quot;
elif [ $1x = &quot;foox&quot; ] ; then
    subdir=&quot;foo&quot;
    ipaddr=&quot;foo.some.net&quot;
elif [ $1x = &quot;barx&quot; ] ; then
    subdir=&quot;bar&quot;
    ipaddr=&quot;bar.some.net&quot;
else
    subdir=&quot;test&quot;
    ipaddr=&quot;192.168.2.48&quot;
fi

echo Save current software...
ssh -p 22432 $ipaddr &quot;rm -rf /gate_debians.prev&quot;
ssh -p 22432 $ipaddr &quot;mv /gate_debians /gate_debians.prev&quot;
ssh -p 22432 $ipaddr &quot;mkdir /gate_debians&quot;
echo Copy new software to the gateway...
scp -P 22432 $buildroot/*.deb $ipaddr:/gate_debians
echo Install new software...
ssh -p 22432 $ipaddr &quot;nohup /usr/local/bin/vpp-swupdate &gt; /dev/null 2&gt;&amp;1 &amp;&quot;

for i in 25 24 23 22 21 20 19 18 17 16 15 14 13 12 11 10 9 8 7 6 5 4 3 2 1
do
    echo Wait for $i seconds...
    sleep 1
done

echo Try to access the device...

ssh -p 22432 -o ConnectTimeout=10 $ipaddr &quot;tail -20 /var/log/syslog | grep Ping&quot;
if [ $? == 0 ] ; then
    echo Access test OK...
else
    echo Access failed, wait for configuration restoration...
    for i in 25 24 23 22 21 20 19 18 17 16 15 14 13 12 11 10 9 8 7 6 5 4 3 2 1
    do
        echo Wait for $i seconds...
        sleep 1
    done
    echo Retry access test
    ssh -p 22432 -o ConnectTimeout=10 $ipaddr &quot;tail -20 /var/log/syslog | grep Ping&quot;
    if [ $? == 0 ] ; then
        echo Access test OK, check syslog on the device
        exit 1
    else
        echo Access test still fails, manual intervention required.
        exit 2
    fi
fi

exit 0
</pre></div>
</div>
</div>
<div class="section" id="target-script">
<h3>Target script<a class="headerlink" href="#target-script" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>#!/bin/bash

logger &quot;About to update vpp software...&quot;
cd /gate_debians
service vpp stop
sudo dpkg -i *.deb &gt;/dev/null 2&gt;&amp;1 &amp;
sleep 20
logger &quot;Ping connectivity test...&quot;
for i in 1 2 3 4 5 6 7 8 9 10
do
    ping -4 -c 1 yahoo.com
    if [ $? == 0 ] ; then
        logger &quot;Ping test OK...&quot;
        exit 0
    fi
done

logger &quot;Ping test NOT OK, restore old software...&quot;
rm -rf /gate_debians
mv /gate_debians.prev /gate_debians
cd /gate_debians
nohup sudo dpkg -i *.deb &gt;/dev/null 2&gt;&amp;1 &amp;
sleep 20
logger &quot;Repeat connectivity test...&quot;
for i in 1 2 3 4 5 6 7 8 9 10
do
    ping -4 -c 1 yahoo.com
    if [ $? == 0 ] ; then
        logger &quot;Ping test OK after restoring old software...&quot;
        exit 0
    fi
done

logger &quot;Ping test FAIL after restoring software, manual intervention required&quot;
exit 2
</pre></div>
</div>
<p>Note that the target script <strong>requires</strong> that the userid which invokes
it will manage to “sudo dpkg …” without further authentication. If
you’re uncomfortable with the security implications of that
requirement, you’ll need to solve the problem a different
way. Strongly suggest configuring sshd as described above to minimize
risk.</p>
</div>
</div>
<div class="section" id="testing-new-software">
<h2>Testing new software<a class="headerlink" href="#testing-new-software" title="Permalink to this headline">¶</a></h2>
<p>If you frequently test new home gateway software, it may be handy to set
up a test gateway behind your production gateway. This testing
methodology reduces complaints from family members, to name one benefit.</p>
<p>Change the inside network (dhcp) subnet from 192.168.1.0/24 to
192.168.3.0/24, change the (dhcp) advertised router to 192.168.3.1,
reconfigure the vpp tap interface addresses onto the 192.168.3.0/24
subnet, and you should be all set.</p>
<p>This scenario nats traffic twice: first, from the 192.168.3.0/24 network
onto the 192.168.1.0/24 network. Next, from the 192.168.1.0/24 network
onto the public internet.</p>
</div>
<div class="section" id="patches">
<h2>Patches<a class="headerlink" href="#patches" title="Permalink to this headline">¶</a></h2>
<p>You’ll want this addition to src/vpp/vnet/main.c to add the “service
restart isc-dhcp-server” and “service restart vpp” commands:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#include &lt;sys/types.h&gt;</span>
<span class="c1">#include &lt;sys/wait.h&gt;</span>

<span class="n">static</span> <span class="nb">int</span>
<span class="n">mysystem</span> <span class="p">(</span><span class="n">char</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
  <span class="nb">int</span> <span class="n">rv</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">fork</span><span class="p">())</span>
    <span class="n">wait</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">rv</span><span class="p">);</span>
  <span class="k">else</span>
    <span class="n">execl</span><span class="p">(</span><span class="s2">&quot;/bin/sh&quot;</span><span class="p">,</span> <span class="s2">&quot;sh&quot;</span><span class="p">,</span> <span class="s2">&quot;-c&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">clib_unix_warning</span> <span class="p">(</span><span class="s2">&quot;(&#39;</span><span class="si">%s</span><span class="s2">&#39;) child process returned </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">rv</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">rv</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">static</span> <span class="n">clib_error_t</span> <span class="o">*</span>
<span class="n">restart_isc_dhcp_server_command_fn</span> <span class="p">(</span><span class="n">vlib_main_t</span> <span class="o">*</span> <span class="n">vm</span><span class="p">,</span>
                                    <span class="n">unformat_input_t</span> <span class="o">*</span> <span class="nb">input</span><span class="p">,</span>
                                    <span class="n">vlib_cli_command_t</span> <span class="o">*</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
  <span class="nb">int</span> <span class="n">rv</span><span class="p">;</span>

  <span class="o">/*</span> <span class="n">Wait</span> <span class="n">a</span> <span class="k">while</span><span class="o">...</span> <span class="o">*/</span>
  <span class="n">vlib_process_suspend</span> <span class="p">(</span><span class="n">vm</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">);</span>

  <span class="n">rv</span> <span class="o">=</span> <span class="n">mysystem</span><span class="p">(</span><span class="s2">&quot;/usr/sbin/service isc-dhcp-server restart&quot;</span><span class="p">);</span>

  <span class="n">vlib_cli_output</span> <span class="p">(</span><span class="n">vm</span><span class="p">,</span> <span class="s2">&quot;Restarted the isc-dhcp-server, status </span><span class="si">%d</span><span class="s2">...&quot;</span><span class="p">,</span> <span class="n">rv</span><span class="p">);</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="o">/*</span> <span class="o">*</span><span class="n">INDENT</span><span class="o">-</span><span class="n">OFF</span><span class="o">*</span> <span class="o">*/</span>
<span class="n">VLIB_CLI_COMMAND</span> <span class="p">(</span><span class="n">restart_isc_dhcp_server_command</span><span class="p">,</span> <span class="n">static</span><span class="p">)</span> <span class="o">=</span>
<span class="p">{</span>
  <span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="s2">&quot;service restart isc-dhcp-server&quot;</span><span class="p">,</span>
  <span class="o">.</span><span class="n">short_help</span> <span class="o">=</span> <span class="s2">&quot;restarts the isc-dhcp-server&quot;</span><span class="p">,</span>
  <span class="o">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">restart_isc_dhcp_server_command_fn</span><span class="p">,</span>
<span class="p">};</span>
<span class="o">/*</span> <span class="o">*</span><span class="n">INDENT</span><span class="o">-</span><span class="n">ON</span><span class="o">*</span> <span class="o">*/</span>

<span class="n">static</span> <span class="n">clib_error_t</span> <span class="o">*</span>
<span class="n">restart_dora_tunnels_command_fn</span> <span class="p">(</span><span class="n">vlib_main_t</span> <span class="o">*</span> <span class="n">vm</span><span class="p">,</span>
                                 <span class="n">unformat_input_t</span> <span class="o">*</span> <span class="nb">input</span><span class="p">,</span>
                                 <span class="n">vlib_cli_command_t</span> <span class="o">*</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
  <span class="nb">int</span> <span class="n">rv</span><span class="p">;</span>

  <span class="o">/*</span> <span class="n">Wait</span> <span class="n">three</span> <span class="n">seconds</span><span class="o">...</span> <span class="o">*/</span>
  <span class="n">vlib_process_suspend</span> <span class="p">(</span><span class="n">vm</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">);</span>

  <span class="n">rv</span> <span class="o">=</span> <span class="n">mysystem</span> <span class="p">(</span><span class="s2">&quot;/usr/sbin/service dora restart&quot;</span><span class="p">);</span>

  <span class="n">vlib_cli_output</span> <span class="p">(</span><span class="n">vm</span><span class="p">,</span> <span class="s2">&quot;Restarted the dora tunnel service, status </span><span class="si">%d</span><span class="s2">...&quot;</span><span class="p">,</span> <span class="n">rv</span><span class="p">);</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="o">/*</span> <span class="o">*</span><span class="n">INDENT</span><span class="o">-</span><span class="n">OFF</span><span class="o">*</span> <span class="o">*/</span>
<span class="n">VLIB_CLI_COMMAND</span> <span class="p">(</span><span class="n">restart_dora_tunnels_command</span><span class="p">,</span> <span class="n">static</span><span class="p">)</span> <span class="o">=</span>
<span class="p">{</span>
  <span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="s2">&quot;service restart dora&quot;</span><span class="p">,</span>
  <span class="o">.</span><span class="n">short_help</span> <span class="o">=</span> <span class="s2">&quot;restarts the dora tunnel service&quot;</span><span class="p">,</span>
  <span class="o">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">restart_dora_tunnels_command_fn</span><span class="p">,</span>
<span class="p">};</span>
<span class="o">/*</span> <span class="o">*</span><span class="n">INDENT</span><span class="o">-</span><span class="n">ON</span><span class="o">*</span> <span class="o">*/</span>

<span class="n">static</span> <span class="n">clib_error_t</span> <span class="o">*</span>
<span class="n">restart_vpp_service_command_fn</span> <span class="p">(</span><span class="n">vlib_main_t</span> <span class="o">*</span> <span class="n">vm</span><span class="p">,</span>
                                <span class="n">unformat_input_t</span> <span class="o">*</span> <span class="nb">input</span><span class="p">,</span>
                                <span class="n">vlib_cli_command_t</span> <span class="o">*</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
  <span class="p">(</span><span class="n">void</span><span class="p">)</span> <span class="n">mysystem</span> <span class="p">(</span><span class="s2">&quot;/usr/sbin/service vpp restart&quot;</span><span class="p">);</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="o">/*</span> <span class="o">*</span><span class="n">INDENT</span><span class="o">-</span><span class="n">OFF</span><span class="o">*</span> <span class="o">*/</span>
<span class="n">VLIB_CLI_COMMAND</span> <span class="p">(</span><span class="n">restart_vpp_service_command</span><span class="p">,</span> <span class="n">static</span><span class="p">)</span> <span class="o">=</span>
<span class="p">{</span>
  <span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="s2">&quot;service restart vpp&quot;</span><span class="p">,</span>
  <span class="o">.</span><span class="n">short_help</span> <span class="o">=</span> <span class="s2">&quot;restarts the vpp service, be careful what you wish for&quot;</span><span class="p">,</span>
  <span class="o">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">restart_vpp_service_command_fn</span><span class="p">,</span>
<span class="p">};</span>
<span class="o">/*</span> <span class="o">*</span><span class="n">INDENT</span><span class="o">-</span><span class="n">ON</span><span class="o">*</span> <span class="o">*/</span>
</pre></div>
</div>
</div>
<div class="section" id="using-the-time-based-mac-filter-plugin">
<h2>Using the time-based mac filter plugin<a class="headerlink" href="#using-the-time-based-mac-filter-plugin" title="Permalink to this headline">¶</a></h2>
<p>If you need to restrict network access for certain devices to specific
daily time ranges, configure the “mactime” plugin. Add it to the list
of enabled plugins in /etc/vpp/startup.conf, then enable the feature on
the NAT “inside” interfaces:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">bin</span> <span class="n">mactime_enable_disable</span> <span class="n">GigabitEthernet0</span><span class="o">/</span><span class="mi">14</span><span class="o">/</span><span class="mi">0</span>
<span class="nb">bin</span> <span class="n">mactime_enable_disable</span> <span class="n">GigabitEthernet0</span><span class="o">/</span><span class="mi">14</span><span class="o">/</span><span class="mi">1</span>
<span class="o">...</span>
</pre></div>
</div>
<p>Create the required src-mac-address rule database. There are 4 rule
entry types:</p>
<ul class="simple">
<li><p>allow-static - pass traffic from this mac address</p></li>
<li><p>drop-static - drop traffic from this mac address</p></li>
<li><p>allow-range - pass traffic from this mac address at specific times</p></li>
<li><p>drop-range - drop traffic from this mac address at specific times</p></li>
</ul>
<p>Here are some examples:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">bin</span> <span class="n">mactime_add_del_range</span> <span class="n">name</span> <span class="n">alarm</span><span class="o">-</span><span class="n">system</span> <span class="n">mac</span> <span class="mi">00</span><span class="p">:</span><span class="n">de</span><span class="p">:</span><span class="n">ad</span><span class="p">:</span><span class="n">be</span><span class="p">:</span><span class="n">ef</span><span class="p">:</span><span class="mi">00</span> <span class="n">allow</span><span class="o">-</span><span class="n">static</span>
<span class="nb">bin</span> <span class="n">mactime_add_del_range</span> <span class="n">name</span> <span class="n">unwelcome</span> <span class="n">mac</span> <span class="mi">00</span><span class="p">:</span><span class="n">de</span><span class="p">:</span><span class="n">ad</span><span class="p">:</span><span class="n">be</span><span class="p">:</span><span class="n">ef</span><span class="p">:</span><span class="mi">01</span> <span class="n">drop</span><span class="o">-</span><span class="n">static</span>
<span class="nb">bin</span> <span class="n">mactime_add_del_range</span> <span class="n">name</span> <span class="ow">not</span><span class="o">-</span><span class="n">during</span><span class="o">-</span><span class="n">business</span><span class="o">-</span><span class="n">hours</span> <span class="n">mac</span> <span class="o">&lt;</span><span class="n">mac</span><span class="o">&gt;</span> <span class="n">drop</span><span class="o">-</span><span class="nb">range</span> <span class="n">Mon</span> <span class="o">-</span> <span class="n">Fri</span> <span class="mi">7</span><span class="p">:</span><span class="mi">59</span> <span class="o">-</span> <span class="mi">18</span><span class="p">:</span><span class="mi">01</span>
<span class="nb">bin</span> <span class="n">mactime_add_del_range</span> <span class="n">name</span> <span class="n">monday</span><span class="o">-</span><span class="n">busines</span><span class="o">-</span><span class="n">hours</span> <span class="n">mac</span> <span class="o">&lt;</span><span class="n">mac</span><span class="o">&gt;</span> <span class="n">allow</span><span class="o">-</span><span class="nb">range</span> <span class="n">Mon</span> <span class="mi">7</span><span class="p">:</span><span class="mi">59</span> <span class="o">-</span> <span class="mi">18</span><span class="p">:</span><span class="mi">01</span>
</pre></div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="contiv/index.html" class="btn btn-neutral float-right" title="Contiv/VPP" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="automatingthedeployment.html" class="btn btn-neutral float-left" title="Automating VPP deployment" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018-2021, Linux Foundation

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>