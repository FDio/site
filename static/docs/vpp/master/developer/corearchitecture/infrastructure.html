<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>VPPINFRA (Infrastructure) &mdash; The Vector Packet Processor v22.02-rc0-128-g4450b03ba
 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/rules.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="VLIB (Vector Processing Library)" href="vlib.html" />
    <link rel="prev" title="Software Architecture" href="softwarearchitecture.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> The Vector Packet Processor
            <img src="../../_static/fd-io_red_white.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                v22.02-rc0-128-g4450b03ba

              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">About VPP</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../aboutvpp/scalar-vs-vector-packet-processing.html">Scalar vs Vector packet processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../aboutvpp/extensible.html">The Packet Processing Graph</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../aboutvpp/networkstack.html">Network Stack Features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../aboutvpp/hoststack.html">Host Stack</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../aboutvpp/developer.html">Additional features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../aboutvpp/supported.html">Supported archs and OS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../aboutvpp/performance.html">Performance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../aboutvpp/releasenotes/index.html">Release notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../aboutvpp/featurelist.html">VPP Supported Features</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Use Cases</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../usecases/containers/index.html">VPP with Containers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usecases/simpleperf/index.html">VPP with Iperf3 and TRex</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usecases/vppcloud/index.html">VPP in the Cloud</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usecases/vhost/index.html">VPP with Virtual Machines</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usecases/vmxnet3.html">VPP with VMware/Vmxnet3</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usecases/home_gateway.html">VPP as a Home Gateway</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usecases/acls.html">Access Control Lists with VPP</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usecases/networksim.html">Generating traffic with VPP</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usecases/webapp.html">Web applications with VPP</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usecases/container_test.html">Simulating networks with VPP</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usecases/trafficgen.html">Stateless Traffic Gen with VPP</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usecases/ikev2/index.html">IKEv2 with VPP</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usecases/contiv/index.html">VPP in kubernetes (Contiv/Deprecated)</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Getting started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../gettingstarted/installing/index.html">Downloading and Installing VPP</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../gettingstarted/running/index.html">Running VPP</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../gettingstarted/progressivevpp/index.html">Progressive VPP Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../gettingstarted/troubleshooting/index.html">Troubleshooting</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developer Documentation</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../build-run-debug/index.html">Build, Run &amp; Debug</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Core Architecture</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="softwarearchitecture.html">Software Architecture</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">VPPINFRA (Infrastructure)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#vectors">Vectors</a></li>
<li class="toctree-l3"><a class="reference internal" href="#bitmaps">Bitmaps</a></li>
<li class="toctree-l3"><a class="reference internal" href="#pools">Pools</a></li>
<li class="toctree-l3"><a class="reference internal" href="#hashes">Hashes</a></li>
<li class="toctree-l3"><a class="reference internal" href="#timekeeping">Timekeeping</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#monotonic-timebase-support">Monotonic timebase support</a></li>
<li class="toctree-l4"><a class="reference internal" href="#timebase-precision">Timebase precision</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#timer-wheels">Timer Wheels</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#api-usage-examples">API usage examples</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#format">Format</a></li>
<li class="toctree-l3"><a class="reference internal" href="#unformat">Unformat</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#how-to-parse-a-single-input-line">How to parse a single input line</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#vppinfra-errors-and-warnings">Vppinfra errors and warnings</a></li>
<li class="toctree-l3"><a class="reference internal" href="#serialization">Serialization</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="vlib.html">VLIB (Vector Processing Library)</a></li>
<li class="toctree-l2"><a class="reference internal" href="vnet.html">VNET (VPP Network Stack)</a></li>
<li class="toctree-l2"><a class="reference internal" href="featurearcs.html">Feature Arcs</a></li>
<li class="toctree-l2"><a class="reference internal" href="buffer_metadata.html">Buffer Metadata</a></li>
<li class="toctree-l2"><a class="reference internal" href="multiarch/index.html">Multi-architecture support</a></li>
<li class="toctree-l2"><a class="reference internal" href="bihash.html">Bounded-index Extensible Hashing (bihash)</a></li>
<li class="toctree-l2"><a class="reference internal" href="buildsystem/index.html">Build System</a></li>
<li class="toctree-l2"><a class="reference internal" href="mem.html">VPP mem preload</a></li>
<li class="toctree-l2"><a class="reference internal" href="multi_thread.html">Multi-threading in VPP</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../corefeatures/index.html">Core Features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../plugindoc/index.html">Adding a new plugin or feature</a></li>
<li class="toctree-l1"><a class="reference internal" href="../plugins/index.html">Plugins</a></li>
<li class="toctree-l1"><a class="reference internal" href="../devicedrivers/index.html">Device drivers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tests/overview.html">VPP Test Framework</a></li>
<li class="toctree-l1"><a class="reference internal" href="../extras/index.html">VPP extra tools</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Interfacing with VPP</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../interfacing/binapi/index.html">The binary API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../interfacing/c/index.html">C api client</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../interfacing/cpp/index.html">C++ api client</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../interfacing/go/index.html">Go api (govpp)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../interfacing/rust/index.html">Rust api client</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../interfacing/libmemif/index.html">Memif library (libmemif)</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Contributing</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../contributing/gitreview.html">Getting a Patch Reviewed</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contributing/writingdocs.html">Writing VPP Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contributing/reportingissues/index.html">Reporting Bugs</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Debug CLI</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../cli-reference/gettingstarted/index.html">Getting Started with the debug CLI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cli-reference/interface/index.html">Interface Commands</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cli-reference/index.html">Reference</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Configuration file</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../configuration/config_getting_started.html">Getting started with the configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../configuration/reference.html">Configuration Reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">The Vector Packet Processor</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="index.html">Core Architecture</a> &raquo;</li>
      <li>VPPINFRA (Infrastructure)</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/developer/corearchitecture/infrastructure.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="vppinfra-infrastructure">
<h1>VPPINFRA (Infrastructure)<a class="headerlink" href="#vppinfra-infrastructure" title="Permalink to this headline"></a></h1>
<p>The files associated with the VPP Infrastructure layer are located in
the <code class="docutils literal notranslate"><span class="pre">./src/vppinfra</span></code> folder.</p>
<p>VPPinfra is a collection of basic c-library services, quite sufficient
to build standalone programs to run directly on bare metal. It also
provides high-performance dynamic arrays, hashes, bitmaps,
high-precision real-time clock support, fine-grained event-logging, and
data structure serialization.</p>
<p>One fair comment / fair warning about vppinfra: you can’t always tell a
macro from an inline function from an ordinary function simply by name.
Macros are used to avoid function calls in the typical case, and to
cause (intentional) side-effects.</p>
<p>Vppinfra has been around for almost 20 years and tends not to change
frequently. The VPP Infrastructure layer contains the following
functions:</p>
<section id="vectors">
<h2>Vectors<a class="headerlink" href="#vectors" title="Permalink to this headline"></a></h2>
<p>Vppinfra vectors are ubiquitous dynamically resized arrays with by user
defined “headers”. Many vpppinfra data structures (e.g. hash, heap,
pool) are vectors with various different headers.</p>
<p>The memory layout looks like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>                  <span class="n">User</span> <span class="n">header</span> <span class="p">(</span><span class="n">optional</span><span class="p">,</span> <span class="n">uword</span> <span class="n">aligned</span><span class="p">)</span>
                  <span class="n">Alignment</span> <span class="n">padding</span> <span class="p">(</span><span class="k">if</span> <span class="n">needed</span><span class="p">)</span>
                  <span class="n">Vector</span> <span class="n">length</span> <span class="ow">in</span> <span class="n">elements</span>
<span class="n">User</span><span class="s1">&#39;s pointer -&gt; Vector element 0</span>
                  <span class="n">Vector</span> <span class="n">element</span> <span class="mi">1</span>
                  <span class="o">...</span>
                  <span class="n">Vector</span> <span class="n">element</span> <span class="n">N</span><span class="o">-</span><span class="mi">1</span>
</pre></div>
</div>
<p>As shown above, the vector APIs deal with pointers to the 0th element of
a vector. Null pointers are valid vectors of length zero.</p>
<p>To avoid thrashing the memory allocator, one often resets the length of
a vector to zero while retaining the memory allocation. Set the vector
length field to zero via the vec_reset_length(v) macro. [Use the macro!
It’s smart about NULL pointers.]</p>
<p>Typically, the user header is not present. User headers allow for other
data structures to be built atop vppinfra vectors. Users may specify the
alignment for first data element of a vector via the [vec]()*_aligned
macros.</p>
<p>Vector elements can be any C type e.g. (int, double, struct bar). This
is also true for data types built atop vectors (e.g. heap, pool, etc.).
Many macros have _a variants supporting alignment of vector elements
and _h variants supporting non-zero-length vector headers. The _ha
variants support both. Additionally cacheline alignment within a vector
element structure can be specified using the
<code class="docutils literal notranslate"><span class="pre">[CLIB_CACHE_LINE_ALIGN_MARK]()</span></code> macro.</p>
<p>Inconsistent usage of header and/or alignment related macro variants
will cause delayed, confusing failures.</p>
<p>Standard programming error: memorize a pointer to the ith element of a
vector, and then expand the vector. Vectors expand by 3/2, so such code
may appear to work for a period of time. Correct code almost always
memorizes vector <strong>indices</strong> which are invariant across reallocations.</p>
<p>In typical application images, one supplies a set of global functions
designed to be called from gdb. Here are a few examples:</p>
<ul class="simple">
<li><p>vl(v) - prints vec_len(v)</p></li>
<li><p>pe(p) - prints pool_elts(p)</p></li>
<li><p>pifi(p, index) - prints pool_is_free_index(p, index)</p></li>
<li><p>debug_hex_bytes (p, nbytes) - hex memory dump nbytes starting at p</p></li>
</ul>
<p>Use the “show gdb” debug CLI command to print the current set.</p>
</section>
<section id="bitmaps">
<h2>Bitmaps<a class="headerlink" href="#bitmaps" title="Permalink to this headline"></a></h2>
<p>Vppinfra bitmaps are dynamic, built using the vppinfra vector APIs.
Quite handy for a variety jobs.</p>
</section>
<section id="pools">
<h2>Pools<a class="headerlink" href="#pools" title="Permalink to this headline"></a></h2>
<p>Vppinfra pools combine vectors and bitmaps to rapidly allocate and free
fixed-size data structures with independent lifetimes. Pools are perfect
for allocating per-session structures.</p>
</section>
<section id="hashes">
<h2>Hashes<a class="headerlink" href="#hashes" title="Permalink to this headline"></a></h2>
<p>Vppinfra provides several hash flavors. Data plane problems involving
packet classification / session lookup often use
./src/vppinfra/bihash_template.[ch] bounded-index extensible hashes.
These templates are instantiated multiple times, to efficiently service
different fixed-key sizes.</p>
<p>Bihashes are thread-safe. Read-locking is not required. A simple
spin-lock ensures that only one thread writes an entry at a time.</p>
<p>The original vppinfra hash implementation in ./src/vppinfra/hash.[ch]
are simple to use, and are often used in control-plane code which needs
exact-string-matching.</p>
<p>In either case, one almost always looks up a key in a hash table to
obtain an index in a related vector or pool. The APIs are simple enough,
but one must take care when using the unmanaged arbitrary-sized key
variant. Hash_set_mem (hash_table, key_pointer, value) memorizes
key_pointer. It is usually a bad mistake to pass the address of a vector
element as the second argument to hash_set_mem. It is perfectly fine to
memorize constant string addresses in the text segment.</p>
</section>
<section id="timekeeping">
<h2>Timekeeping<a class="headerlink" href="#timekeeping" title="Permalink to this headline"></a></h2>
<p>Vppinfra includes high-precision, low-cost timing services. The datatype
clib_time_t and associated functions reside in ./src/vppinfra/time.[ch].
Call clib_time_init (clib_time_t *cp) to initialize the clib_time_t
object.</p>
<p>Clib_time_init(…) can use a variety of different ways to establish the
hardware clock frequency. At the end of the day, vppinfra timekeeping
takes the attitude that the operating system’s clock is the closest
thing to a gold standard it has handy.</p>
<p>When properly configured, NTP maintains kernel clock synchronization
with a highly accurate off-premises reference clock. Notwithstanding
network propagation delays, a synchronized NTP client will keep the
kernel clock accurate to within 50ms or so.</p>
<p>Why should one care? Simply put, oscillators used to generate CPU ticks
aren’t super accurate. They work pretty well, but a 0.1% error wouldn’t
be out of the question. That’s a minute and a half’s worth of error in 1
day. The error changes constantly, due to temperature variation, and a
host of other physical factors.</p>
<p>It’s far too expensive to use system calls for timing, so we’re left
with the problem of continuously adjusting our view of the CPU tick
register’s clocks_per_second parameter.</p>
<p>The clock rate adjustment algorithm measures the number of cpu ticks and
the “gold standard” reference time across an interval of approximately
16 seconds. We calculate clocks_per_second for the interval: use rdtsc
(on x86_64) and a system call to get the latest cpu tick count and the
kernel’s latest nanosecond timestamp. We subtract the previous interval
end values, and use exponential smoothing to merge the new clock rate
sample into the clocks_per_second parameter.</p>
<p>As of this writing, we maintain the clock rate by way of the following
first-order differential equation:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">clocks_per_second</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">clocks_per_second</span><span class="p">(</span><span class="n">t</span><span class="mi">-1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">K</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">sample_cps</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">K</span><span class="p">)</span><span class="w"></span>
<span class="n">where</span><span class="w"> </span><span class="n">K</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">e</span><span class="o">**</span><span class="p">(</span><span class="mf">-1.0</span><span class="o">/</span><span class="mf">3.75</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>This yields a per observation “half-life” of 1 minute. Empirically, the
clock rate converges within 5 minutes, and appears to maintain
near-perfect agreement with the kernel clock in the face of ongoing NTP
time adjustments.</p>
<p>See ./src/vppinfra/time.c:clib_time_verify_frequency(…) to look at the
rate adjustment algorithm. The code rejects frequency samples
corresponding to the sort of adjustment which might occur if someone
changes the gold standard kernel clock by several seconds.</p>
<section id="monotonic-timebase-support">
<h3>Monotonic timebase support<a class="headerlink" href="#monotonic-timebase-support" title="Permalink to this headline"></a></h3>
<p>Particularly during system initialization, the “gold standard” system
reference clock can change by a large amount, in an instant. It’s not a
best practice to yank the reference clock - in either direction - by
hours or days. In fact, some poorly-constructed use-cases do so.</p>
<p>To deal with this reality, clib_time_now(…) returns the number of
seconds since vpp started, <em>guaranteed to be monotonically increasing,
no matter what happens to the system reference clock</em>.</p>
<p>This is first-order important, to avoid breaking every active timer in
the system. The vpp host stack alone may account for tens of millions of
active timers. It’s utterly impractical to track down and fix timers, so
we must deal with the issue at the timebase level.</p>
<p>Here’s how it works. Prior to adjusting the clock rate, we collect the
kernel reference clock and the cpu clock:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cm">/* Ask the kernel and the CPU what time it is... */</span><span class="w"></span>
<span class="n">now_reference</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">unix_time_now</span><span class="w"> </span><span class="p">();</span><span class="w"></span>
<span class="n">now_clock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">clib_cpu_time_now</span><span class="w"> </span><span class="p">();</span><span class="w"></span>
</pre></div>
</div>
<p>Compute changes for both clocks since the last rate adjustment, roughly
15 seconds ago:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cm">/* Compute change in the reference clock */</span><span class="w"></span>
<span class="n">delta_reference</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">now_reference</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">c</span><span class="o">-&gt;</span><span class="n">last_verify_reference_time</span><span class="p">;</span><span class="w"></span>

<span class="cm">/* And change in the CPU clock */</span><span class="w"></span>
<span class="n">delta_clock_in_seconds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">f64</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">now_clock</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">c</span><span class="o">-&gt;</span><span class="n">last_verify_cpu_time</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"></span>
<span class="w">  </span><span class="n">c</span><span class="o">-&gt;</span><span class="n">seconds_per_clock</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<p>Delta_reference is key. Almost 100% of the time, delta_reference and
delta_clock_in_seconds are identical modulo one system-call time.
However, NTP or a privileged user can yank the system reference time -
in either direction - by an hour, a day, or a decade.</p>
<p>As described above, clib_time_now(…) must return monotonically
increasing answers to the question “how long has it been since vpp
started, in seconds.” To do that, the clock rate adjustment algorithm
begins by recomputing the initial reference time:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">c</span><span class="o">-&gt;</span><span class="n">init_reference_time</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="p">(</span><span class="n">delta_reference</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">delta_clock_in_seconds</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>It’s easy to convince yourself that if the reference clock changes by
15.000000 seconds and the cpu clock tick time changes by 15.000000
seconds, the initial reference time won’t change.</p>
<p>If, on the other hand, delta_reference is -86400.0 and delta clock is
15.0 - reference time jumped backwards by exactly one day in a 15-second
rate update interval - we add -86415.0 to the initial reference time.</p>
<p>Given the corrected initial reference time, we recompute the total
number of cpu ticks which have occurred since the corrected initial
reference time, at the current clock tick rate:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">c</span><span class="o">-&gt;</span><span class="n">total_cpu_time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">now_reference</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">c</span><span class="o">-&gt;</span><span class="n">init_reference_time</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="o">*</span><span class="w"> </span><span class="n">c</span><span class="o">-&gt;</span><span class="n">clocks_per_second</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="timebase-precision">
<h3>Timebase precision<a class="headerlink" href="#timebase-precision" title="Permalink to this headline"></a></h3>
<p>Cognoscenti may notice that vlib/clib_time_now(…) return a 64-bit
floating-point value; the number of seconds since vpp started.</p>
<p>Please see <a class="reference external" href="https://en.wikipedia.org/wiki/Double-precision_floating-point_format">this Wikipedia
article</a>
for more information. C double-precision floating point numbers (called
f64 in the vpp code base) have a 53-bit effective mantissa, and can
accurately represent 15 decimal digits’ worth of precision.</p>
<p>There are 315,360,000.000001 seconds in ten years plus one microsecond.
That string has exactly 15 decimal digits. The vpp time base retains 1us
precision for roughly 30 years.</p>
<p>vlib/clib_time_now do <em>not</em> provide precision in excess of 1e-6 seconds.
If necessary, please use clib_cpu_time_now(…) for direct access to the
CPU clock-cycle counter. Note that the number of CPU clock cycles per
second varies significantly across CPU architectures.</p>
</section>
</section>
<section id="timer-wheels">
<h2>Timer Wheels<a class="headerlink" href="#timer-wheels" title="Permalink to this headline"></a></h2>
<p>Vppinfra includes configurable timer wheel support. See the source code
in …/src/vppinfra/tw_timer_template.[ch], as well as a considerable
number of template instances defined in …/src/vppinfra/tw_timer_.[ch].</p>
<p>Instantiation of tw_timer_template.h generates named structures to
implement specific timer wheel geometries. Choices include: number of
timer wheels (currently, 1 or 2), number of slots per ring (a power of
two), and the number of timers per “object handle”.</p>
<p>Internally, user object/timer handles are 32-bit integers, so if one
selects 16 timers/object (4 bits), the resulting timer wheel handle is
limited to 2**28 objects.</p>
<p>Here are the specific settings required to generate a single 2048 slot
wheel which supports 2 timers per object:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#define TW_TIMER_WHEELS 1</span>
<span class="cp">#define TW_SLOTS_PER_RING 2048</span>
<span class="cp">#define TW_RING_SHIFT 11</span>
<span class="cp">#define TW_RING_MASK (TW_SLOTS_PER_RING -1)</span>
<span class="cp">#define TW_TIMERS_PER_OBJECT 2</span>
<span class="cp">#define LOG2_TW_TIMERS_PER_OBJECT 1</span>
<span class="cp">#define TW_SUFFIX _2t_1w_2048sl</span>
<span class="cp">#define TW_FAST_WHEEL_BITMAP 0</span>
<span class="cp">#define TW_TIMER_ALLOW_DUPLICATE_STOP 0</span>
</pre></div>
</div>
<p>See tw_timer_2t_1w_2048sl.h for a complete example.</p>
<p>tw_timer_template.h is not intended to be #included directly. Client
codes can include multiple timer geometry header files, although extreme
caution would required to use the TW and TWT macros in such a case.</p>
<section id="api-usage-examples">
<h3>API usage examples<a class="headerlink" href="#api-usage-examples" title="Permalink to this headline"></a></h3>
<p>The unit test code in …/src/vppinfra/test_tw_timer.c provides a concrete
API usage example. It uses a synthetic clock to rapidly exercise the
underlying tw_timer_expire_timers(…) template.</p>
<p>There are not many API routines to call.</p>
<section id="initialize-a-two-timer-single-2048-slot-wheel-w-a-1-second-timer-granularity">
<h4>Initialize a two-timer, single 2048-slot wheel w/ a 1-second timer granularity<a class="headerlink" href="#initialize-a-two-timer-single-2048-slot-wheel-w-a-1-second-timer-granularity" title="Permalink to this headline"></a></h4>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">tw_timer_wheel_init_2t_1w_2048sl</span><span class="w"> </span><span class="p">(</span><span class="o">&amp;</span><span class="n">tm</span><span class="o">-&gt;</span><span class="n">single_wheel</span><span class="p">,</span><span class="w"></span>
<span class="w">                                 </span><span class="n">expired_timer_single_callback</span><span class="p">,</span><span class="w"></span>
<span class="w">                  </span><span class="mf">1.0</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">timer</span><span class="w"> </span><span class="n">interval</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="start-a-timer">
<h4>Start a timer<a class="headerlink" href="#start-a-timer" title="Permalink to this headline"></a></h4>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">handle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tw_timer_start_2t_1w_2048sl</span><span class="w"> </span><span class="p">(</span><span class="o">&amp;</span><span class="n">tm</span><span class="o">-&gt;</span><span class="n">single_wheel</span><span class="p">,</span><span class="w"> </span><span class="n">elt_index</span><span class="p">,</span><span class="w"></span>
<span class="w">                                      </span><span class="p">[</span><span class="mi">0</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">timer</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">,</span><span class="w"></span>
<span class="w">                                      </span><span class="n">expiration_time_in_u32_ticks</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="stop-a-timer">
<h4>Stop a timer<a class="headerlink" href="#stop-a-timer" title="Permalink to this headline"></a></h4>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">tw_timer_stop_2t_1w_2048sl</span><span class="w"> </span><span class="p">(</span><span class="o">&amp;</span><span class="n">tm</span><span class="o">-&gt;</span><span class="n">single_wheel</span><span class="p">,</span><span class="w"> </span><span class="n">handle</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="an-expired-timer-callback">
<h4>An expired timer callback<a class="headerlink" href="#an-expired-timer-callback" title="Permalink to this headline"></a></h4>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"></span>
<span class="nf">expired_timer_single_callback</span><span class="w"> </span><span class="p">(</span><span class="n">u32</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">expired_timers</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">u32</span><span class="w"> </span><span class="n">pool_index</span><span class="p">,</span><span class="w"> </span><span class="n">timer_id</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">tw_timer_test_elt_t</span><span class="w"> </span><span class="o">*</span><span class="n">e</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">tw_timer_test_main_t</span><span class="w"> </span><span class="o">*</span><span class="n">tm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">tw_timer_test_main</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">vec_len</span><span class="w"> </span><span class="p">(</span><span class="n">expired_timers</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">pool_index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">expired_timers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x7FFFFFFF</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">timer_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">expired_timers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">31</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="n">ASSERT</span><span class="w"> </span><span class="p">(</span><span class="n">timer_id</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="n">e</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pool_elt_at_index</span><span class="w"> </span><span class="p">(</span><span class="n">tm</span><span class="o">-&gt;</span><span class="n">test_elts</span><span class="p">,</span><span class="w"> </span><span class="n">pool_index</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">expected_to_expire</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">tm</span><span class="o">-&gt;</span><span class="n">single_wheel</span><span class="p">.</span><span class="n">current_tick</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">fformat</span><span class="w"> </span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;[%d] expired at %d not %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">                     </span><span class="n">e</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">tm</span><span class="o">-&gt;</span><span class="n">test_elts</span><span class="p">,</span><span class="w"> </span><span class="n">tm</span><span class="o">-&gt;</span><span class="n">single_wheel</span><span class="p">.</span><span class="n">current_tick</span><span class="p">,</span><span class="w"></span>
<span class="w">                     </span><span class="n">e</span><span class="o">-&gt;</span><span class="n">expected_to_expire</span><span class="p">);</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">     </span><span class="n">pool_put</span><span class="w"> </span><span class="p">(</span><span class="n">tm</span><span class="o">-&gt;</span><span class="n">test_elts</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">);</span><span class="w"></span>
<span class="w">     </span><span class="p">}</span><span class="w"></span>
<span class="w"> </span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>We use wheel timers extensively in the vpp host stack. Each TCP session
needs 5 timers, so supporting 10 million flows requires up to 50 million
concurrent timers.</p>
<p>Timers rarely expire, so it’s of utmost important that stopping and
restarting a timer costs as few clock cycles as possible.</p>
<p>Stopping a timer costs a doubly-linked list dequeue. Starting a timer
involves modular arithmetic to determine the correct timer wheel and
slot, and a list head enqueue.</p>
<p>Expired timer processing generally involves bulk link-list retirement
with user callback presentation. Some additional complexity at wheel
wrap time, to relocate timers from slower-turning timer wheels into
faster-turning wheels.</p>
</section>
</section>
</section>
<section id="format">
<h2>Format<a class="headerlink" href="#format" title="Permalink to this headline"></a></h2>
<p>Vppinfra format is roughly equivalent to printf.</p>
<p>Format has a few properties worth mentioning. Format’s first argument is
a (u8 *) vector to which it appends the result of the current format
operation. Chaining calls is very easy:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">u8</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">result</span><span class="p">;</span><span class="w"></span>

<span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">format</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;junk = %d, &quot;</span><span class="p">,</span><span class="w"> </span><span class="n">junk</span><span class="p">);</span><span class="w"></span>
<span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">format</span><span class="w"> </span><span class="p">(</span><span class="n">result</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;more junk = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">more_junk</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>As previously noted, NULL pointers are perfectly proper 0-length
vectors. Format returns a (u8 *) vector, <strong>not</strong> a C-string. If you
wish to print a (u8 *) vector, use the “%v” format string. If you need
a (u8 *) vector which is also a proper C-string, either of these
schemes may be used:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">vec_add1</span><span class="w"> </span><span class="p">(</span><span class="n">result</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="n">or</span><span class="w"></span>
<span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">format</span><span class="w"> </span><span class="p">(</span><span class="n">result</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;&lt;whatever&gt;%c&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>Remember to vec_free() the result if appropriate. Be careful not to pass
format an uninitialized (u8 *).</p>
<p>Format implements a particularly handy user-format scheme via the “%U”
format specification. For example:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">u8</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">format_junk</span><span class="w"> </span><span class="p">(</span><span class="n">u8</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="kt">va_list</span><span class="w"> </span><span class="o">*</span><span class="n">va</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">junk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">va_arg</span><span class="w"> </span><span class="p">(</span><span class="n">va</span><span class="p">,</span><span class="w"> </span><span class="n">u32</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">format</span><span class="w"> </span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;%s&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">junk</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">s</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">format</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;junk = %U, format_junk, &quot;</span><span class="n">This</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">some</span><span class="w"> </span><span class="n">junk</span><span class="s">&quot;);</span>
</pre></div>
</div>
<p>format_junk() can invoke other user-format functions if desired. The
programmer shoulders responsibility for argument type-checking. It is
typical for user format functions to blow up spectacularly if the
va_arg(va, type) macros don’t match the caller’s idea of reality.</p>
</section>
<section id="unformat">
<h2>Unformat<a class="headerlink" href="#unformat" title="Permalink to this headline"></a></h2>
<p>Vppinfra unformat is vaguely related to scanf, but considerably more
general.</p>
<p>A typical use case involves initializing an unformat_input_t from either
a C-string or a (u8 *) vector, then parsing via unformat() as follows:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">unformat_input_t</span><span class="w"> </span><span class="n">input</span><span class="p">;</span><span class="w"></span>
<span class="n">u8</span><span class="w"> </span><span class="o">*</span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;&lt;some-C-string&gt;&quot;</span><span class="p">;</span><span class="w"></span>

<span class="n">unformat_init_string</span><span class="w"> </span><span class="p">(</span><span class="o">&amp;</span><span class="n">input</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">strlen</span><span class="p">((</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">s</span><span class="p">));</span><span class="w"></span>
<span class="cm">/* or */</span><span class="w"></span>
<span class="n">unformat_init_vector</span><span class="w"> </span><span class="p">(</span><span class="o">&amp;</span><span class="n">input</span><span class="p">,</span><span class="w"> </span><span class="o">&lt;</span><span class="n">u8</span><span class="o">-</span><span class="n">vector</span><span class="o">&gt;</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>Then loop parsing individual elements:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">unformat_check_input</span><span class="w"> </span><span class="p">(</span><span class="o">&amp;</span><span class="n">input</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">UNFORMAT_END_OF_INPUT</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">unformat</span><span class="w"> </span><span class="p">(</span><span class="o">&amp;</span><span class="n">input</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;value1 %d&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">value1</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="p">;</span><span class="cm">/* unformat sets value1 */</span><span class="w"></span>
<span class="w">  </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">unformat</span><span class="w"> </span><span class="p">(</span><span class="o">&amp;</span><span class="n">input</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;value2 %d&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">value2</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">;</span><span class="cm">/* unformat sets value2 */</span><span class="w"></span>
<span class="w">  </span><span class="k">else</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">clib_error_return</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;unknown input &#39;%U&#39;&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">                              </span><span class="n">format_unformat_error</span><span class="p">,</span><span class="w"> </span><span class="n">input</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>As with format, unformat implements a user-unformat function capability
via a “%U” user unformat function scheme. Generally, one can trivially
transform “format (s,”foo %d”, foo) -&gt; “unformat (input,”foo %d”,
&amp;foo)“.</p>
<p>Unformat implements a couple of handy non-scanf-like format specifiers:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">unformat</span><span class="w"> </span><span class="p">(</span><span class="n">input</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;enable %=&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">enable</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="cm">/* defaults to 1 */</span><span class="p">);</span><span class="w"></span>
<span class="n">unformat</span><span class="w"> </span><span class="p">(</span><span class="n">input</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;bitzero %|&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">mask</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">0</span><span class="p">));</span><span class="w"></span>
<span class="n">unformat</span><span class="w"> </span><span class="p">(</span><span class="n">input</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;bitone %|&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">mask</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">1</span><span class="p">));</span><span class="w"></span>
<span class="o">&lt;</span><span class="n">etc</span><span class="o">&gt;</span><span class="w"></span>
</pre></div>
</div>
<p>The phrase “enable %=” means “set the supplied variable to the default
value” if unformat parses the “enable” keyword all by itself. If
unformat parses “enable 123” set the supplied variable to 123.</p>
<p>We could clean up a number of hand-rolled “verbose” + “verbose %d”
argument parsing codes using “%=”.</p>
<p>The phrase “bitzero %|” means “set the specified bit in the supplied
bitmask” if unformat parses “bitzero”. Although it looks like it could
be fairly handy, it’s very lightly used in the code base.</p>
<p><code class="docutils literal notranslate"><span class="pre">%_</span></code> toggles whether or not to skip input white space.</p>
<p>For transition from skip to no-skip in middle of format string, skip
input white space. For example, the following:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">fmt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;%_%d.%d%_-&gt;%_%d.%d%_&quot;</span><span class="w"></span>
<span class="n">unformat</span><span class="w"> </span><span class="p">(</span><span class="n">input</span><span class="p">,</span><span class="w"> </span><span class="n">fmt</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">one</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">two</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">three</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">four</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>matches input “1.2 -&gt; 3.4”. Without this, the space after -&gt; does not
get skipped.</p>
<section id="how-to-parse-a-single-input-line">
<h3>How to parse a single input line<a class="headerlink" href="#how-to-parse-a-single-input-line" title="Permalink to this headline"></a></h3>
<p>Debug CLI command functions MUST NOT accidentally consume input
belonging to other debug CLI commands. Otherwise, it’s impossible to
script a set of debug CLI commands which “work fine” when issued one
at a time.</p>
<p>This bit of code is NOT correct:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cm">/* Eats script input NOT beloging to it, and chokes! */</span><span class="w"></span>
<span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">unformat_check_input</span><span class="w"> </span><span class="p">(</span><span class="n">input</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">UNFORMAT_END_OF_INPUT</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">unformat</span><span class="w"> </span><span class="p">(</span><span class="n">input</span><span class="p">,</span><span class="w"> </span><span class="p">...))</span><span class="w"></span>
<span class="w">  </span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">unformat</span><span class="w"> </span><span class="p">(</span><span class="n">input</span><span class="p">,</span><span class="w"> </span><span class="p">...))</span><span class="w"></span>
<span class="w">  </span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">else</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">clib_error_return</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;parse error: &#39;%U&#39;&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">                           </span><span class="n">format_unformat_error</span><span class="p">,</span><span class="w"> </span><span class="n">input</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>When executed as part of a script, such a function will return “parse
error: ‘’” every time, unless it happens to be the last command in the
script.</p>
<p>Instead, use “unformat_line_input” to consume the rest of a line’s worth
of input - everything past the path specified in the VLIB_CLI_COMMAND
declaration.</p>
<p>For example, unformat_line_input with “my_command” set up as shown below
and user input “my path is clear” will produce an unformat_input_t that
contains “is clear”.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">VLIB_CLI_COMMAND</span><span class="w"> </span><span class="p">(...)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="n">path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;my path&quot;</span><span class="p">,</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>
</pre></div>
</div>
<p>Here’s a bit of code which shows the required mechanics, in full:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="n">clib_error_t</span><span class="w"> </span><span class="o">*</span><span class="w"></span>
<span class="w"> </span><span class="nf">my_command_fn</span><span class="w"> </span><span class="p">(</span><span class="n">vlib_main_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">vm</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="n">unformat_input_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">input</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="n">vlib_cli_command_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">cmd</span><span class="p">)</span><span class="w"></span>
<span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">   </span><span class="n">unformat_input_t</span><span class="w"> </span><span class="n">_line_input</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">line_input</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">_line_input</span><span class="p">;</span><span class="w"></span>
<span class="w">   </span><span class="n">u32</span><span class="w"> </span><span class="n">this</span><span class="p">,</span><span class="w"> </span><span class="n">that</span><span class="p">;</span><span class="w"></span>
<span class="w">   </span><span class="n">clib_error_t</span><span class="w"> </span><span class="o">*</span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>

<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">unformat_user</span><span class="w"> </span><span class="p">(</span><span class="n">input</span><span class="p">,</span><span class="w"> </span><span class="n">unformat_line_input</span><span class="p">,</span><span class="w"> </span><span class="n">line_input</span><span class="p">))</span><span class="w"></span>
<span class="w">     </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>

<span class="w">   </span><span class="cm">/*</span>
<span class="cm">    * Here, UNFORMAT_END_OF_INPUT is at the end of the line we consumed,</span>
<span class="cm">    * not at the end of the script...</span>
<span class="cm">    */</span><span class="w"></span>
<span class="w">   </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">unformat_check_input</span><span class="w"> </span><span class="p">(</span><span class="n">line_input</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">UNFORMAT_END_OF_INPUT</span><span class="p">)</span><span class="w"></span>
<span class="w">     </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">unformat</span><span class="w"> </span><span class="p">(</span><span class="n">line_input</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;this %u&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">this</span><span class="p">))</span><span class="w"></span>
<span class="w">          </span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">unformat</span><span class="w"> </span><span class="p">(</span><span class="n">line_input</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;that %u&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">that</span><span class="p">))</span><span class="w"></span>
<span class="w">          </span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">else</span><span class="w"></span>
<span class="w">          </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">clib_error_return</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;parse error: &#39;%U&#39;&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">                              </span><span class="n">format_unformat_error</span><span class="p">,</span><span class="w"> </span><span class="n">line_input</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="k">goto</span><span class="w"> </span><span class="n">done</span><span class="p">;</span><span class="w"></span>
<span class="w">          </span><span class="p">}</span><span class="w"></span>
<span class="w">       </span><span class="p">}</span><span class="w"></span>

<span class="w"> </span><span class="o">&lt;</span><span class="k">do</span><span class="w"> </span><span class="n">something</span><span class="w"> </span><span class="n">based</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="s">&quot;this&quot;</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="s">&quot;that&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">etc</span><span class="o">&gt;</span><span class="w"></span>

<span class="w"> </span><span class="nl">done</span><span class="p">:</span><span class="w"></span>
<span class="w">   </span><span class="n">unformat_free</span><span class="w"> </span><span class="p">(</span><span class="n">line_input</span><span class="p">);</span><span class="w"></span>
<span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="n">error</span><span class="p">;</span><span class="w"></span>
<span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="n">VLIB_CLI_COMMAND</span><span class="w"> </span><span class="p">(</span><span class="n">my_command</span><span class="p">,</span><span class="w"> </span><span class="k">static</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="p">.</span><span class="n">path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;my path&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="p">.</span><span class="n">function</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">my_command_fn</span><span class="s">&quot;,</span>
<span class="p">};</span><span class="w"></span>
</pre></div>
</div>
</section>
</section>
<section id="vppinfra-errors-and-warnings">
<h2>Vppinfra errors and warnings<a class="headerlink" href="#vppinfra-errors-and-warnings" title="Permalink to this headline"></a></h2>
<p>Many functions within the vpp dataplane have return-values of type
clib_error_t *. Clib_error_t’s are arbitrary strings with a bit of
metadata [fatal, warning] and are easy to announce. Returning a NULL
clib_error_t * indicates “A-OK, no error.”</p>
<p>Clib_warning(format-args) is a handy way to add debugging output; clib
warnings prepend function:line info to unambiguously locate the message
source. Clib_unix_warning() adds perror()-style Linux system-call
information. In production images, clib_warnings result in syslog
entries.</p>
</section>
<section id="serialization">
<h2>Serialization<a class="headerlink" href="#serialization" title="Permalink to this headline"></a></h2>
<p>Vppinfra serialization support allows the programmer to easily serialize
and unserialize complex data structures.</p>
<p>The underlying primitive serialize/unserialize functions use network
byte-order, so there are no structural issues serializing on a
little-endian host and unserializing on a big-endian host.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="softwarearchitecture.html" class="btn btn-neutral float-left" title="Software Architecture" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="vlib.html" class="btn btn-neutral float-right" title="VLIB (Vector Processing Library)" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2018-2021, Linux Foundation.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>