

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Creating the Virtual Machine &mdash; Vector Packet Processor 01 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/rules.css" type="text/css" />
    <link rel="author" title="About these documents" href="../../about.html" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Bridge the Interfaces" href="vhost03.html" />
    <link rel="prev" title="Prerequisites" href="vhost.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> Vector Packet Processor
          

          
            
            <img src="../../_static/fd-io_red_white.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                master
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../overview/index.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../gettingstarted/index.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../links/index.html">VPP Wiki, Doxygen and Other Links</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Use Cases</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../containers.html">VPP with Containers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../simpleperf/index.html">VPP with Iperf3 and TRex</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">FD.io VPP with Virtual Machines</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="vhost.html">Prerequisites</a></li>
<li class="toctree-l3"><a class="reference internal" href="vhost.html#topology">Topology</a></li>
<li class="toctree-l3"><a class="reference internal" href="vhost.html#creating-the-virtual-interface">Creating The Virtual Interface</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Creating the Virtual Machine</a></li>
<li class="toctree-l3"><a class="reference internal" href="vhost03.html">Bridge the Interfaces</a></li>
<li class="toctree-l3"><a class="reference internal" href="vhost03.html#bring-the-interfaces-up">Bring the Interfaces Up</a></li>
<li class="toctree-l3"><a class="reference internal" href="vhost03.html#ping-from-the-vm">Ping from the VM</a></li>
<li class="toctree-l3"><a class="reference internal" href="vhost04.html">Cleanup</a></li>
<li class="toctree-l3"><a class="reference internal" href="vhost05.html">Limitations</a></li>
<li class="toctree-l3"><a class="reference internal" href="xmlexample.html">The XML File</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../vmxnet3.html">VPP with VMware/Vmxnet3</a></li>
<li class="toctree-l2"><a class="reference internal" href="../acls.html">Access Control Lists (ACLs) with FD.io VPP</a></li>
<li class="toctree-l2"><a class="reference internal" href="../vppcloud.html">VPP inside the Cloud</a></li>
<li class="toctree-l2"><a class="reference internal" href="../homegateway.html">Using VPP as a Home Gateway</a></li>
<li class="toctree-l2"><a class="reference internal" href="../contiv/index.html">Contiv/VPP</a></li>
<li class="toctree-l2"><a class="reference internal" href="../networksim.html">Network Simulator Plugin</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../featuresbyrelease/index.html">Features by Release</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../troubleshooting/index.html">Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../events/index.html">Events</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../reference/index.html">Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../relatedprojects/index.html">Related Projects</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../archive/index.html">Archive</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../about.html">About</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Vector Packet Processor</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Use Cases</a> &raquo;</li>
        
          <li><a href="index.html">FD.io VPP with Virtual Machines</a> &raquo;</li>
        
      <li>Creating the Virtual Machine</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/usecases/vhost/vhost02.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="creating-the-virtual-machine">
<span id="vhost02"></span><h1>Creating the Virtual Machine<a class="headerlink" href="#creating-the-virtual-machine" title="Permalink to this headline">¶</a></h1>
<p>We will now create the virtual machine. We use the “virsh create command”. For the complete file we
use refer to <a class="reference internal" href="../../gettingstarted/writingdocs/styleguide/xmlexample.html#xmlexample"><span class="std std-ref">An XML File</span></a>.</p>
<p>It is important to note that in the XML file we specify the socket path that is used to connect to
FD.io VPP.</p>
<p>This is done with a section that looks like this</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">&lt;interface type=&#39;vhostuser&#39;&gt;</span>
<span class="go">  &lt;mac address=&#39;52:54:00:4c:47:f2&#39;/&gt;</span>
<span class="go">  &lt;source type=&#39;unix&#39; path=&#39;/tmp//vm00.sock&#39; mode=&#39;server&#39;/&gt;</span>
<span class="go">  &lt;driver rx_queue_size=&#39;1024&#39; tx_queue_size=&#39;1024&#39;/&gt;</span>
<span class="go">  &lt;model type=&#39;virtio&#39;/&gt;</span>
<span class="go">  &lt;alias name=&#39;net1&#39;/&gt;</span>
<span class="go">  &lt;address type=&#39;pci&#39; domain=&#39;0x0000&#39; bus=&#39;0x00&#39; slot=&#39;0x02&#39; function=&#39;0x0&#39;/&gt;</span>
<span class="go">&lt;/interface&gt;</span>
</pre></div>
</div>
<p>Notice the <strong>interface type</strong> and the <strong>path</strong> to the socket.</p>
<p>Now we create the VM. The virsh list command shows the VMs that have been created. We start with no VMs.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> virsh list
<span class="go">Id    Name                           State</span>
<span class="go">----------------------------------------------------</span>
</pre></div>
</div>
<p>Create the VM with the virsh create command specifying our xml file.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> virsh create ./iperf3-vm.xml
<span class="go">Domain iperf-server3 created from ./iperf3-vm.xml</span>

<span class="gp">$</span> virsh list
<span class="go">Id    Name                           State</span>
<span class="go">----------------------------------------------------</span>
<span class="go">65    iperf-server3                  running</span>
</pre></div>
</div>
<p>The VM is now created.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>After a VM is created an xml file can created with “virsh dumpxml”.</p>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> virsh dumpxml iperf-server3
<span class="go">&lt;domain type=&#39;kvm&#39; id=&#39;65&#39;&gt;</span>
<span class="go">  &lt;name&gt;iperf-server3&lt;/name&gt;</span>
<span class="go">  &lt;uuid&gt;e23d37c1-10c3-4a6e-ae99-f315a4165641&lt;/uuid&gt;</span>
<span class="go">  &lt;memory unit=&#39;KiB&#39;&gt;262144&lt;/memory&gt;</span>
<span class="go">.....</span>
</pre></div>
</div>
<p>Once the virtual machine is created notice the socket filename shows <strong>Success</strong> and
there are <strong>Memory Regions</strong>. At this point the VM and FD.io VPP are connected. Also
notice <strong>qsz 1024</strong>. A queue size of 256 will affect vhost throughput. The qsz should
be 1024. In QEMU 2.10.0 and libvirt 3.7.0 and later versions this is specified in the
xml file with the line <strong>&lt;driver rx_queue_size=‘1024’ tx_queue_size=‘1024’/&gt;</strong> shown above
and in the example.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">vpp# show vhost</span>
<span class="go">Virtio vhost-user interfaces</span>
<span class="go">Global:</span>
<span class="go">  coalesce frames 32 time 1e-3</span>
<span class="go">  number of rx virtqueues in interrupt mode: 0</span>
<span class="go">Interface: VirtualEthernet0/0/0 (ifindex 3)</span>
<span class="go">virtio_net_hdr_sz 12</span>
<span class="go"> features mask (0xffffffffffffffff):</span>
<span class="go"> features (0x58208000):</span>
<span class="go">   VIRTIO_NET_F_MRG_RXBUF (15)</span>
<span class="go">   VIRTIO_NET_F_GUEST_ANNOUNCE (21)</span>
<span class="go">   VIRTIO_F_ANY_LAYOUT (27)</span>
<span class="go">   VIRTIO_F_INDIRECT_DESC (28)</span>
<span class="go">   VHOST_USER_F_PROTOCOL_FEATURES (30)</span>
<span class="go">  protocol features (0x3)</span>
<span class="go">   VHOST_USER_PROTOCOL_F_MQ (0)</span>
<span class="go">   VHOST_USER_PROTOCOL_F_LOG_SHMFD (1)</span>

<span class="go"> socket filename /tmp/vm00.sock type client errno &quot;Success&quot;</span>

<span class="go"> rx placement:</span>
<span class="go">   thread 1 on vring 1, polling</span>
<span class="go"> tx placement: spin-lock</span>
<span class="go">   thread 0 on vring 0</span>
<span class="go">   thread 1 on vring 0</span>

<span class="go"> Memory regions (total 2)</span>
<span class="go"> region fd    guest_phys_addr    memory_size        userspace_addr     mmap_offset        mmap_addr</span>
<span class="go"> ====== ===== ================== ================== ================== ================== ===============    ===</span>
<span class="go">  0     31    0x0000000000000000 0x00000000000a0000 0x00007f1db9c00000 0x0000000000000000 0x00007f7db0400    000</span>
<span class="go">  1     32    0x00000000000c0000 0x000000000ff40000 0x00007f1db9cc0000 0x00000000000c0000 0x00007f7d94ec0    000</span>

<span class="go"> Virtqueue 0 (TX)</span>
<span class="go">  qsz 1024 last_avail_idx 0 last_used_idx 0</span>
<span class="go">  avail.flags 0 avail.idx 256 used.flags 1 used.idx 0</span>
<span class="go">  kickfd 33 callfd 34 errfd -1</span>

<span class="go"> Virtqueue 1 (RX)</span>
<span class="go">  qsz 1024 last_avail_idx 8 last_used_idx 8</span>
<span class="go">  avail.flags 0 avail.idx 8 used.flags 1 used.idx 8</span>
<span class="go">  kickfd 29 callfd 35 errfd -1</span>
</pre></div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="vhost03.html" class="btn btn-neutral float-right" title="Bridge the Interfaces" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="vhost.html" class="btn btn-neutral float-left" title="Prerequisites" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, Linux Foundation

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>