

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>The Data Plane &mdash; The Vector Packet Processor 20.05 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/css/rules.css" type="text/css" />
    <link rel="author" title="About these documents" href="../../../about.html" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="Tunnels" href="tunnels.html" />
    <link rel="prev" title="Graph Walks" href="graphwalks.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> The Vector Packet Processor
          

          
            
            <img src="../../../_static/fd-io_red_white.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                20.05
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../whatisvpp/index.html">The Vector Packet Processor (VPP)</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../index.html">Getting Started</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../installing/index.html">Downloading and Installing VPP</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../progressivevpp/index.html">Progressive VPP Tutorial</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../users/index.html">For Users</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../index.html">For Developers</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../building.html">Building VPP</a></li>
<li class="toctree-l3"><a class="reference internal" href="../running_vpp.html">Running VPP</a></li>
<li class="toctree-l3"><a class="reference internal" href="../gdb_examples.html">GDB Examples</a></li>
<li class="toctree-l3"><a class="reference internal" href="../add_plugin.html">Adding a plugin</a></li>
<li class="toctree-l3"><a class="reference internal" href="../gitreview.html">Getting a Patch Reviewed</a></li>
<li class="toctree-l3"><a class="reference internal" href="../softwarearchitecture.html">Software Architecture</a></li>
<li class="toctree-l3"><a class="reference internal" href="../infrastructure.html">VPPINFRA (Infrastructure)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../vlib.html">VLIB (Vector Processing Library)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../plugins.html">Plugins</a></li>
<li class="toctree-l3"><a class="reference internal" href="../vnet.html">VNET (VPP Network Stack)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../featurearcs.html">Feature Arcs</a></li>
<li class="toctree-l3"><a class="reference internal" href="../metadata.html">Buffer Metadata</a></li>
<li class="toctree-l3"><a class="reference internal" href="../metadata.html#buffer-metadata-extensions">Buffer Metadata Extensions</a></li>
<li class="toctree-l3"><a class="reference internal" href="../multiarch/index.html">Multi-architecture support</a></li>
<li class="toctree-l3"><a class="reference internal" href="../bihash.html">Bounded-index Extensible Hashing (bihash)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../vpp_api_module.html">VPP API module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../binary_api_support.html">Binary API Support</a></li>
<li class="toctree-l3"><a class="reference internal" href="../buildsystem/index.html">Build System</a></li>
<li class="toctree-l3"><a class="reference internal" href="../eventviewer.html">Event-logger</a></li>
<li class="toctree-l3"><a class="reference internal" href="../eventviewer.html#g2-graphical-event-viewer">G2 graphical event viewer</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="index.html">FIB 2.0 Hierarchical, Protocol, Independent</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="prerequisites.html">Prerequisites</a></li>
<li class="toctree-l4 current"><a class="reference internal" href="thedatamodel.html">The Data Model</a></li>
<li class="toctree-l4"><a class="reference internal" href="tunnels.html">Tunnels</a></li>
<li class="toctree-l4"><a class="reference internal" href="mplsfib.html">MPLS FIB</a></li>
<li class="toctree-l4"><a class="reference internal" href="multicast.html">IP Multicast FIB</a></li>
<li class="toctree-l4"><a class="reference internal" href="fastconvergence.html">Fast Convergence</a></li>
<li class="toctree-l4"><a class="reference internal" href="scale.html">Scale</a></li>
<li class="toctree-l4"><a class="reference internal" href="scale.html#ip4-heap">IP4 Heap</a></li>
<li class="toctree-l4"><a class="reference internal" href="scale.html#ip6-heap">IP6 Heap</a></li>
<li class="toctree-l4"><a class="reference internal" href="scale.html#main-heap">Main Heap</a></li>
<li class="toctree-l4"><a class="reference internal" href="scale.html#stats-heap">Stats Heap</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../buildwireshark.html">How to build a vpp dispatch trace aware Wireshark</a></li>
<li class="toctree-l3"><a class="reference internal" href="../punt.html">Punting Packets</a></li>
<li class="toctree-l3"><a class="reference internal" href="../quic_plugin.html">QUIC HostStack</a></li>
<li class="toctree-l3"><a class="reference internal" href="../cross_compile_macos.html">Cross compilation on MacOS</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../writingdocs/index.html">Writing Documents</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../links/index.html">VPP Wiki, Doxygen and Other Links</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../usecases/index.html">Use Cases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../featuresbyrelease/index.html">Features by Release</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../troubleshooting/index.html">Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../events/index.html">Events</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../reference/index.html">Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../relatedprojects/index.html">Related Projects</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../archive/index.html">Archive</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../about.html">About</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">The Vector Packet Processor</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Getting Started</a> &raquo;</li>
        
          <li><a href="../index.html">For Developers</a> &raquo;</li>
        
          <li><a href="index.html">FIB 2.0 Hierarchical, Protocol, Independent</a> &raquo;</li>
        
          <li><a href="thedatamodel.html">The Data Model</a> &raquo;</li>
        
      <li>The Data Plane</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../../_sources/gettingstarted/developers/fib20/dataplane.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="the-data-plane">
<span id="dataplane"></span><h1>The Data Plane<a class="headerlink" href="#the-data-plane" title="Permalink to this headline">¶</a></h1>
<p>The data-plane data model is a directed, acyclic <a class="footnote-reference brackets" href="#f16" id="id1">1</a> graph of heterogeneous objects.
A packet will forward walk the graph as it is switched. Each object describes
the actions to perform on the packet. Each object type has an associated VLIB
graph node. For a packet to forward walk the graph is therefore to move from one
VLIB node to the next, with each performing the required actions. This is the
heart of the VPP model.</p>
<p>The data-plane graph is composed of generic data-path objects (DPOs). A parent
DPO is identified by the tuple:{type,index,next_node}. The <em>next_node</em> parameter
is the index of the VLIB node to which the packets should be sent next, this is
present to maximise performance - it is important to ensure that the parent does
not need to be read <a class="footnote-reference brackets" href="#f17" id="id2">2</a> whilst processing the child. Specialisations <a class="footnote-reference brackets" href="#f18" id="id3">3</a> of the DPO
perform distinct actions. The most common DPOs and briefly what they represent are:</p>
<ul class="simple">
<li><p>Load-balance: a choice in an ECMP set.</p></li>
<li><p>Adjacency:  apply a rewrite and forward through an interface</p></li>
<li><p>MPLS-label: impose an MPLS label.</p></li>
<li><p>Lookup: perform another lookup in a different table.</p></li>
</ul>
<p>The data-plane graph is derived from the control-plane graph by the objects
therein ‘contributing’ a DPO to the data-plane graph. Objects in the data-plane
contain only the information needed to switch a packet, they are therefore
simpler, and in memory terms smaller, with the aim to fit one DPO on a single
cache-line. The derivation from the control plane means that the data-plane
graph contains only object whose current state can forward packets. For example,
the difference between a <em>fib_path_list_t</em> and a <em>load_balance_t</em> is that the former
expresses the control-plane’s desired state, the latter the data-plane available
state. If some paths in the path-list are unresolved or down, then the
load-balance will not include them in the forwarding choice.</p>
<div class="figure align-default">
<img alt="../../../_images/fib20fig8.png" src="../../../_images/fib20fig8.png" />
</div>
<p>Figure 8: DPO contributions for a non-recursive route</p>
<p>Figure 8 shows a simplified view of the control-plane graph indicating those
objects that contribute DPOs. Also shown are the VLIB node graphs at which the DPO is used.</p>
<p>Each <em>fib_entry_t</em> contributes it own <em>load_balance_t</em>, for three reasons;</p>
<ul class="simple">
<li><p>The result of a lookup in a IPv[46] table is a single 32 bit unsigned integer. This is an index into a memory pool. Consequently the object type must be the same for each result. Some routes will need a load-balance and some will not, but to insert another object in the graph to represent this choice is a waste of cycles, so the load-balance object is always the result. If the route does not have ECMP, then the load-balance has only one choice.</p></li>
<li><p>In order to collect per-route counters, the lookup result must in some way uniquely identify the <em>fib_entry_t</em>. A shared load-balance (contributed by the path-list) would not allow this.</p></li>
<li><p>In the case the <em>fib_entry_t</em> has MPLS out labels, and hence a <em>fib_path_ext_t</em>, then the load-balance must be per-prefix, since the MPLS labels that are its parents are themselves per-fib_entry_t.</p></li>
</ul>
<div class="figure align-default">
<img alt="../../../_images/fib20fig9.png" src="../../../_images/fib20fig9.png" />
</div>
<p>Figure 9: DPO contribution for a recursive route.</p>
<p>Figure 9 shows the load-balance objects contributed for a recursive route.</p>
<div class="figure align-default">
<img alt="../../../_images/fib20fig10.png" src="../../../_images/fib20fig10.png" />
</div>
<p>Figure 10: DPO Contributions from labelled recursive routes.</p>
<p>Figure 10 shows the derived data-plane graph for a labelled recursive route.
There can be as many MPLS-label DPO instances as there are routes multiplied by
the number of paths per-route. For this reason the mpls-label DPO should be as
small as possible <a class="footnote-reference brackets" href="#f19" id="id4">4</a>.</p>
<p>The data-plane graph is constructed by ‘stacking’ one
instance of a DPO on another to form the child-parent relationship. When this
stacking occurs, the necessary VLIB graph arcs are automatically constructed
from the respected DPO type’s registered graph nodes.</p>
<p>The diagrams above show that for any given route the full data-plane graph is
known before any packet arrives. If that graph is composed of n objects, then the
packet will visit n nodes and thus incur a forwarding cost of approximately n
times the graph node cost. This could be reduced if the graph were <em>collapsed</em>
into a single DPO and associated node. However, collapsing a graph removes the
indirection objects that provide fast convergence (see section Fast Convergence). To
collapse is then a trade-off between faster forwarding and fast convergence; VPP
favours the latter.</p>
<p>This DPO model effectively exists today but is informally defined. Presently the
only object that is in the data-plane is the ip_adjacency_t, however, features
(like ILA, OAM hop-by-hop, SR, MAP, etc) sub-type the adjacency. The member
lookup_next_index is equivalent to defining a new sub-type. Adding to the
existing union, or casting sub-type specific data into the opaque member, or
even over the rewrite string (e.g. the new port range checker), is equivalent
defining a new C-struct type. Fortunately, at this time, all these sub-types are
smaller in memory than the ip_adjacency_t. It is now possible to dynamically
register new adjacency sub-types with ip_register_adjacency() and provide a
custom format function.</p>
<p>In my opinion a strongly defined object model will be easier for contributors to
understand, and more robust to implement.</p>
<p class="rubric">Footnotes:</p>
<dl class="footnote brackets">
<dt class="label" id="f16"><span class="brackets"><a class="fn-backref" href="#id1">1</a></span></dt>
<dd><p>Directed implies it cannot be back-walked. It is acyclic even in the presence of a recursion loop.</p>
</dd>
<dt class="label" id="f17"><span class="brackets"><a class="fn-backref" href="#id2">2</a></span></dt>
<dd><p>Loaded into cache, and hence potentially incurring a d-cache miss.</p>
</dd>
<dt class="label" id="f18"><span class="brackets"><a class="fn-backref" href="#id3">3</a></span></dt>
<dd><p>The engaged reader is directed to vnet/vnet/dpo/*</p>
</dd>
<dt class="label" id="f19"><span class="brackets"><a class="fn-backref" href="#id4">4</a></span></dt>
<dd><p>i.e. we should not re-use the adjacency structure.</p>
</dd>
</dl>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="tunnels.html" class="btn btn-neutral float-right" title="Tunnels" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="graphwalks.html" class="btn btn-neutral float-left" title="Graph Walks" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018-2020, Linux Foundation

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>